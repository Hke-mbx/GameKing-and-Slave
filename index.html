<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>王与奴 - 中世纪卡牌对战</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cinzel', serif;
            background: 
                radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 69, 19, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 25%, #2c1810 50%, #1a1a1a 75%, #0a0a0a 100%);
            color: #f4e4bc;
            min-height: 100%;
            position: relative;
            box-sizing: border-box;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="0.5" fill="%23d4af37" opacity="0.1"/><circle cx="75" cy="75" r="0.3" fill="%23d4af37" opacity="0.05"/><circle cx="50" cy="10" r="0.2" fill="%23f4e4bc" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            pointer-events: none;
            z-index: -1;
        }

        .game-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.6);
            }
        }

        @keyframes cardFlip {
            0% {
                transform: rotateY(0deg);
            }
            50% {
                transform: rotateY(90deg);
            }
            100% {
                transform: rotateY(0deg);
            }
        }

        @keyframes battlePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(212, 175, 55, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 40px rgba(212, 175, 55, 0.8);
            }
        }

        @keyframes particleFloat {
            0%, 100% {
                transform: translateY(0px) rotate(0deg);
                opacity: 0.3;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.8;
            }
        }

        @keyframes revolutionFlash {
            0% {
                opacity: 0;
                background: radial-gradient(circle at center, rgba(255,69,0,0) 0%, transparent 70%);
            }
            20% {
                opacity: 1;
                background: radial-gradient(circle at center, rgba(255,69,0,0.5) 0%, transparent 70%);
            }
            100% {
                opacity: 0;
                background: radial-gradient(circle at center, rgba(255,69,0,0) 0%, transparent 70%);
            }
        }

        @keyframes chainBreak {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.5) rotate(360deg) translateY(-100px);
                opacity: 0;
            }
        }

        @keyframes freedomRise {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 0.8;
            }
        }

        @keyframes sloganAppear {
            0% {
                transform: translateX(-50%) translateY(50px);
                opacity: 0;
            }
            50% {
                transform: translateX(-50%) translateY(0px);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
        }

        @keyframes rankPromotionAppear {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
            30% {
                transform: translate(-50%, -50%) scale(0.95);
            }
            40% {
                transform: translate(-50%, -50%) scale(1.05);
            }
            50% {
                transform: translate(-50%, -50%) scale(1);
            }
            90% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes revolutionShake {
            0%, 100% {
                transform: translateX(0);
            }
            10%, 30%, 50%, 70%, 90% {
                transform: translateX(-10px);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(10px);
            }
        }

        .game-header {
            text-align: center;
            margin-bottom: 40px;
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.8), rgba(44,24,16,0.6)),
                radial-gradient(circle at center, rgba(212,175,55,0.1) 0%, transparent 70%);
            padding: 40px 20px;
            border-radius: 25px;
            border: 3px solid transparent;
            background-clip: padding-box;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 1s ease-out;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #d4af37, #f4e4bc, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            animation: glow 3s ease-in-out infinite;
        }

        .game-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #d4af37 0%, #f4e4bc 50%, #d4af37 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            margin: 0;
            letter-spacing: 3px;
            position: relative;
        }

        .game-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
            border-radius: 2px;
        }

        .game-subtitle {
            font-size: 1.4rem;
            font-family: 'Crimson Text', serif;
            font-style: italic;
            margin: 20px 0 10px;
            opacity: 0.9;
            color: #f4e4bc;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .game-description {
            font-size: 1rem;
            font-family: 'Crimson Text', serif;
            opacity: 0.8;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .setup-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            padding: 50px 30px;
            border-radius: 25px;
            border: 2px solid transparent;
            background-clip: padding-box;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .setup-screen::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            opacity: 0.8;
        }

        .setup-screen h2 {
            font-size: 2.2rem;
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .faction-selection {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .faction-card {
            background: 
                linear-gradient(145deg, rgba(58,40,23,0.95), rgba(44,24,16,0.95)),
                radial-gradient(circle at 50% 20%, rgba(212,175,55,0.1) 0%, transparent 60%);
            border: 3px solid transparent;
            background-clip: padding-box;
            border-radius: 20px;
            padding: 35px 25px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-width: 280px;
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            transform-style: preserve-3d;
        }

        .faction-card::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 20px;
            z-index: -1;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .faction-card::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.3), transparent);
            border-radius: 1px;
        }

        .faction-card:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: 
                0 20px 40px rgba(212, 175, 55, 0.4),
                0 0 30px rgba(212, 175, 55, 0.2);
        }

        .faction-card:hover::before {
            opacity: 1;
            animation: glow 2s ease-in-out infinite;
        }

        .faction-card.selected {
            transform: translateY(-5px) rotateX(2deg);
            background: 
                linear-gradient(145deg, rgba(74,56,39,0.95), rgba(60,40,32,0.95)),
                radial-gradient(circle at 50% 20%, rgba(212,175,55,0.2) 0%, transparent 60%);
            box-shadow: 
                0 15px 30px rgba(212, 175, 55, 0.6),
                0 0 40px rgba(212, 175, 55, 0.3),
                inset 0 1px 0 rgba(212, 175, 55, 0.2);
            color: #f4e4bc;
        }
        
        .faction-card.selected .faction-name {
            color: #d4af37;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .faction-card.selected p {
            color: #1a0f08;
            text-shadow: 1px 1px 2px rgba(255,255,255,0.5);
            font-weight: 700;
        }

        .faction-card.selected::before {
            opacity: 1;
            animation: glow 1.5s ease-in-out infinite;
        }

        .faction-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .faction-name {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .opening-selection {
            margin-top: 20px;
            display: none;
        }

        .opening-card {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .opening-card:hover {
            border-color: #d4af37;
        }

        .opening-card.selected {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .game-board {
            display: none;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            min-height: 85vh;
            padding: 20px;
        }

        /* 统一滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(145deg, #e6c547, #d4af37);
        }

        /* 手牌区域滚动条样式 */
        .hand-cards::-webkit-scrollbar {
            height: 6px;
        }

        .hand-cards::-webkit-scrollbar-track {
            background: rgba(212,175,55,0.1);
            border-radius: 3px;
            margin: 0 10px;
        }

        .hand-cards::-webkit-scrollbar-thumb {
            background: rgba(212,175,55,0.5);
            border-radius: 3px;
        }

        .hand-cards::-webkit-scrollbar-thumb:hover {
            background: rgba(212,175,55,0.7);
        }

        .opponent-area, .player-area {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #8b4513;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        .battle-area {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.8)),
                radial-gradient(circle at center, rgba(212,175,55,0.1) 0%, transparent 70%);
            border-radius: 25px;
            padding: 20px;
            border: 3px solid transparent;
            background-clip: padding-box;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 280px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .battle-area::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #d4af37, #f4e4bc, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            animation: glow 4s ease-in-out infinite;
        }

        .battle-area::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(212,175,55,0.1) 0%, transparent 30%),
                radial-gradient(circle at 80% 80%, rgba(212,175,55,0.1) 0%, transparent 30%);
            pointer-events: none;
        }

        .card {
            width: 140px;
            height: 210px;
            background: 
                linear-gradient(145deg, rgba(58,40,23,0.95), rgba(44,24,16,0.95)),
                radial-gradient(circle at 30% 30%, rgba(212,175,55,0.1) 0%, transparent 70%);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 15px;
            padding: 18px 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            text-align: center;
            margin: 0;
            overflow: hidden;
            backdrop-filter: blur(3px);
            transform-style: preserve-3d;
            flex-shrink: 0;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 15px;
            z-index: -1;
            opacity: 0.4;
            transition: all 0.3s ease;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.4), transparent);
            border-radius: 0.5px;
        }

        .card:hover {
            transform: translateY(-15px) rotateX(10deg) rotateY(5deg);
            box-shadow: 
                0 25px 50px rgba(212, 175, 55, 0.4),
                0 0 30px rgba(212, 175, 55, 0.2),
                inset 0 1px 0 rgba(212, 175, 55, 0.1);
        }

        .card:hover::before {
            opacity: 0.8;
            animation: glow 2s ease-in-out infinite;
        }

        .card.selected {
            transform: translateY(-10px) rotateX(5deg);
            background: 
                linear-gradient(145deg, rgba(74,56,39,0.95), rgba(60,40,32,0.95)),
                radial-gradient(circle at 30% 30%, rgba(212,175,55,0.2) 0%, transparent 70%);
            box-shadow: 
                0 20px 40px rgba(212, 175, 55, 0.6),
                0 0 40px rgba(212, 175, 55, 0.3),
                inset 0 2px 0 rgba(212, 175, 55, 0.2);
        }

        .card.selected::before {
            opacity: 1;
            animation: battlePulse 1.5s ease-in-out infinite;
        }

        .card-back {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border-color: #666;
        }

        .card-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .card-name {
            font-size: 1rem;
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 6px;
        }

        .card-level {
            position: absolute;
            top: 6px;
            right: 10px;
            background: #d4af37;
            color: #2c1810;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
        }

        .card-description {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .hand-cards {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: nowrap;
            margin-top: 15px;
            padding: 10px 15px;
            min-height: 120px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            border: 1px solid rgba(212,175,55,0.3);
            overflow-x: auto;
            overflow-y: visible;
        }



        .battle-cards {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
            min-height: 240px;
            width: 100%;
        }

        .vs-text {
            font-size: 3rem;
            color: #d4af37;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin: 0 25px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .faction-badge {
            background: #d4af37;
            color: #1a0f08;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .btn {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            border: 2px solid transparent;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 15px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                0 8px 16px rgba(212, 175, 55, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover {
            background: linear-gradient(145deg, #e6c547, #d4af37);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 15px 30px rgba(212, 175, 55, 0.5),
                0 0 20px rgba(212, 175, 55, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(212, 175, 55, 0.5);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 
                0 8px 16px rgba(212, 175, 55, 0.4),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            background: linear-gradient(145deg, #666, #555);
            color: #999;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border-color: transparent;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn-secondary {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            color: #f4e4bc;
            border: 2px solid transparent;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                0 6px 12px rgba(107, 114, 128, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #9ca3af, #6b7280);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 24px rgba(107, 114, 128, 0.4),
                0 0 15px rgba(107, 114, 128, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
            border: 2px solid transparent;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin: 10px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 
                0 6px 12px rgba(239, 68, 68, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .btn-danger:hover {
            background: linear-gradient(145deg, #f87171, #ef4444);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 24px rgba(239, 68, 68, 0.4),
                0 0 15px rgba(239, 68, 68, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .game-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .opening-info {
            background: rgba(212,175,55,0.1);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.9rem;
            color: #d4af37;
            font-weight: 600;
        }

        .game-log {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.8), rgba(44,24,16,0.6)),
                radial-gradient(circle at 10% 90%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            height: 120px;
            overflow-y: auto;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            backdrop-filter: blur(5px);
            flex: 1;
        }

        .game-log::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 15px;
            z-index: -1;
            opacity: 0.6;
        }



        .log-entry {
            margin: 8px 0;
            padding: 8px 12px;
            border-left: 3px solid #d4af37;
            padding-left: 15px;
            font-size: 0.95rem;
            font-family: 'Crimson Text', serif;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 0 8px 8px 0;
            transition: all 0.3s ease;
            animation: fadeInUp 0.5s ease-out;
        }

        .log-entry:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateX(5px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            margin: 20px;
        }

        .modal-title {
            font-size: 2rem;
            color: #d4af37;
            margin-bottom: 20px;
        }

        .turn-indicator {
            text-align: center;
            padding: 15px 20px;
            background: rgba(212, 175, 55, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1.4;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(212, 175, 55, 0.3);
            word-wrap: break-word;
            white-space: normal;
        }

        /* 游戏介绍界面样式 */
        .intro-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 50px 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
            max-width: 800px;
            margin: 0 auto;
        }

        .intro-screen::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            opacity: 0.8;
        }

        .intro-container h2 {
            font-size: 2.5rem;
            color: #d4af37;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .intro-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 15px;
            font-family: 'Crimson Text', serif;
            font-style: italic;
            color: #f4e4bc;
        }

        .intro-description {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 30px;
            line-height: 1.6;
            color: #f4e4bc;
        }

        .story-section {
            background: rgba(212,175,55,0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid rgba(212,175,55,0.3);
        }

        .story-section h3 {
            color: #d4af37;
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-family: 'Cinzel', serif;
        }

        .story-section p {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #f4e4bc;
            font-family: 'Crimson Text', serif;
            font-style: italic;
        }

        .worldview-section {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 1px solid rgba(212,175,55,0.2);
        }

        .worldview-section h3 {
            color: #d4af37;
            font-size: 1.4rem;
            margin-bottom: 20px;
            font-family: 'Cinzel', serif;
        }

        .worldview-content p {
            font-size: 1.1rem;
            line-height: 1.8;
            margin: 8px 0;
            color: #f4e4bc;
            font-family: 'Crimson Text', serif;
        }

        .intro-actions {
            margin-top: 40px;
        }

        /* 登录界面样式 */
        .login-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 50px 30px;
            border: 2px solid transparent;
            background-clip: padding-box;
            text-align: center;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
            max-width: 600px;
            margin: 0 auto;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            opacity: 0.8;
        }

        .login-container h2 {
            font-size: 2.5rem;
            color: #d4af37;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .login-subtitle {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 40px;
            font-family: 'Crimson Text', serif;
            font-style: italic;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .avatar-selection h3, .difficulty-selection h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }

        .avatar-option {
            width: 50px;
            height: 50px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.2);
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #d4af37;
            background: rgba(212,175,55,0.3);
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }

        .username-input-group {
            text-align: left;
            max-width: 300px;
            margin: 0 auto;
        }

        .username-input-group label {
            display: block;
            color: #d4af37;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .username-input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #8b4513;
            border-radius: 8px;
            color: #f4e4bc;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
        }

        .username-input-group input:focus {
            border-color: #d4af37;
            outline: none;
            box-shadow: 0 0 10px rgba(212,175,55,0.3);
        }

        .input-hint {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 5px;
        }

        .avatar-grid-profile {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-width: 300px;
            margin: 0 auto;
        }

        .avatar-option-profile {
            width: 40px;
            height: 40px;
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-option-profile:hover {
            border-color: #d4af37;
            background: rgba(212,175,55,0.2);
            transform: scale(1.1);
        }

        .avatar-option-profile.selected {
            border-color: #d4af37;
            background: rgba(212,175,55,0.3);
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }

        .info-display {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 12px;
            color: #f4e4bc;
            font-family: 'Crimson Text', serif;
            opacity: 0.8;
        }

        .achievement-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 60px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px solid rgba(212,175,55,0.3);
        }

        .achievement-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(212,175,55,0.2);
            border: 1px solid rgba(212,175,55,0.4);
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .achievement-badge:hover {
            background: rgba(212,175,55,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(212,175,55,0.2);
        }

        .achievement-badge.legendary {
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            border-color: #ffd700;
            animation: glow 2s ease-in-out infinite;
        }

        .preference-grid {
            display: grid;
            gap: 15px;
        }

        .preference-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(212,175,55,0.05);
            border-radius: 8px;
            border: 1px solid rgba(212,175,55,0.2);
        }

        .preference-item label {
            font-weight: 600;
            color: #d4af37;
            min-width: 100px;
        }

        .preference-item select {
            min-width: 150px;
        }

        .preference-item select:focus {
            border-color: #d4af37;
            outline: none;
            box-shadow: 0 0 10px rgba(212,175,55,0.3);
        }



        .login-btn {
            margin: 20px auto;
            padding: 15px 40px;
            font-size: 1.2rem;
        }

        .login-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(212,175,55,0.3);
        }

        .login-footer p {
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .rewards-preview {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .rewards-preview span {
            background: rgba(212,175,55,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid rgba(212,175,55,0.3);
        }

        /* 用户状态栏样式 */
        .user-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.4);
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #2c1810;
        }

        .username {
            font-size: 1.2rem;
            font-weight: 600;
            color: #d4af37;
        }

        .user-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .header-buttons {
            display: flex;
            gap: 0;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        /* 历史战绩样式 */
        .history-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 40px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .history-screen::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            opacity: 0.6;
        }

        .history-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .history-container h2 {
            text-align: center;
            font-size: 2.2rem;
            color: #d4af37;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: 
                linear-gradient(145deg, rgba(58,40,23,0.95), rgba(44,24,16,0.95)),
                radial-gradient(circle at 50% 20%, rgba(212,175,55,0.1) 0%, transparent 60%);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 15px;
            z-index: -1;
            opacity: 0.4;
        }

        .summary-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .summary-number {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 1rem;
            opacity: 0.8;
        }

        .history-filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            color: #f4e4bc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
        }

        .filter-btn.active, .filter-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            color: #d4af37;
        }

        .battle-history {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 15px;
            background: rgba(0,0,0,0.2);
            padding: 20px;
        }



        .battle-record {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            margin: 15px 0;
            background: 
                linear-gradient(145deg, rgba(58,40,23,0.8), rgba(44,24,16,0.8)),
                radial-gradient(circle at 10% 90%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border: 1px solid transparent;
            background-clip: padding-box;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .battle-record::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 12px;
            z-index: -1;
            opacity: 0.3;
        }

        .battle-record:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
        }

        .battle-record:hover::before {
            opacity: 0.6;
        }

        .battle-record.victory {
            border-left: 4px solid #10b981;
        }

        .battle-record.defeat {
            border-left: 4px solid #ef4444;
        }

        .record-result {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .result-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-icon.victory {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
        }

        .result-icon.defeat {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
        }

        .record-info {
            flex: 1;
        }

        .record-opponent {
            font-size: 1.1rem;
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .record-details {
            font-size: 0.9rem;
            opacity: 0.8;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .record-meta {
            text-align: right;
        }

        .record-date {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .record-duration {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        .faction-badge-small {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .no-records {
            text-align: center;
            padding: 60px 20px;
            opacity: 0.7;
        }

        .no-records-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .achievement-section {
            margin-top: 40px;
            padding: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .achievement-section h3 {
            color: #d4af37;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        .achievement-categories {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-filter {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            color: #f4e4bc;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
        }

        .category-filter.active, .category-filter:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            color: #d4af37;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .achievement-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(212,175,55,0.1), transparent);
            transition: left 0.5s ease;
        }

        .achievement-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: rgba(212, 175, 55, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
        }

        .achievement-item:hover::before {
            left: 100%;
        }

        .achievement-item.unlocked {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
        }

        .achievement-item.unlocked::after {
            content: '✓';
            position: absolute;
            top: 8px;
            right: 12px;
            color: #10b981;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .achievement-item.locked {
            opacity: 0.6;
            filter: grayscale(0.5);
        }

        .achievement-icon {
            font-size: 2.5rem;
            width: 60px;
            text-align: center;
            position: relative;
        }

        .achievement-info {
            flex: 1;
        }

        .achievement-name {
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .achievement-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .achievement-progress {
            font-size: 0.8rem;
            opacity: 0.6;
            margin-top: 5px;
        }

        .achievement-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .achievement-rarity {
            position: absolute;
            top: 5px;
            left: 5px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .rarity-common {
            background: #6b7280;
            color: white;
        }

        .rarity-uncommon {
            background: #10b981;
            color: white;
        }

        .rarity-rare {
            background: #3b82f6;
            color: white;
        }

        .rarity-epic {
            background: #8b5cf6;
            color: white;
        }

        .rarity-legendary {
            background: linear-gradient(45deg, #f59e0b, #ef4444);
            color: white;
            animation: glow 2s ease-in-out infinite;
        }

        .achievement-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .stat-group {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d4af37;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .achievement-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.4);
            z-index: 10001;
            font-family: 'Cinzel', serif;
            font-weight: 600;
            transform: translateX(100%);
            transition: transform 0.5s ease;
            max-width: 300px;
        }

        .achievement-notification.show {
            transform: translateX(0);
        }

        .achievement-notification .notification-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .achievement-notification .notification-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            text-align: center;
        }

        .achievement-notification .notification-desc {
            font-size: 0.9rem;
            opacity: 0.8;
            text-align: center;
        }

        .header-btn {
            background: transparent;
            border: none;
            color: #f4e4bc;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
            border-radius: 8px;
            position: relative;
            font-weight: 500;
        }

        .header-btn:hover {
            background: rgba(212,175,55,0.2);
            color: #d4af37;
            transform: none;
        }

        .header-btn.active {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        /* 好友系统样式 */
        .friends-screen, .profile-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 40px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .achievements-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 40px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .battle-screen {
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.9), rgba(44,24,16,0.7)),
                radial-gradient(circle at 30% 70%, rgba(212,175,55,0.05) 0%, transparent 50%);
            border-radius: 25px;
            padding: 40px;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }





        .friends-screen::before, .battle-screen::before, .profile-screen::before, .achievements-screen::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 25px;
            z-index: -1;
            opacity: 0.6;
        }

        .friends-container, .battle-container, .profile-container, .achievements-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .friends-container h2, .battle-container h2, .profile-container h2, .achievements-container h2 {
            text-align: center;
            font-size: 2.2rem;
            color: #d4af37;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* 标签页样式 */
        .friends-tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab-btn {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            color: #f4e4bc;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Cinzel', serif;
        }

        .tab-btn.active, .tab-btn:hover {
            background: rgba(212, 175, 55, 0.2);
            border-color: #d4af37;
            color: #d4af37;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 好友列表样式 */
        .friends-list {
        }

        .friend-item, .player-item, .request-item, .room-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.3);
            border: 1px solid #8b4513;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .friend-item:hover, .player-item:hover, .request-item:hover, .room-item:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
            transform: translateX(5px);
        }

        .friend-item.online {
            border-left: 4px solid #4ade80;
        }

        .friend-item.offline {
            border-left: 4px solid #6b7280;
            opacity: 0.7;
        }

        .friend-avatar, .player-avatar, .request-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #2c1810;
        }

        .friend-info, .player-info, .request-info, .room-info {
            flex: 1;
            margin-left: 15px;
        }

        .friend-name, .player-name, .request-name, .room-name {
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .friend-status, .player-level, .request-time, .room-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .friend-actions, .request-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            background: linear-gradient(145deg, #d4af37, #b8941f);
            color: #2c1810;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-small:hover {
            background: linear-gradient(145deg, #e6c547, #d4af37);
            transform: translateY(-2px);
        }

        .btn-small:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
            transform: none;
        }

        .challenge-btn {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
        }

        .challenge-btn:hover {
            background: linear-gradient(145deg, #f87171, #ef4444);
        }

        .accept-btn {
            background: linear-gradient(145deg, #10b981, #059669);
            color: white;
        }

        .decline-btn {
            background: linear-gradient(145deg, #6b7280, #4b5563);
            color: white;
        }

        /* 添加好友样式 */
        .add-friend-form {
            text-align: center;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            align-items: center;
        }

        .input-group label {
            min-width: 100px;
            text-align: left;
            color: #d4af37;
            font-weight: 600;
        }

        .friend-input, #roomCode, #usernameInput, #signatureInput {
            flex: 1;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #8b4513;
            border-radius: 8px;
            color: #f4e4bc;
            font-family: 'Crimson Text', serif;
        }

        .friend-input:focus, #roomCode:focus, #usernameInput:focus, #signatureInput:focus {
            border-color: #d4af37;
            outline: none;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .nearby-players h4 {
            color: #d4af37;
            margin: 30px 0 15px;
            text-align: left;
        }

        /* 对战大厅样式 */
        .battle-modes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: 
                linear-gradient(145deg, rgba(58,40,23,0.95), rgba(44,24,16,0.95)),
                radial-gradient(circle at 50% 20%, rgba(212,175,55,0.1) 0%, transparent 60%);
            border: 2px solid transparent;
            background-clip: padding-box;
            border-radius: 15px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #8b4513, #d4af37, #8b4513);
            border-radius: 15px;
            z-index: -1;
            opacity: 0.4;
            transition: opacity 0.3s ease;
        }

        .mode-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(212, 175, 55, 0.4);
        }

        .mode-card:hover::before {
            opacity: 0.8;
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .mode-name {
            font-size: 1.5rem;
            color: #d4af37;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .mode-desc {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .mode-info {
            font-size: 0.9rem;
            color: #d4af37;
            font-weight: 500;
        }

        /* 匹配面板样式 */
        .matchmaking-panel {
            text-align: center;
            padding: 40px;
            background: rgba(0,0,0,0.5);
            border-radius: 15px;
            border: 2px solid #d4af37;
        }

        .matching-spinner {
            font-size: 4rem;
            animation: spin 2s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .matching-text {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .matching-time {
            font-size: 1rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* 自定义房间样式 */
        .custom-room-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid #8b4513;
        }

        .room-options {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .join-room {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .room-list h4 {
            color: #d4af37;
            margin-bottom: 15px;
        }

        /* 个人设置样式 */
        .profile-sections {
            display: grid;
            gap: 30px;
        }

        .profile-section {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #8b4513;
        }

        .profile-section h3 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .profile-info {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .avatar-section {
            text-align: center;
        }

        .large-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(145deg, #d4af37, #b8941f);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #2c1810;
            margin-bottom: 15px;
        }

        .info-section {
            flex: 1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #d4af37;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .settings-list {
            display: grid;
            gap: 15px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(212, 175, 55, 0.05);
            border-radius: 8px;
        }

        .setting-item input[type="range"] {
            width: 150px;
        }

        .setting-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        .profile-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        /* 超小屏幕设备 (小于480px) */
        @media (max-width: 479px) {
            .game-container {
                padding: 10px;
            }
            
            .turn-indicator {
                padding: 12px 15px;
                font-size: 1rem;
                min-height: 45px;
            }
            
            .game-title {
                font-size: 1.8rem;
                letter-spacing: 1px;
            }
            
            .game-subtitle {
                font-size: 1rem;
            }
            
            .game-description {
                font-size: 0.9rem;
            }
            
            .user-status-bar {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .user-stats {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
            
            .header-buttons {
                flex-direction: column;
                gap: 5px;
                width: 100%;
            }
            
            .header-btn {
                width: 100%;
                padding: 10px;
            }
            
            .faction-card {
                min-width: 100%;
                margin: 10px 0;
            }
            
            .battle-area {
                padding: 15px 10px;
                min-height: 280px;
            }
            
            .battle-cards {
                flex-direction: column;
                gap: 15px;
                min-height: 200px;
            }
            
            .vs-text {
                font-size: 1.5rem;
                margin: 5px 0;
            }
            
            .card {
                width: 100px;
                height: 150px;
                padding: 8px;
            }
            
            .card-icon {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .card-name {
                font-size: 0.8rem;
                margin-bottom: 4px;
            }
            
            .card-level {
                width: 20px;
                height: 20px;
                font-size: 0.8rem;
                top: 4px;
                right: 6px;
            }
            
            .card-description {
                font-size: 0.7rem;
            }
            
            .hand-cards {
                gap: 3px;
                padding: 0 5px;
                justify-content: flex-start;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 1rem;
                margin: 10px 5px;
            }
            
            .modal-content {
                margin: 10px;
                padding: 20px;
            }
            
            .modal-title {
                font-size: 1.5rem;
            }
        }

        /* 小屏幕设备 (480px - 767px) */
        @media (min-width: 480px) and (max-width: 767px) {
            .game-title {
                font-size: 2.2rem;
            }
            
            .user-status-bar {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-stats {
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .header-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .faction-selection {
                flex-direction: column;
                align-items: center;
            }
            
            .faction-card {
                min-width: 300px;
            }
            
            .battle-area {
                padding: 20px 15px;
                min-height: 350px;
            }
            
            .battle-cards {
                flex-direction: column;
                gap: 20px;
                min-height: 260px;
            }
            
            .vs-text {
                font-size: 2rem;
                margin: 10px 0;
            }
            
            .card {
                width: 120px;
                height: 180px;
                padding: 12px;
            }
            
            .hand-cards {
                gap: 5px;
            }
        }

        /* 中等屏幕设备 (768px - 1023px) */
        @media (min-width: 768px) and (max-width: 1023px) {
            .game-title {
                font-size: 2.8rem;
            }
            
            .faction-selection {
                gap: 20px;
            }
            
            .faction-card {
                min-width: 250px;
            }
            
            .battle-area {
                padding: 30px 20px;
                min-height: 380px;
            }
            
            .battle-cards {
                gap: 30px;
                min-height: 300px;
            }
            
            .card {
                width: 130px;
                height: 195px;
                padding: 15px;
            }
            
            .hand-cards {
                gap: 8px;
            }
        }

        /* 通用移动设备适配 */
        @media (max-width: 1023px) {
            .friends-tabs {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
            }
            
            .battle-modes {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .mode-card {
                min-width: auto;
            }
            
            .room-options {
                flex-direction: column;
                gap: 15px;
            }
            
            .join-room {
                width: 100%;
            }
            
            .join-room input {
                flex: 1;
            }
            
            .profile-info {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .history-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .history-filters {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .filter-btn, .category-filter {
                flex: 1;
                min-width: 100px;
            }
            
            .battle-record {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .record-result {
                justify-content: center;
            }
            
            .record-meta {
                text-align: center;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .achievement-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .achievement-icon {
                font-size: 3rem;
            }
            
            .friend-item, .player-item, .request-item, .room-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
            
            .friend-actions, .request-actions {
                justify-content: center;
            }
            
            .input-group {
                flex-direction: column;
                gap: 8px;
            }
            
            .input-group label {
                min-width: auto;
                text-align: center;
            }
            
            .setting-item {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .profile-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .achievement-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .stat-group {
                flex: 1;
            }
        }

        /* 大屏幕优化 (1400px+) */
        @media (min-width: 1400px) {
            .game-container {
                max-width: 1800px;
            }
            
            .game-title {
                font-size: 4rem;
            }
            
            .faction-card {
                min-width: 320px;
                padding: 40px 30px;
            }
            
            .battle-area {
                min-height: 450px;
                padding: 50px 40px;
            }
            
            .card {
                width: 160px;
                height: 240px;
                padding: 20px 15px;
            }
            
            .battle-cards .card {
                width: 220px;
                height: 320px;
                padding: 35px 25px;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .history-summary {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* 横屏模式优化 */
        @media (orientation: landscape) and (max-height: 600px) {
            .game-header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .game-title {
                font-size: 2rem;
            }
            
            .game-subtitle {
                font-size: 1rem;
                margin: 10px 0 5px;
            }
            
            .user-status-bar {
                padding: 15px;
            }
            
            .battle-area {
                min-height: 250px;
                padding: 20px;
            }
            
            .battle-cards {
                min-height: 180px;
                gap: 20px;
            }
            
            .card {
                width: 110px;
                height: 160px;
                padding: 10px;
            }
            
            .battle-cards .card {
                width: 150px;
                height: 220px;
                padding: 20px 15px;
            }
            
            .modal-content {
                max-height: 80vh;
                overflow-y: auto;
            }
        }

        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .card:hover {
                transform: none;
                box-shadow: none;
            }
            
            .card:active {
                transform: translateY(-5px) scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .btn:hover {
                transform: none;
            }
            
            .btn:active {
                transform: scale(0.95);
                transition: transform 0.1s ease;
            }
            
            .faction-card:hover {
                transform: none;
                box-shadow: none;
            }
            
            .faction-card:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            /* 增大触摸目标 */
            .header-btn {
                min-height: 44px;
                padding: 12px 20px;
            }
            
            .btn-small {
                min-height: 36px;
                padding: 10px 15px;
            }
            
            .tab-btn, .filter-btn, .category-filter {
                min-height: 40px;
                padding: 12px 20px;
            }
        }

        /* 高分辨率屏幕优化 */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .card::before, .faction-card::before {
                background-size: 100% 100%;
            }
            
            .game-header::before {
                background-size: cover;
            }
        }

        /* 打印样式 */
        @media print {
            .game-container {
                background: white;
                color: black;
            }
            
            .header-buttons, .btn, .modal {
                display: none;
            }
            
            .game-log {
                max-height: none;
                overflow: visible;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">👑 王与奴 ⚔️</h1>
            <p class="game-subtitle">中世纪风格的1v1博弈对战型卡牌游戏</p>
            <p class="game-description">王权与枷锁在同一桌上较量，每一张出牌都是一次博弈</p>
            
            <!-- 用户状态栏 -->
            <div class="user-status-bar" id="userStatusBar" style="display: none;">
                <div class="user-info">
                    <div class="user-avatar">👤</div>
                    <div class="user-details">
                        <div class="username" id="currentUsername">访客玩家</div>
                        <div class="user-stats">
                            <span>胜场: <span id="userWins">0</span></span>
                            <span>败场: <span id="userLosses">0</span></span>
                            <span>在线: <span id="onlineCount">1</span>人</span>
                        </div>
                    </div>
                </div>
                <div class="header-buttons">
                    <button id="friendsBtn" class="header-btn">👥 好友</button>
                    <button id="battleBtn" class="header-btn">⚔️ 对战</button>
                    <button id="historyBtn" class="header-btn">📊 战绩</button>
                    <button id="achievementsBtn" class="header-btn">🏅 成就</button>
                    <button id="profileBtn" class="header-btn">⚙️ 设置</button>
                </div>
            </div>
        </div>

        <!-- 好友系统界面 -->
        <div id="friendsScreen" class="friends-screen" style="display: none;">
            <div class="friends-container">
                <h2>👥 好友系统</h2>
                
                <div class="friends-tabs">
                    <button class="tab-btn active" data-tab="friendsList">好友列表</button>
                    <button class="tab-btn" data-tab="addFriend">添加好友</button>
                    <button class="tab-btn" data-tab="friendRequests">好友申请</button>
                </div>
                
                <div id="friendsList" class="tab-content active">
                    <div class="friends-list">
                        <div class="friend-item online">
                            <div class="friend-avatar">🤴</div>
                            <div class="friend-info">
                                <div class="friend-name">骑士王亚瑟</div>
                                <div class="friend-status">在线 - 正在游戏中</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn-small challenge-btn">挑战</button>
                                <button class="btn-small spectate-btn">观战</button>
                            </div>
                        </div>
                        
                        <div class="friend-item offline">
                            <div class="friend-avatar">👸</div>
                            <div class="friend-info">
                                <div class="friend-name">女王伊丽莎白</div>
                                <div class="friend-status">离线 - 2小时前</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn-small" disabled>离线</button>
                            </div>
                        </div>
                        
                        <div class="friend-item online">
                            <div class="friend-avatar">🗡️</div>
                            <div class="friend-info">
                                <div class="friend-name">剑圣宫本</div>
                                <div class="friend-status">在线 - 空闲中</div>
                            </div>
                            <div class="friend-actions">
                                <button class="btn-small challenge-btn">挑战</button>
                                <button class="btn-small chat-btn">聊天</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="addFriend" class="tab-content">
                    <div class="add-friend-form">
                        <h3>添加新好友</h3>
                        <div class="input-group">
                            <input type="text" id="friendUsername" placeholder="输入玩家用户名..." class="friend-input">
                            <button id="searchFriend" class="btn">搜索</button>
                        </div>
                        
                        <div id="searchResults" class="search-results">
                            <!-- 搜索结果将在这里显示 -->
                        </div>
                        
                        <div class="nearby-players">
                            <h4>附近的玩家</h4>
                            <div class="player-item">
                                <div class="player-avatar">🏹</div>
                                <div class="player-info">
                                <div class="player-name">弓箭手罗宾</div>
                                    <div class="player-level">等级 15 - 胜率 68%</div>
                                </div>
                                <button class="btn-small add-btn">添加</button>
                            </div>
                            
                            <div class="player-item">
                                <div class="player-avatar">🛡️</div>
                                <div class="player-info">
                                    <div class="player-name">圣骑士兰斯洛特</div>
                                    <div class="player-level">等级 22 - 胜率 75%</div>
                                </div>
                                <button class="btn-small add-btn">添加</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="friendRequests" class="tab-content">
                    <div class="friend-requests">
                        <h3>待处理的好友申请</h3>
                        
                        <div class="request-item">
                            <div class="request-avatar">🧙</div>
                            <div class="request-info">
                                <div class="request-name">法师梅林</div>
                                <div class="request-time">2分钟前发送申请</div>
                            </div>
                            <div class="request-actions">
                                <button class="btn-small accept-btn">接受</button>
                                <button class="btn-small decline-btn">拒绝</button>
                            </div>
                        </div>
                        
                        <div class="request-item">
                            <div class="request-avatar">🏰</div>
                            <div class="request-info">
                                <div class="request-name">城主巴德</div>
                                <div class="request-time">1小时前发送申请</div>
                            </div>
                            <div class="request-actions">
                                <button class="btn-small accept-btn">接受</button>
                                <button class="btn-small decline-btn">拒绝</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="closeFriends" class="btn">返回主界面</button>
            </div>
        </div>

        <!-- 对战大厅界面 -->
        <div id="battleScreen" class="battle-screen" style="display: none;">
            <div class="battle-container">
                <h2>⚔️ 对战大厅</h2>
                
                <div class="battle-modes">
                    <div class="mode-card" data-mode="ranked">
                        <div class="mode-icon">🏆</div>
                        <div class="mode-name">排位赛</div>
                        <div class="mode-desc">与同等级玩家竞技，提升排名</div>
                        <div class="mode-info" id="currentRankDisplay">当前段位: 佣兵</div>
                    </div>
                    
                    <div class="mode-card" data-mode="casual">
                        <div class="mode-icon">🎮</div>
                        <div class="mode-name">休闲模式</div>
                        <div class="mode-desc">轻松对战，不影响排名</div>
                        <div class="mode-info">快速匹配</div>
                    </div>
                    
                    <div class="mode-card" data-mode="ai">
                        <div class="mode-icon">🤖</div>
                        <div class="mode-name">与AI对战</div>
                        <div class="mode-desc">挑战智能AI，练习战术技巧</div>
                        <div class="mode-info">立即开始</div>
                    </div>
                    
                    <div class="mode-card" data-mode="custom">
                        <div class="mode-icon">🎯</div>
                        <div class="mode-name">自定义房间</div>
                        <div class="mode-desc">创建或加入自定义房间</div>
                        <div class="mode-info">房间码: 6位数字</div>
                    </div>
                </div>
                
                <div id="matchmakingPanel" class="matchmaking-panel" style="display: none;">
                    <div class="matching-status">
                        <div class="matching-spinner">⚔️</div>
                        <div class="matching-text">正在寻找对手...</div>
                        <div class="matching-time">已等待: <span id="waitTime">0</span>秒</div>
                    </div>
                    <button id="cancelMatch" class="btn">取消匹配</button>
                </div>
                
                <div id="customRoomPanel" class="custom-room-panel" style="display: none;">
                    <div class="room-options">
                        <button id="createRoom" class="btn">创建房间</button>
                        <div class="join-room">
                            <input type="text" id="roomCode" placeholder="输入房间码..." maxlength="6">
                            <button id="joinRoom" class="btn">加入房间</button>
                        </div>
                    </div>
                    
                    <div id="roomList" class="room-list">
                        <h4>公开房间</h4>
                        <div class="room-item">
                            <div class="room-info">
                                <div class="room-name">新手友谊赛</div>
                                <div class="room-details">房主: 骑士王亚瑟 | 1/2人</div>
                            </div>
                            <button class="btn-small join-btn">加入</button>
                        </div>
                        
                        <div class="room-item">
                            <div class="room-info">
                                <div class="room-name">高手切磋</div>
                                <div class="room-details">房主: 剑圣宫本 | 1/2人</div>
                            </div>
                            <button class="btn-small join-btn">加入</button>
                        </div>
                    </div>
                </div>
                
                <button id="closeBattle" class="btn">返回主界面</button>
            </div>
        </div>

        <!-- 历史战绩界面 -->
        <div id="historyScreen" class="history-screen" style="display: none;">
            <div class="history-container">
                <h2>📊 历史战绩</h2>
                
                <!-- 战绩概览 -->
                <div class="history-summary">
                    <div class="summary-card">
                        <div class="summary-icon">🎯</div>
                        <div class="summary-number" id="totalGamesCount">0</div>
                        <div class="summary-label">总场次</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">🏆</div>
                        <div class="summary-number" id="totalWinsCount">0</div>
                        <div class="summary-label">胜场</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">💔</div>
                        <div class="summary-number" id="totalLossesCount">0</div>
                        <div class="summary-label">败场</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">📈</div>
                        <div class="summary-number" id="winRateDisplay">0%</div>
                        <div class="summary-label">胜率</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">🔥</div>
                        <div class="summary-number" id="winStreakCount">0</div>
                        <div class="summary-label">连胜</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-icon">⏱️</div>
                        <div class="summary-number" id="avgDurationDisplay">0分</div>
                        <div class="summary-label">平均时长</div>
                    </div>
                </div>
                
                <!-- 筛选器 -->
                <div class="history-filters">
                    <button class="filter-btn active" data-filter="all">全部</button>
                    <button class="filter-btn" data-filter="victory">胜利</button>
                    <button class="filter-btn" data-filter="defeat">失败</button>
                    <button class="filter-btn" data-filter="king">国王方</button>
                    <button class="filter-btn" data-filter="slave">奴隶方</button>
                    <button class="filter-btn" data-filter="recent">最近7天</button>
                </div>
                
                <!-- 战斗记录 -->
                <div class="battle-history" id="battleHistoryList">
                    <div class="no-records">
                        <div class="no-records-icon">⚔️</div>
                        <h3>暂无战斗记录</h3>
                        <p>开始你的第一场战斗吧！</p>
                    </div>
                </div>
                
                <button id="closeHistory" class="btn">返回主界面</button>
            </div>
        </div>

        <!-- 成就系统界面 -->
        <div id="achievementsScreen" class="achievements-screen" style="display: none;">
            <div class="achievements-container">
                <h2>🏅 成就系统</h2>
                
                <!-- 成就统计 -->
                <div class="achievement-stats">
                    <div class="stat-group">
                        <div class="stat-value" id="unlockedCount">0</div>
                        <div class="stat-label">已解锁</div>
                    </div>
                    <div class="stat-group">
                        <div class="stat-value" id="totalAchievements">0</div>
                        <div class="stat-label">总成就</div>
                    </div>
                    <div class="stat-group">
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-label">完成度</div>
                    </div>
                    <div class="stat-group">
                        <div class="stat-value" id="totalRewards">0</div>
                        <div class="stat-label">总奖励</div>
                    </div>
                </div>
                
                <!-- 成就分类筛选 -->
                <div class="achievement-categories">
                    <button class="category-filter active" data-category="all">全部</button>
                    <button class="category-filter" data-category="basic">基础</button>
                    <button class="category-filter" data-category="streak">连胜</button>
                    <button class="category-filter" data-category="games">对战</button>
                    <button class="category-filter" data-category="faction">阵营</button>
                    <button class="category-filter" data-category="time">时间</button>
                    <button class="category-filter" data-category="winrate">胜率</button>
                    <button class="category-filter" data-category="rank">段位</button>
                    <button class="category-filter" data-category="special">特殊</button>
                    <button class="category-filter" data-category="unlocked">已解锁</button>
                </div>
                
                <div class="achievements-grid" id="achievementsList">
                    <!-- 成就项目将通过JavaScript动态生成 -->
                </div>
                
                <button id="closeAchievements" class="btn">返回主界面</button>
            </div>
        </div>

        <!-- 用户设置界面 -->
        <div id="profileScreen" class="profile-screen" style="display: none;">
            <div class="profile-container">
                <h2>⚙️ 个人设置</h2>
                
                <div class="profile-sections">
                    <div class="profile-section">
                        <h3>个人信息</h3>
                        <div class="profile-info">
                            <div class="avatar-section">
                                <div class="large-avatar">👤</div>
                                <button class="btn-small">更换头像</button>
                                <div class="avatar-gallery" id="avatarGallery" style="display: none; margin-top: 15px;">
                                    <div class="avatar-grid-profile">
                                        <div class="avatar-option-profile" data-avatar="👤">👤</div>
                                        <div class="avatar-option-profile" data-avatar="🤴">🤴</div>
                                        <div class="avatar-option-profile" data-avatar="👸">👸</div>
                                        <div class="avatar-option-profile" data-avatar="🗡️">🗡️</div>
                                        <div class="avatar-option-profile" data-avatar="🛡️">🛡️</div>
                                        <div class="avatar-option-profile" data-avatar="🏹">🏹</div>
                                        <div class="avatar-option-profile" data-avatar="🧙">🧙</div>
                                        <div class="avatar-option-profile" data-avatar="🏰">🏰</div>
                                        <div class="avatar-option-profile" data-avatar="⚔️">⚔️</div>
                                        <div class="avatar-option-profile" data-avatar="🎭">🎭</div>
                                        <div class="avatar-option-profile" data-avatar="🦅">🦅</div>
                                        <div class="avatar-option-profile" data-avatar="🐺">🐺</div>
                                        <div class="avatar-option-profile" data-avatar="🐉">🐉</div>
                                        <div class="avatar-option-profile" data-avatar="🦁">🦁</div>
                                        <div class="avatar-option-profile" data-avatar="🔥">🔥</div>
                                        <div class="avatar-option-profile" data-avatar="⚡">⚡</div>
                                        <div class="avatar-option-profile" data-avatar="💎">💎</div>
                                        <div class="avatar-option-profile" data-avatar="👑">👑</div>
                                    </div>
                                </div>
                                <div id="currentRankInfo" style="margin-top: 15px; text-align: center;">
                                    <!-- 段位信息将在这里显示 -->
                                </div>
                            </div>
                            <div class="info-section">
                                <div class="input-group">
                                    <label>用户名:</label>
                                    <input type="text" id="usernameInput" value="访客玩家" maxlength="12">
                                    <div class="input-hint">2-12个字符，支持中英文</div>
                                </div>
                                <div class="input-group">
                                    <label>个性签名:</label>
                                    <input type="text" id="signatureInput" placeholder="输入你的个性签名..." maxlength="50">
                                    <div class="input-hint">最多50个字符，展示你的个性</div>
                                </div>
                                <div class="input-group">
                                    <label>注册时间:</label>
                                    <div class="info-display" id="registerTime">2024年12月</div>
                                </div>
                                <div class="input-group">
                                    <label>最后登录:</label>
                                    <div class="info-display" id="lastLogin">刚刚</div>
                                </div>
                                <div class="input-group">
                                    <label>游戏ID:</label>
                                    <div class="info-display" id="gameId">#123456</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 个人成就展示 -->
                        <div class="personal-achievements" style="margin-top: 25px;">
                            <h4 style="color: #d4af37; margin-bottom: 15px; font-size: 1.1rem;">🏅 个人荣誉</h4>
                            <div class="achievement-badges" id="personalBadges">
                                <!-- 成就徽章将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 偏好设置 -->
                        <div class="preference-settings" style="margin-top: 25px;">
                            <h4 style="color: #d4af37; margin-bottom: 15px; font-size: 1.1rem;">⚙️ 个人偏好</h4>
                            <div class="preference-grid">
                                <div class="preference-item">
                                    <label>偏好阵营:</label>
                                    <select id="preferredFaction" style="
                                        background: rgba(0,0,0,0.5);
                                        border: 2px solid #8b4513;
                                        border-radius: 6px;
                                        color: #f4e4bc;
                                        padding: 8px;
                                        font-family: 'Crimson Text', serif;
                                    ">
                                        <option value="none">无偏好</option>
                                        <option value="king">👑 国王方</option>
                                        <option value="slave">⚔️ 奴隶方</option>
                                    </select>
                                </div>
                                <div class="preference-item">
                                    <label>偏好开局:</label>
                                    <select id="preferredOpening" style="
                                        background: rgba(0,0,0,0.5);
                                        border: 2px solid #8b4513;
                                        border-radius: 6px;
                                        color: #f4e4bc;
                                        padding: 8px;
                                        font-family: 'Crimson Text', serif;
                                    ">
                                        <option value="none">无偏好</option>
                                        <option value="king">国王开局</option>
                                        <option value="queen">女王开局</option>
                                        <option value="slave">奴隶起义</option>
                                    </select>
                                </div>
                                <div class="preference-item">
                                    <label>游戏风格:</label>
                                    <select id="gameStyle" style="
                                        background: rgba(0,0,0,0.5);
                                        border: 2px solid #8b4513;
                                        border-radius: 6px;
                                        color: #f4e4bc;
                                        padding: 8px;
                                        font-family: 'Crimson Text', serif;
                                    ">
                                        <option value="balanced">平衡型</option>
                                        <option value="aggressive">激进型</option>
                                        <option value="defensive">防守型</option>
                                        <option value="strategic">策略型</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>游戏统计</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">总场次</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">胜场</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0%</div>
                                <div class="stat-label">胜率</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">新手</div>
                                <div class="stat-label">段位</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>游戏设置</h3>
                        <div class="settings-list">
                            <div class="setting-item">
                                <label>音效:</label>
                                <input type="range" id="soundVolume" min="0" max="100" value="80">
                            </div>
                            <div class="setting-item">
                                <label>动画效果:</label>
                                <input type="checkbox" id="animationToggle" checked>
                            </div>
                            <div class="setting-item">
                                <label>自动确认出牌:</label>
                                <input type="checkbox" id="autoConfirm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button id="saveProfile" class="btn">保存设置</button>
                    <button id="closeProfile" class="btn">返回主界面</button>
                </div>
            </div>
        </div>

        <!-- 登录界面 -->
        <div id="loginScreen" class="login-screen">
            <div class="login-container">
                <h2>👑 欢迎来到王与奴 ⚔️</h2>
                <p class="login-subtitle">请创建你的角色开始游戏</p>
                
                <div class="login-form">
                    <div class="avatar-selection">
                        <h3>选择头像</h3>
                        <div class="avatar-grid">
                            <div class="avatar-option selected" data-avatar="👤">👤</div>
                            <div class="avatar-option" data-avatar="🤴">🤴</div>
                            <div class="avatar-option" data-avatar="👸">👸</div>
                            <div class="avatar-option" data-avatar="🗡️">🗡️</div>
                            <div class="avatar-option" data-avatar="🛡️">🛡️</div>
                            <div class="avatar-option" data-avatar="🏹">🏹</div>
                            <div class="avatar-option" data-avatar="🧙">🧙</div>
                            <div class="avatar-option" data-avatar="🏰">🏰</div>
                            <div class="avatar-option" data-avatar="⚔️">⚔️</div>
                            <div class="avatar-option" data-avatar="🎭">🎭</div>
                            <div class="avatar-option" data-avatar="🦅">🦅</div>
                            <div class="avatar-option" data-avatar="🐺">🐺</div>
                        </div>
                    </div>
                    
                    <div class="username-input-group">
                        <label for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername" placeholder="输入你的用户名..." maxlength="12" value="访客玩家">
                        <div class="input-hint">2-12个字符，支持中英文</div>
                    </div>
                    
                    <button id="enterGame" class="btn login-btn">开始</button>
                    
                    <div class="login-footer">
                        <p>首次游戏将获得新手奖励：</p>
                        <div class="rewards-preview">
                            <span>💰 100金币</span>
                            <span>🌟 50经验</span>
                            <span>🏆 10奖杯</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 游戏介绍界面 -->
        <div id="introScreen" class="intro-screen" style="display: none;">
            <div class="intro-container">
                <h2>👑 欢迎来到《王与奴》！⚔️</h2>
                <p class="intro-subtitle">这是一款中世纪风格的1v1博弈对战型卡牌游戏</p>
                <p class="intro-description">玩家操控国王方或奴隶方，使用策略，与对手进行心理战，争取游戏胜利。游戏时长仅在2~6分钟</p>
                
                <div class="story-section">
                    <h3>序章 — 王冠与锁链</h3>
                    <p>王权与枷锁在同一桌上较量。两方对弈：王方（维护王室秩序）与奴隶方（背负反抗之名）。每一张出牌都是一次博弈，每一次交锋都可能改写结局。胜利只有两种：王方守住关键，或奴隶方斩落王冠。</p>
                </div>
                
                <div class="worldview-section">
                    <h3>🎴 一、世界观</h3>
                    <div class="worldview-content">
                        <p>在中世纪的王国中，权力与反抗共存。</p>
                        <p>一方是守护王座的国王方，</p>
                        <p>一方是渴望推翻统治的奴隶方。</p>
                        <p>他们的命运，在一场场出牌的心理战中决定。</p>
                    </div>
                </div>
                
                <div class="intro-actions">
                    <button id="continueToGame" class="btn">开始游戏</button>
                </div>
            </div>
        </div>

        <!-- 游戏设置界面 -->
        <div id="setupScreen" class="setup-screen" style="display: none;">
            <h2>选择你的阵营</h2>
            <div class="faction-selection">
                <div class="faction-card" data-faction="king">
                    <div class="faction-icon">👑</div>
                    <div class="faction-name">国王方</div>
                    <p>统治者阵营，守护王座的权威</p>
                    <p><strong>胜利条件：</strong>消灭所有反抗力量</p>
                </div>
                <div class="faction-card" data-faction="slave">
                    <div class="faction-icon">⚔️</div>
                    <div class="faction-name">奴隶方</div>
                    <p>反叛阵营，推翻腐朽的统治</p>
                    <p><strong>胜利条件：</strong>击败国王方关键牌</p>
                </div>
            </div>

            <div id="openingSelection" class="opening-selection">
                <h3>选择开局方式</h3>
                <div id="openingCards"></div>
            </div>

            <button id="startGame" class="btn" disabled>开始游戏</button>
        </div>

        <!-- 游戏主界面 -->
        <div id="gameBoard" class="game-board">
            <!-- 对手区域 -->
            <div class="opponent-area">
                <div class="game-info">
                    <div class="player-info">
                        <span class="faction-badge" id="opponentFaction">AI 对手</span>
                        <span class="opening-info" id="opponentOpening">开局: 未知</span>
                        <span>手牌: <span id="opponentHandCount">6</span></span>
                    </div>
                </div>
                <div class="hand-cards" id="opponentHand"></div>
            </div>

            <!-- 战斗区域 -->
            <div class="battle-area">
                <div class="turn-indicator" id="turnIndicator">选择一张牌进行战斗</div>
                <div class="battle-cards">
                    <div id="opponentBattleCard"></div>
                    <div class="vs-text">VS</div>
                    <div id="playerBattleCard"></div>
                </div>
                <div style="display: flex; gap: 15px;">
                    <!-- 自动进入下一回合，无需手动按钮 -->
                </div>
            </div>

            <!-- 玩家区域 -->
            <div class="player-area">
                <div class="game-info">
                    <div class="player-info">
                        <span class="faction-badge" id="playerFaction">你的阵营</span>
                        <span class="opening-info" id="playerOpening">开局: 未知</span>
                        <span>手牌: <span id="playerHandCount">6</span></span>
                    </div>
                </div>
                <div class="hand-cards" id="playerHand"></div>
                <div class="game-actions">
                    <button id="confirmPlay" class="btn" disabled>确认出牌</button>
                    <button id="shuffleHand" class="btn-secondary">🔄 洗牌</button>
                    <button id="surrenderGame" class="btn-danger">🏳️ 认输</button>
                </div>
                <div class="game-log" id="gameLog"></div>
            </div>
        </div>
    </div>

    <!-- 游戏结果模态框 -->
    <div id="gameModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">游戏结束</div>
            <div id="modalContent"></div>
            <button id="restartGame" class="btn">重新开始</button>
        </div>
    </div>

    <script>
        // 游戏状态
        let gameState = {
            playerFaction: null,
            playerOpening: null,
            opponentOpening: null,
            playerHand: [],
            opponentHand: [],
            playerSelectedCard: null,
            opponentSelectedCard: null,
            currentTurn: 1,
            gamePhase: 'setup', // setup, playing, playerTurn, opponentTurn, battle, ended
            isPlayerTurn: true, // 当前是否为玩家回合
            playerBattleCard: null,
            opponentBattleCard: null,
            gameStartTime: null, // 游戏开始时间
            specialEffects: {
                kingImmune: false, // 玩家皇家守卫效果
                opponentKingImmune: false, // 对手皇家守卫效果
                ultimateGuardCooldown: 0, // 玩家终极守卫冷却回合数
                aiUltimateGuardCooldown: 0 // AI终极守卫冷却回合数
            }
        };

        // 卡牌数据
        const cardData = {
            citizen: { name: '市民', icon: '👨', level: 1, type: 'basic', description: '普通的王国居民' },
            assassin: { name: '刺客', icon: '🗡️', level: 2, type: 'basic', description: '刺杀关键牌或抽取手牌刺杀' },
            butcher: { name: '屠夫', icon: '⚒️', level: 2, type: 'basic', description: '同归于尽的狂战士' },
            guard: { name: '守卫', icon: '🛡️', level: 2, type: 'basic', description: '忠诚的护卫' },
            royalGuard: { name: '皇家守卫', icon: '🛡️', level: 2, type: 'special', description: '死后保护国王一次' },
            ultimateGuard: { name: '终极守卫', icon: '🛡️', level: 3, type: 'special', description: '最强护卫，不可连续出动' },
            king: { name: '国王', icon: '👑', level: 3, type: 'key', description: '王国的统治者' },
            queen: { name: '女王', icon: '👸', level: 1, type: 'key', description: '死后召唤国王' },
            slave: { name: '奴隶', icon: '🙇', level: 0, type: 'basic', description: '能击败国王的反抗者' }
        };

        // 开局配置
        const openingConfigs = {
            king: {
                name: '国王开局',
                description: '拥有强大的国王，但需要小心保护',
                deck: ['citizen', 'citizen', 'assassin', 'butcher', 'royalGuard', 'king']
            },
            queen: {
                name: '女王开局', 
                description: '稳健防御，女王死后召唤国王',
                deck: ['citizen', 'citizen', 'assassin', 'butcher', 'ultimateGuard', 'queen']
            },
            slave: {
                name: '奴隶起义',
                description: '数量优势，奴隶能击败国王',
                deck: ['slave', 'slave', 'citizen', 'citizen', 'assassin', 'butcher']
            }
        };

        // 用户数据
        let userData = {
            username: '访客玩家',
            wins: 0,
            losses: 0,
            avatar: '👤',
            signature: '',
            experience: 0,
            level: 1,
            coins: 0,
            trophies: 0, // 奖杯数量
            difficulty: 'normal', // 游戏难度
            friends: [
                { id: 1, name: '骑士王亚瑟', avatar: '🤴', online: true, status: '正在游戏中' },
                { id: 2, name: '女王伊丽莎白', avatar: '👸', online: false, status: '2小时前' },
                { id: 3, name: '剑圣宫本', avatar: '🗡️', online: true, status: '空闲中' }
            ],
            friendRequests: [
                { id: 4, name: '法师梅林', avatar: '🧙', time: '2分钟前' },
                { id: 5, name: '城主巴德', avatar: '🏰', time: '1小时前' }
            ],
            battleHistory: [],
            achievements: {},
            stats: {
                currentWinStreak: 0,
                maxWinStreak: 0,
                totalPlayTime: 0,
                kingWins: 0,
                slaveWins: 0,
                kingLosses: 0,
                slaveLosses: 0,
                // 特殊统计
                assassinKills: 0,
                butcherKills: 0,
                guardProtections: 0,
                slaveKills: 0,
                comebacks: 0,
                // 连败统计
                currentLossStreak: 0,
                // 卡牌使用统计
                cardUsage: {
                    citizen: 0,
                    assassin: 0,
                    butcher: 0,
                    guard: 0,
                    royalGuard: 0,
                    ultimateGuard: 0,
                    king: 0,
                    queen: 0,
                    slave: 0
                }
            }
        };

        // 段位系统配置
        const rankSystem = {
            佣兵: { min: 0, max: 50, icon: '⚔️', color: '#8b7355', description: '初入战场的新兵' },
            将领: { min: 51, max: 100, icon: '🛡️', color: '#c0c0c0', description: '经验丰富的指挥官' },
            将军: { min: 101, max: 150, icon: '🎖️', color: '#ffd700', description: '战功赫赫的将军' },
            骑士: { min: 151, max: 200, icon: '🏆', color: '#ff6b35', description: '荣耀无双的骑士' },
            帝王: { min: 201, max: 999, icon: '👑', color: '#d4af37', description: '至高无上的帝王' }
        };

        // 获取当前段位信息
        function getCurrentRank(trophies) {
            for (const [rankName, rankData] of Object.entries(rankSystem)) {
                if (trophies >= rankData.min && trophies <= rankData.max) {
                    return {
                        name: rankName,
                        icon: rankData.icon,
                        color: rankData.color,
                        description: rankData.description,
                        current: trophies,
                        min: rankData.min,
                        max: rankData.max,
                        progress: Math.round(((trophies - rankData.min) / (rankData.max - rankData.min)) * 100)
                    };
                }
            }
            // 如果超过最高段位
            return {
                name: '帝王',
                icon: '👑',
                color: '#d4af37',
                description: '至高无上的帝王',
                current: trophies,
                min: 201,
                max: 999,
                progress: 100
            };
        }

        // 计算段位变化
        function calculateRankChange(isWin) {
            const gameMode = gameState.gameMode || 'ai';
            const opponentData = gameState.opponentData;
            
            let change = 0;
            
            if (gameMode === 'ranked') {
                // 排位赛奖杯变化
                if (isWin) {
                    // 基础奖杯
                    let baseReward = 5;
                    
                    // 根据对手实力调整奖杯
                    if (opponentData && opponentData.trophies) {
                        const trophyDiff = opponentData.trophies - userData.trophies;
                        if (trophyDiff >= 20) baseReward += 2; // 击败更强对手
                        else if (trophyDiff <= -20) baseReward -= 1; // 击败较弱对手
                    }
                    
                    // 连胜奖励
                    const winStreak = userData.stats.currentWinStreak;
                    if (winStreak >= 3) baseReward += Math.min(Math.floor(winStreak / 3), 3);
                    
                    change = Math.max(3, Math.min(baseReward, 8)); // 限制在3-8之间
                } else {
                    // 失败扣除奖杯
                    let baseLoss = -4;
                    
                    // 根据对手实力调整扣除
                    if (opponentData && opponentData.trophies) {
                        const trophyDiff = opponentData.trophies - userData.trophies;
                        if (trophyDiff >= 20) baseLoss += 1; // 输给更强对手扣得少
                        else if (trophyDiff <= -20) baseLoss -= 1; // 输给较弱对手扣得多
                    }
                    
                    change = Math.max(-6, Math.min(baseLoss, -2)); // 限制在-6到-2之间
                }
            } else if (gameMode === 'casual') {
                // 休闲模式不影响奖杯
                change = 0;
            } else {
                // AI对战模式少量奖杯变化
                change = isWin ? 2 : -1;
            }
            
            const oldTrophies = userData.trophies;
            const newTrophies = Math.max(0, oldTrophies + change); // 奖杯不能低于0
            
            const oldRank = getCurrentRank(oldTrophies);
            const newRank = getCurrentRank(newTrophies);
            
            userData.trophies = newTrophies;
            
            return {
                change: change,
                oldTrophies: oldTrophies,
                newTrophies: newTrophies,
                oldRank: oldRank,
                newRank: newRank,
                rankChanged: oldRank.name !== newRank.name,
                gameMode: gameMode
            };
        }

        // 成就定义
        const achievementDefinitions = {
            // 基础成就
            firstWin: {
                name: '初战告捷',
                description: '获得第一场胜利',
                icon: '🎉',
                category: 'basic',
                rarity: 'common',
                reward: 50,
                condition: (data) => data.wins >= 1
            },
            firstLoss: {
                name: '败而不馁',
                description: '经历第一次失败，学会成长',
                icon: '💪',
                category: 'basic',
                rarity: 'common',
                reward: 20,
                condition: (data) => data.losses >= 1
            },
            
            // 连胜成就
            winStreak3: {
                name: '小试牛刀',
                description: '连续获得3场胜利',
                icon: '🔥',
                category: 'streak',
                rarity: 'common',
                reward: 100,
                condition: (data) => data.stats.maxWinStreak >= 3
            },
            winStreak5: {
                name: '连胜达人',
                description: '连续获得5场胜利',
                icon: '🔥',
                category: 'streak',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => data.stats.maxWinStreak >= 5
            },
            winStreak10: {
                name: '无敌战神',
                description: '连续获得10场胜利',
                icon: '⚡',
                category: 'streak',
                rarity: 'rare',
                reward: 500,
                condition: (data) => data.stats.maxWinStreak >= 10
            },
            winStreak15: {
                name: '传奇霸主',
                description: '连续获得15场胜利',
                icon: '👑',
                category: 'streak',
                rarity: 'epic',
                reward: 1000,
                condition: (data) => data.stats.maxWinStreak >= 15
            },
            
            // 对战场次成就
            totalGames5: {
                name: '新兵入伍',
                description: '完成5场对战',
                icon: '🎖️',
                category: 'games',
                rarity: 'common',
                reward: 50,
                condition: (data) => (data.wins + data.losses) >= 5
            },
            totalGames10: {
                name: '战场老兵',
                description: '完成10场对战',
                icon: '🎖️',
                category: 'games',
                rarity: 'common',
                reward: 100,
                condition: (data) => (data.wins + data.losses) >= 10
            },
            totalGames25: {
                name: '百战勇士',
                description: '完成25场对战',
                icon: '⚔️',
                category: 'games',
                rarity: 'uncommon',
                reward: 250,
                condition: (data) => (data.wins + data.losses) >= 25
            },
            totalGames50: {
                name: '战争之王',
                description: '完成50场对战',
                icon: '👑',
                category: 'games',
                rarity: 'rare',
                reward: 500,
                condition: (data) => (data.wins + data.losses) >= 50
            },
            totalGames100: {
                name: '传奇将军',
                description: '完成100场对战',
                icon: '🏆',
                category: 'games',
                rarity: 'epic',
                reward: 1000,
                condition: (data) => (data.wins + data.losses) >= 100
            },
            
            // 阵营专精成就
            kingMaster: {
                name: '王权至上',
                description: '使用国王方获得10场胜利',
                icon: '👑',
                category: 'faction',
                rarity: 'uncommon',
                reward: 300,
                condition: (data) => data.stats.kingWins >= 10
            },
            slaveMaster: {
                name: '自由之光',
                description: '使用奴隶方获得10场胜利',
                icon: '⚔️',
                category: 'faction',
                rarity: 'uncommon',
                reward: 300,
                condition: (data) => data.stats.slaveWins >= 10
            },
            kingLegend: {
                name: '不朽王权',
                description: '使用国王方获得25场胜利',
                icon: '👑',
                category: 'faction',
                rarity: 'rare',
                reward: 750,
                condition: (data) => data.stats.kingWins >= 25
            },
            slaveLegend: {
                name: '革命先驱',
                description: '使用奴隶方获得25场胜利',
                icon: '⚔️',
                category: 'faction',
                rarity: 'rare',
                reward: 750,
                condition: (data) => data.stats.slaveWins >= 25
            },
            
            // 时间相关成就
            quickWin: {
                name: '闪电战',
                description: '在3分钟内获得胜利',
                icon: '⚡',
                category: 'time',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => data.battleHistory.some(battle => 
                    battle.result === 'victory' && battle.duration <= 180)
            },
            ultraQuickWin: {
                name: '秒杀专家',
                description: '在1分钟内获得胜利',
                icon: '💨',
                category: 'time',
                rarity: 'rare',
                reward: 500,
                condition: (data) => data.battleHistory.some(battle => 
                    battle.result === 'victory' && battle.duration <= 60)
            },
            longBattle: {
                name: '持久战士',
                description: '进行一场超过15分钟的对战',
                icon: '🛡️',
                category: 'time',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => data.battleHistory.some(battle => battle.duration >= 900)
            },
            marathonBattle: {
                name: '马拉松战士',
                description: '进行一场超过30分钟的对战',
                icon: '🏃',
                category: 'time',
                rarity: 'rare',
                reward: 500,
                condition: (data) => data.battleHistory.some(battle => battle.duration >= 1800)
            },
            
            // 胜率成就
            goodRecord: {
                name: '优秀战绩',
                description: '胜率达到60%（至少10场）',
                icon: '📈',
                category: 'winrate',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => {
                    const total = data.wins + data.losses;
                    return total >= 10 && (data.wins / total) >= 0.6;
                }
            },
            excellentRecord: {
                name: '卓越战绩',
                description: '胜率达到70%（至少15场）',
                icon: '🌟',
                category: 'winrate',
                rarity: 'rare',
                reward: 400,
                condition: (data) => {
                    const total = data.wins + data.losses;
                    return total >= 15 && (data.wins / total) >= 0.7;
                }
            },
            perfectRecord: {
                name: '完美记录',
                description: '胜率达到80%（至少20场）',
                icon: '💎',
                category: 'winrate',
                rarity: 'epic',
                reward: 800,
                condition: (data) => {
                    const total = data.wins + data.losses;
                    return total >= 20 && (data.wins / total) >= 0.8;
                }
            },
            godlikeRecord: {
                name: '神话传说',
                description: '胜率达到90%（至少30场）',
                icon: '🌈',
                category: 'winrate',
                rarity: 'legendary',
                reward: 1500,
                condition: (data) => {
                    const total = data.wins + data.losses;
                    return total >= 30 && (data.wins / total) >= 0.9;
                }
            },
            
            // 特殊玩法成就
            assassinMaster: {
                name: '暗影刺客',
                description: '使用刺客获得10次胜利',
                icon: '🔪',
                category: 'special',
                rarity: 'uncommon',
                reward: 250,
                condition: (data) => (data.stats.assassinKills || 0) >= 10
            },
            butcherMaster: {
                name: '屠夫之王',
                description: '使用屠夫同归于尽10次',
                icon: '⚒️',
                category: 'special',
                rarity: 'uncommon',
                reward: 250,
                condition: (data) => (data.stats.butcherKills || 0) >= 10
            },
            guardianAngel: {
                name: '守护天使',
                description: '皇家守卫成功保护国王5次',
                icon: '👼',
                category: 'special',
                rarity: 'rare',
                reward: 400,
                condition: (data) => (data.stats.guardProtections || 0) >= 5
            },
            slaveRevolution: {
                name: '奴隶革命',
                description: '奴隶成功击败国王5次',
                icon: '🗽',
                category: 'special',
                rarity: 'rare',
                reward: 400,
                condition: (data) => (data.stats.slaveKills || 0) >= 5
            },
            
            // 回合数成就
            quickVictory: {
                name: '速战速决',
                description: '在3回合内获得胜利',
                icon: '🚀',
                category: 'rounds',
                rarity: 'rare',
                reward: 400,
                condition: (data) => data.battleHistory.some(battle => 
                    battle.result === 'victory' && battle.turns <= 3)
            },
            epicBattle: {
                name: '史诗对决',
                description: '进行一场超过20回合的对战',
                icon: '📚',
                category: 'rounds',
                rarity: 'rare',
                reward: 400,
                condition: (data) => data.battleHistory.some(battle => battle.turns >= 20)
            },
            
            // 综合成就
            allRounder: {
                name: '全能战士',
                description: '国王方和奴隶方各获得5场胜利',
                icon: '⚖️',
                category: 'comprehensive',
                rarity: 'rare',
                reward: 500,
                condition: (data) => data.stats.kingWins >= 5 && data.stats.slaveWins >= 5
            },
            weekendWarrior: {
                name: '周末战士',
                description: '在一天内完成5场对战',
                icon: '📅',
                category: 'comprehensive',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => {
                    const today = new Date().toDateString();
                    const todayBattles = data.battleHistory.filter(battle => 
                        new Date(battle.date).toDateString() === today);
                    return todayBattles.length >= 5;
                }
            },
            comebackKing: {
                name: '逆转之王',
                description: '在连败3场后获得胜利',
                icon: '🔄',
                category: 'comprehensive',
                rarity: 'rare',
                reward: 400,
                condition: (data) => (data.stats.comebacks || 0) >= 1
            },
            
            // 段位成就
            reachCaptain: {
                name: '晋升将领',
                description: '达到将领段位',
                icon: '🛡️',
                category: 'rank',
                rarity: 'common',
                reward: 100,
                condition: (data) => data.trophies >= 51
            },
            reachGeneral: {
                name: '晋升将军',
                description: '达到将军段位',
                icon: '🎖️',
                category: 'rank',
                rarity: 'uncommon',
                reward: 200,
                condition: (data) => data.trophies >= 101
            },
            reachKnight: {
                name: '晋升骑士',
                description: '达到骑士段位',
                icon: '🏆',
                category: 'rank',
                rarity: 'rare',
                reward: 400,
                condition: (data) => data.trophies >= 151
            },
            reachEmperor: {
                name: '登基称帝',
                description: '达到帝王段位',
                icon: '👑',
                category: 'rank',
                rarity: 'epic',
                reward: 800,
                condition: (data) => data.trophies >= 201
            },
            trophyCollector: {
                name: '奖杯收集家',
                description: '获得100个奖杯',
                icon: '🏆',
                category: 'rank',
                rarity: 'uncommon',
                reward: 300,
                condition: (data) => data.trophies >= 100
            },
            trophyMaster: {
                name: '奖杯大师',
                description: '获得200个奖杯',
                icon: '🏆',
                category: 'rank',
                rarity: 'rare',
                reward: 600,
                condition: (data) => data.trophies >= 200
            }
        };

        // 匹配状态
        let matchmakingState = {
            isMatching: false,
            startTime: null,
            timer: null,
            mode: null
        };

        // 初始化所有系统（不显示界面）
        function initAllSystems() {
            console.log('初始化所有系统开始...');
            
            // 绑定阵营选择事件
            const factionCards = document.querySelectorAll('.faction-card');
            console.log('找到阵营卡片数量:', factionCards.length);
            factionCards.forEach((card, index) => {
                console.log(`绑定阵营卡片 ${index}:`, card.dataset.faction);
                card.addEventListener('click', selectFaction);
            });
            
            // 使用事件委托绑定所有按钮事件，确保按钮能正常工作
            document.addEventListener('click', (e) => {
                console.log('点击事件:', e.target.id, e.target.className);
                
                // 游戏控制按钮
                if (e.target.id === 'startGame') {
                    console.log('点击开始游戏按钮');
                    startGame();
                } else if (e.target.id === 'confirmPlay') {
                    console.log('点击确认出牌按钮');
                    confirmPlay();
                } else if (e.target.id === 'restartGame') {
                    console.log('点击重新开始按钮');
                    restartGame();
                } else if (e.target.id === 'shuffleHand') {
                    console.log('点击洗牌按钮');
                    shuffleHand();
                } else if (e.target.id === 'surrenderGame') {
                    console.log('点击认输按钮');
                    showSurrenderConfirm();
                }
                
                // 导航按钮事件
                else if (e.target.id === 'friendsBtn') {
                    console.log('点击好友按钮');
                    showFriendsScreen();
                } else if (e.target.id === 'battleBtn') {
                    console.log('点击对战按钮');
                    showBattleScreen();
                } else if (e.target.id === 'historyBtn') {
                    console.log('点击战绩按钮');
                    showHistoryScreen();
                } else if (e.target.id === 'achievementsBtn') {
                    console.log('点击成就按钮');
                    showAchievementsScreen();
                } else if (e.target.id === 'profileBtn') {
                    console.log('点击设置按钮');
                    showProfileScreen();
                }
                
                // 关闭按钮事件
                else if (e.target.id === 'closeFriends' || 
                         e.target.id === 'closeBattle' || 
                         e.target.id === 'closeHistory' || 
                         e.target.id === 'closeAchievements' || 
                         e.target.id === 'closeProfile') {
                    console.log('点击关闭按钮:', e.target.id);
                    showMainScreen();
                }
                
                // 登录和介绍界面按钮
                else if (e.target.id === 'enterGame') {
                    console.log('点击进入游戏按钮');
                    enterGame();
                } else if (e.target.id === 'continueToGame') {
                    console.log('点击继续游戏按钮');
                    continueToGame();
                }
            });
            
            // 绑定子系统事件
            try {
                initFriendsSystem();
                console.log('好友系统初始化完成');
            } catch (e) {
                console.error('好友系统初始化失败:', e);
            }
            
            try {
                initBattleSystem();
                console.log('对战系统初始化完成');
            } catch (e) {
                console.error('对战系统初始化失败:', e);
            }
            
            try {
                initProfileSystem();
                console.log('设置系统初始化完成');
            } catch (e) {
                console.error('设置系统初始化失败:', e);
            }
            
            try {
                initHistorySystem();
                console.log('历史战绩系统初始化完成');
            } catch (e) {
                console.error('历史战绩系统初始化失败:', e);
            }
            
            try {
                initLoginSystem();
                console.log('登录系统初始化完成');
            } catch (e) {
                console.error('登录系统初始化失败:', e);
            }
            
            console.log('所有系统初始化完成');
        }

        // 初始化游戏（显示登录界面）
        function initGame() {
            console.log('初始化游戏开始...');
            
            // 初始化所有系统
            initAllSystems();
            
            // 显示登录界面
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'none';
            
            // 更新用户信息显示
            updateUserDisplay();
            console.log('游戏初始化完成');
        }

        // 显示主界面
        function showMainScreen() {
            hideAllScreens();
            document.getElementById('introScreen').style.display = 'block';
            hideUserStatusBar(); // 介绍页面隐藏用户状态栏
            // 清除导航按钮的激活状态
            const navButtons = ['friendsBtn', 'battleBtn', 'historyBtn', 'achievementsBtn', 'profileBtn'];
            navButtons.forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('active');
            });
            showNotification('已返回主界面', 'info');
        }

        // 显示好友界面
        function showFriendsScreen() {
            hideAllScreens();
            document.getElementById('friendsScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            updateFriendsDisplay();
            updateActiveNavButton('friendsBtn');
        }

        // 显示对战界面
        function showBattleScreen() {
            hideAllScreens();
            document.getElementById('battleScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            updateBattleScreenRank();
            updateActiveNavButton('battleBtn');
        }

        // 更新对战界面段位显示
        function updateBattleScreenRank() {
            const currentRank = getCurrentRank(userData.trophies);
            const rankDisplay = document.getElementById('currentRankDisplay');
            if (rankDisplay) {
                rankDisplay.innerHTML = `当前段位: <span style="color: ${currentRank.color};">${currentRank.icon} ${currentRank.name}</span>`;
            }
        }

        // 显示历史战绩界面
        function showHistoryScreen() {
            hideAllScreens();
            document.getElementById('historyScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            updateHistoryDisplay();
            updateActiveNavButton('historyBtn');
        }

        // 显示成就界面
        function showAchievementsScreen() {
            hideAllScreens();
            document.getElementById('achievementsScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            updateAchievementsDisplay();
            updateActiveNavButton('achievementsBtn');
        }

        // 显示设置界面
        function showProfileScreen() {
            hideAllScreens();
            document.getElementById('profileScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            updateProfileDisplay();
            updateActiveNavButton('profileBtn');
        }

        // 更新导航按钮激活状态
        function updateActiveNavButton(activeId) {
            const navButtons = ['friendsBtn', 'battleBtn', 'historyBtn', 'achievementsBtn', 'profileBtn'];
            navButtons.forEach(id => {
                const btn = document.getElementById(id);
                if (id === activeId) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // 隐藏所有界面
        function hideAllScreens() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('friendsScreen').style.display = 'none';
            document.getElementById('battleScreen').style.display = 'none';
            document.getElementById('historyScreen').style.display = 'none';
            document.getElementById('achievementsScreen').style.display = 'none';
            document.getElementById('profileScreen').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'none';
            // 注意：不隐藏用户状态栏，让各个界面自己控制
        }

        // 更新用户信息显示
        function updateUserDisplay() {
            // 更新用户名显示
            const usernameElement = document.getElementById('currentUsername');
            if (usernameElement) {
                usernameElement.textContent = userData.username;
            }
            
            // 更新头像显示
            const avatarElements = document.querySelectorAll('.user-avatar');
            avatarElements.forEach(avatar => {
                avatar.textContent = userData.avatar;
            });
            
            // 更新用户状态栏显示等级、经验和金币
            const currentRank = getCurrentRank(userData.trophies);
            const userStats = document.querySelector('.user-stats');
            if (userStats) {
                userStats.innerHTML = `
                    <span style="color: ${currentRank.color};">${currentRank.icon} ${currentRank.name}</span>
                    <span>🏆 ${userData.trophies}</span>
                    <span>等级: ${userData.level}</span>
                    <span>胜场: <span id="userWins">${userData.wins}</span></span>
                    <span>败场: <span id="userLosses">${userData.losses}</span></span>
                    <span>在线: <span id="onlineCount">${Math.floor(Math.random() * 50) + 20}</span>人</span>
                `;
            }
        }

        // 显示用户状态栏
        function showUserStatusBar() {
            const statusBar = document.getElementById('userStatusBar');
            if (statusBar) {
                statusBar.style.display = 'flex';
            }
        }

        // 隐藏用户状态栏
        function hideUserStatusBar() {
            const statusBar = document.getElementById('userStatusBar');
            if (statusBar) {
                statusBar.style.display = 'none';
            }
        }

        // 初始化好友系统
        function initFriendsSystem() {
            // 标签页切换
            const tabButtons = document.querySelectorAll('.tab-btn');
            console.log('找到标签按钮数量:', tabButtons.length);
            tabButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabName = e.target.dataset.tab;
                    console.log('切换到标签:', tabName);
                    switchTab(tabName);
                });
            });
            
            // 搜索好友
            const searchBtn = document.getElementById('searchFriend');
            const friendInput = document.getElementById('friendUsername');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', searchFriend);
                console.log('绑定搜索好友按钮');
            } else {
                console.warn('未找到搜索好友按钮');
            }
            
            if (friendInput) {
                friendInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') searchFriend();
                });
                console.log('绑定好友输入框');
            } else {
                console.warn('未找到好友输入框');
            }
            
            // 绑定好友操作事件
            bindFriendActions();
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // 更新内容显示
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // 更新好友显示
        function updateFriendsDisplay() {
            updateFriendsList();
            updateFriendRequests();
        }

        // 更新好友列表
        function updateFriendsList() {
            const friendsList = document.querySelector('.friends-list');
            friendsList.innerHTML = '';
            
            userData.friends.forEach(friend => {
                const friendElement = document.createElement('div');
                friendElement.className = `friend-item ${friend.online ? 'online' : 'offline'}`;
                friendElement.innerHTML = `
                    <div class="friend-avatar">${friend.avatar}</div>
                    <div class="friend-info">
                        <div class="friend-name">${friend.name}</div>
                        <div class="friend-status">${friend.online ? '在线' : '离线'} - ${friend.status}</div>
                    </div>
                    <div class="friend-actions">
                        ${friend.online ? 
                            `<button class="btn-small challenge-btn" onclick="challengeFriend(${friend.id})">挑战</button>
                             <button class="btn-small chat-btn" onclick="chatWithFriend(${friend.id})">聊天</button>` :
                            `<button class="btn-small" disabled>离线</button>`
                        }
                    </div>
                `;
                friendsList.appendChild(friendElement);
            });
        }

        // 更新好友申请
        function updateFriendRequests() {
            const requestsList = document.querySelector('.friend-requests');
            const requestsContainer = requestsList.querySelector('div:last-child') || requestsList;
            
            // 清空现有申请（保留标题）
            const existingRequests = requestsList.querySelectorAll('.request-item');
            existingRequests.forEach(item => item.remove());
            
            userData.friendRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'request-item';
                requestElement.innerHTML = `
                    <div class="request-avatar">${request.avatar}</div>
                    <div class="request-info">
                        <div class="request-name">${request.name}</div>
                        <div class="request-time">${request.time}发送申请</div>
                    </div>
                    <div class="request-actions">
                        <button class="btn-small accept-btn" onclick="acceptFriendRequest(${request.id})">接受</button>
                        <button class="btn-small decline-btn" onclick="declineFriendRequest(${request.id})">拒绝</button>
                    </div>
                `;
                requestsList.appendChild(requestElement);
            });
        }

        // 绑定好友操作事件
        function bindFriendActions() {
            // 添加好友按钮
            document.querySelectorAll('.add-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const playerName = e.target.closest('.player-item').querySelector('.player-name').textContent;
                    addFriend(playerName);
                });
            });
        }

        // 搜索好友
        function searchFriend() {
            const username = document.getElementById('friendUsername').value.trim();
            const resultsContainer = document.getElementById('searchResults');
            
            if (!username) {
                resultsContainer.innerHTML = '<p style="text-align: center; opacity: 0.7;">请输入用户名进行搜索</p>';
                return;
            }
            
            // 模拟搜索结果
            resultsContainer.innerHTML = `
                <div class="player-item">
                    <div class="player-avatar">🎭</div>
                    <div class="player-info">
                        <div class="player-name">${username}</div>
                        <div class="player-level">等级 12 - 胜率 55%</div>
                    </div>
                    <button class="btn-small add-btn" onclick="addFriend('${username}')">添加</button>
                </div>
            `;
        }

        // 添加好友
        function addFriend(playerName) {
            showNotification(`已向 ${playerName} 发送好友申请！`, 'success');
        }

        // 挑战好友
        function challengeFriend(friendId) {
            const friend = userData.friends.find(f => f.id === friendId);
            showNotification(`已向 ${friend.name} 发送挑战邀请！`, 'info');
        }

        // 与好友聊天
        function chatWithFriend(friendId) {
            const friend = userData.friends.find(f => f.id === friendId);
            showNotification(`聊天功能开发中，敬请期待！`, 'info');
        }

        // 接受好友申请
        function acceptFriendRequest(requestId) {
            const request = userData.friendRequests.find(r => r.id === requestId);
            if (request) {
                // 添加到好友列表
                userData.friends.push({
                    id: request.id,
                    name: request.name,
                    avatar: request.avatar,
                    online: Math.random() > 0.5,
                    status: '刚刚上线'
                });
                
                // 从申请列表移除
                userData.friendRequests = userData.friendRequests.filter(r => r.id !== requestId);
                
                updateFriendsDisplay();
                showNotification(`已添加 ${request.name} 为好友！`, 'success');
            }
        }

        // 拒绝好友申请
        function declineFriendRequest(requestId) {
            const request = userData.friendRequests.find(r => r.id === requestId);
            if (request) {
                userData.friendRequests = userData.friendRequests.filter(r => r.id !== requestId);
                updateFriendsDisplay();
                showNotification(`已拒绝 ${request.name} 的好友申请`, 'info');
            }
        }

        // 初始化对战系统
        function initBattleSystem() {
            // 对战模式选择
            const modeCards = document.querySelectorAll('.mode-card');
            console.log('找到对战模式卡片数量:', modeCards.length);
            modeCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    const mode = e.currentTarget.dataset.mode;
                    console.log('选择对战模式:', mode);
                    selectBattleMode(mode);
                });
            });
            
            // 匹配控制
            const cancelBtn = document.getElementById('cancelMatch');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', cancelMatching);
                console.log('绑定取消匹配按钮');
            }
            
            // 自定义房间
            const createBtn = document.getElementById('createRoom');
            const joinBtn = document.getElementById('joinRoom');
            const roomInput = document.getElementById('roomCode');
            
            if (createBtn) {
                createBtn.addEventListener('click', createRoom);
                console.log('绑定创建房间按钮');
            }
            
            if (joinBtn) {
                joinBtn.addEventListener('click', joinRoom);
                console.log('绑定加入房间按钮');
            }
            
            if (roomInput) {
                roomInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') joinRoom();
                });
                console.log('绑定房间码输入框');
            }
        }

        // 选择对战模式
        function selectBattleMode(mode) {
            matchmakingState.mode = mode;
            
            if (mode === 'custom') {
                document.getElementById('customRoomPanel').style.display = 'block';
                document.getElementById('matchmakingPanel').style.display = 'none';
            } else if (mode === 'ai') {
                // AI对战模式直接进入阵营选择
                document.getElementById('customRoomPanel').style.display = 'none';
                document.getElementById('matchmakingPanel').style.display = 'none';
                showNotification('正在准备AI对战...', 'info');
                
                setTimeout(() => {
                    startGameWithMode('ai');
                }, 1500);
            } else {
                document.getElementById('customRoomPanel').style.display = 'none';
                startMatching(mode);
            }
        }

        // 开始匹配
        function startMatching(mode) {
            matchmakingState.isMatching = true;
            matchmakingState.startTime = Date.now();
            
            document.getElementById('matchmakingPanel').style.display = 'block';
            
            const modeNames = {
                ranked: '排位赛',
                casual: '休闲模式',
                ai: 'AI对战'
            };
            
            document.querySelector('.matching-text').textContent = `正在匹配${modeNames[mode]}对手...`;
            
            // 开始计时
            matchmakingState.timer = setInterval(updateMatchingTime, 1000);
            
            // 模拟匹配成功（5-15秒后）
            setTimeout(() => {
                if (matchmakingState.isMatching) {
                    matchFound();
                }
            }, Math.random() * 10000 + 5000);
        }

        // 更新匹配时间
        function updateMatchingTime() {
            if (!matchmakingState.isMatching) return;
            
            const elapsed = Math.floor((Date.now() - matchmakingState.startTime) / 1000);
            document.getElementById('waitTime').textContent = elapsed;
        }

        // 取消匹配
        function cancelMatching() {
            matchmakingState.isMatching = false;
            if (matchmakingState.timer) {
                clearInterval(matchmakingState.timer);
                matchmakingState.timer = null;
            }
            
            document.getElementById('matchmakingPanel').style.display = 'none';
            showNotification('已取消匹配', 'info');
        }

        // 匹配成功
        function matchFound() {
            matchmakingState.isMatching = false;
            if (matchmakingState.timer) {
                clearInterval(matchmakingState.timer);
                matchmakingState.timer = null;
            }
            
            const mode = matchmakingState.mode;
            
            if (mode === 'ai') {
                showNotification('找到AI对手！准备进入游戏...', 'success');
                
                setTimeout(() => {
                    document.getElementById('matchmakingPanel').style.display = 'none';
                    startGameWithMode('ai');
                }, 2000);
            } else if (mode === 'ranked') {
                // 模拟找到排位赛对手
                const opponentData = generateRankedOpponent();
                showNotification(`找到排位赛对手：${opponentData.name}！`, 'success');
                
                setTimeout(() => {
                    document.getElementById('matchmakingPanel').style.display = 'none';
                    startGameWithMode('ranked', opponentData);
                }, 2000);
            } else if (mode === 'casual') {
                // 模拟找到休闲模式对手
                const opponentData = generateCasualOpponent();
                showNotification(`找到休闲对手：${opponentData.name}！`, 'success');
                
                setTimeout(() => {
                    document.getElementById('matchmakingPanel').style.display = 'none';
                    startGameWithMode('casual', opponentData);
                }, 2000);
            }
        }

        // 生成排位赛对手
        function generateRankedOpponent() {
            const currentRank = getCurrentRank(userData.trophies);
            const trophyRange = 20; // 奖杯范围
            
            // 根据当前段位生成相近实力的对手
            const minTrophies = Math.max(0, userData.trophies - trophyRange);
            const maxTrophies = userData.trophies + trophyRange;
            const opponentTrophies = Math.floor(Math.random() * (maxTrophies - minTrophies + 1)) + minTrophies;
            const opponentRank = getCurrentRank(opponentTrophies);
            
            // 排位赛对手名称池
            const rankedNames = [
                '钢铁骑士', '暗影刺客', '圣光守护', '烈焰法师', '冰霜战士',
                '雷电术士', '大地守卫', '风暴领主', '光明使者', '黑暗君主',
                '龙血战士', '凤凰法师', '狼王猎手', '熊王战士', '鹰眼射手'
            ];
            
            return {
                name: rankedNames[Math.floor(Math.random() * rankedNames.length)],
                trophies: opponentTrophies,
                rank: opponentRank,
                avatar: ['⚔️', '🛡️', '🏹', '🔥', '❄️', '⚡', '🌪️', '🌟', '🌙'][Math.floor(Math.random() * 9)],
                difficulty: calculateOpponentDifficulty(opponentTrophies),
                isRanked: true
            };
        }

        // 生成休闲模式对手
        function generateCasualOpponent() {
            // 休闲模式对手名称池
            const casualNames = [
                '新手村长', '练习伙伴', '友善玩家', '路过高手', '热心教练',
                '随机路人', '业余选手', '周末战士', '咖啡厅常客', '公园棋友',
                '邻家大叔', '学生会长', '图书管理员', '面包师傅', '花店老板'
            ];
            
            // 休闲模式难度更随机，不完全基于段位
            const difficultyOptions = ['easy', 'normal', 'hard'];
            const selectedDifficulty = difficultyOptions[Math.floor(Math.random() * difficultyOptions.length)];
            
            return {
                name: casualNames[Math.floor(Math.random() * casualNames.length)],
                trophies: Math.floor(Math.random() * 200), // 随机奖杯数
                rank: null, // 休闲模式不显示段位
                avatar: ['😊', '🤗', '😎', '🤓', '😋', '🙂', '😌', '🤔', '😄'][Math.floor(Math.random() * 9)],
                difficulty: selectedDifficulty,
                isRanked: false
            };
        }

        // 计算对手难度
        function calculateOpponentDifficulty(opponentTrophies) {
            const playerTrophies = userData.trophies;
            const diff = opponentTrophies - playerTrophies;
            
            if (diff >= 30) return 'hard';
            if (diff >= 10) return 'normal';
            if (diff <= -30) return 'easy';
            if (diff <= -10) return 'easy';
            return 'normal';
        }

        // 根据模式开始游戏
        function startGameWithMode(mode, opponentData = null) {
            // 保存游戏模式信息
            gameState.gameMode = mode;
            gameState.opponentData = opponentData || {
                name: 'AI对手',
                difficulty: 'normal',
                isRanked: false
            };
            
            // 显示游戏设置界面
            hideAllScreens();
            document.getElementById('setupScreen').style.display = 'block';
            
            // 更新设置界面标题显示当前模式
            const setupTitle = document.querySelector('#setupScreen h2');
            if (mode === 'ranked') {
                setupTitle.innerHTML = `🏆 排位赛 - VS ${opponentData.name}`;
                setupTitle.style.color = '#ff6b35';
                
                // 显示对手信息
                showOpponentInfo(opponentData);
            } else if (mode === 'casual') {
                setupTitle.innerHTML = `🎮 休闲模式 - VS ${opponentData.name}`;
                setupTitle.style.color = '#3b82f6';
                
                // 显示对手信息
                showOpponentInfo(opponentData);
            } else {
                setupTitle.innerHTML = `🤖 AI对战`;
                setupTitle.style.color = '#d4af37';
            }
            
            showNotification(`${getModeDisplayName(mode)}开始！选择你的阵营`, 'success');
        }

        // 显示对手信息
        function showOpponentInfo(opponentData) {
            // 检查是否已存在对手信息面板
            let opponentInfoPanel = document.getElementById('opponentInfoPanel');
            
            if (!opponentInfoPanel) {
                // 创建对手信息面板
                opponentInfoPanel = document.createElement('div');
                opponentInfoPanel.id = 'opponentInfoPanel';
                opponentInfoPanel.style.cssText = `
                    background: rgba(0,0,0,0.3);
                    border: 2px solid #8b4513;
                    border-radius: 15px;
                    padding: 20px;
                    margin: 20px 0;
                    text-align: center;
                `;
                
                // 插入到阵营选择之前
                const factionSelection = document.querySelector('.faction-selection');
                factionSelection.parentNode.insertBefore(opponentInfoPanel, factionSelection);
            }
            
            const difficultyColors = {
                easy: '#10b981',
                normal: '#f59e0b', 
                hard: '#ef4444'
            };
            
            const difficultyNames = {
                easy: '简单',
                normal: '普通',
                hard: '困难'
            };
            
            opponentInfoPanel.innerHTML = `
                <h3 style="color: #d4af37; margin-bottom: 15px;">对手信息</h3>
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px;">
                    <div style="font-size: 3rem;">${opponentData.avatar}</div>
                    <div style="text-align: left;">
                        <div style="font-size: 1.3rem; font-weight: bold; color: #f4e4bc; margin-bottom: 5px;">
                            ${opponentData.name}
                        </div>
                        ${opponentData.isRanked ? `
                            <div style="font-size: 1rem; color: ${opponentData.rank.color}; margin-bottom: 3px;">
                                ${opponentData.rank.icon} ${opponentData.rank.name}
                            </div>
                            <div style="font-size: 0.9rem; opacity: 0.8;">
                                🏆 ${opponentData.trophies} 奖杯
                            </div>
                        ` : `
                            <div style="font-size: 1rem; opacity: 0.8; margin-bottom: 3px;">
                                休闲玩家
                            </div>
                        `}
                        <div style="font-size: 0.9rem; color: ${difficultyColors[opponentData.difficulty]}; margin-top: 5px;">
                            难度: ${difficultyNames[opponentData.difficulty]}
                        </div>
                    </div>
                </div>
                
                ${opponentData.isRanked ? `
                    <div style="background: rgba(212,175,55,0.1); padding: 10px; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            <div style="margin-bottom: 5px;">📊 排位赛规则：</div>
                            <div style="font-size: 0.8rem; line-height: 1.4;">
                                • 胜利 +5~8 奖杯 | 失败 -3~5 奖杯<br>
                                • 连胜有额外奖杯奖励<br>
                                • 影响段位排名
                            </div>
                        </div>
                    </div>
                ` : `
                    <div style="background: rgba(59,130,246,0.1); padding: 10px; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 0.9rem; opacity: 0.9;">
                            <div style="margin-bottom: 5px;">🎮 休闲模式：</div>
                            <div style="font-size: 0.8rem; line-height: 1.4;">
                                • 不影响段位排名<br>
                                • 轻松对战，练习技巧<br>
                                • 仍可获得经验和金币
                            </div>
                        </div>
                    </div>
                `}
            `;
        }

        // 获取模式显示名称
        function getModeDisplayName(mode) {
            const modeNames = {
                'ranked': '排位赛',
                'casual': '休闲模式',
                'ai': 'AI对战',
                'custom': '自定义房间'
            };
            return modeNames[mode] || '未知模式';
        }

        // 创建房间
        function createRoom() {
            const roomCode = Math.floor(Math.random() * 900000) + 100000;
            showNotification(`房间创建成功！房间码: ${roomCode}`, 'success');
        }

        // 加入房间
        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!roomCode) {
                showNotification('请输入房间码', 'error');
                return;
            }
            
            if (roomCode.length !== 6) {
                showNotification('房间码必须是6位数字', 'error');
                return;
            }
            
            showNotification(`正在加入房间 ${roomCode}...`, 'info');
            
            setTimeout(() => {
                showNotification('房间不存在或已满员', 'error');
            }, 2000);
        }

        // 初始化设置系统
        function initProfileSystem() {
            const saveBtn = document.getElementById('saveProfile');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveProfile);
                console.log('绑定保存设置按钮');
            } else {
                console.warn('未找到保存设置按钮');
            }
            
            // 头像选择功能
            document.addEventListener('click', (e) => {
                // 更换头像按钮
                if (e.target.closest('.avatar-section .btn-small')) {
                    toggleAvatarGallery();
                }
                
                // 头像选择
                if (e.target.classList.contains('avatar-option-profile')) {
                    selectProfileAvatar(e.target.dataset.avatar);
                }
            });
            
            // 偏好设置变化监听
            document.addEventListener('change', (e) => {
                if (e.target.id === 'preferredFaction' || 
                    e.target.id === 'preferredOpening' || 
                    e.target.id === 'gameStyle') {
                    updateUserPreferences();
                }
            });
        }
        
        // 切换头像选择器
        function toggleAvatarGallery() {
            const gallery = document.getElementById('avatarGallery');
            const isVisible = gallery.style.display !== 'none';
            
            if (isVisible) {
                gallery.style.display = 'none';
            } else {
                gallery.style.display = 'block';
                // 高亮当前头像
                document.querySelectorAll('.avatar-option-profile').forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.avatar === userData.avatar) {
                        option.classList.add('selected');
                    }
                });
            }
        }
        
        // 选择头像
        function selectProfileAvatar(avatar) {
            userData.avatar = avatar;
            updateAvatarDisplay();
            
            // 更新选择状态
            document.querySelectorAll('.avatar-option-profile').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.avatar === avatar) {
                    option.classList.add('selected');
                }
            });
            
            // 隐藏头像选择器
            document.getElementById('avatarGallery').style.display = 'none';
            
            showNotification('头像已更换！', 'success');
            console.log('更换头像:', avatar);
        }
        
        // 更新用户偏好
        function updateUserPreferences() {
            if (!userData.preferences) {
                userData.preferences = {};
            }
            
            userData.preferences.faction = document.getElementById('preferredFaction')?.value || 'none';
            userData.preferences.opening = document.getElementById('preferredOpening')?.value || 'none';
            userData.preferences.gameStyle = document.getElementById('gameStyle')?.value || 'balanced';
            
            // 自动保存偏好设置
            saveUserData();
            showNotification('偏好设置已保存！', 'success');
        }

        // 更新设置显示
        function updateProfileDisplay() {
            document.getElementById('usernameInput').value = userData.username;
            document.getElementById('signatureInput').value = userData.signature || '';
            updateAvatarDisplay();
            updateStatsDisplay();
            updateRankDisplay();
            updatePersonalInfo();
            updatePersonalBadges();
            updatePreferenceSettings();
        }
        
        // 更新个人信息显示
        function updatePersonalInfo() {
            // 注册时间
            const registerTime = document.getElementById('registerTime');
            if (registerTime) {
                const regDate = userData.registerDate || Date.now();
                registerTime.textContent = new Date(regDate).toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long'
                });
            }
            
            // 最后登录
            const lastLogin = document.getElementById('lastLogin');
            if (lastLogin) {
                lastLogin.textContent = '刚刚';
            }
            
            // 游戏ID
            const gameId = document.getElementById('gameId');
            if (gameId) {
                const id = userData.gameId || Math.floor(Math.random() * 900000) + 100000;
                userData.gameId = id; // 保存生成的ID
                gameId.textContent = `#${id}`;
            }
        }
        
        // 更新个人成就徽章
        function updatePersonalBadges() {
            const badgesContainer = document.getElementById('personalBadges');
            if (!badgesContainer) return;
            
            badgesContainer.innerHTML = '';
            
            // 获取已解锁的重要成就
            const importantAchievements = [
                'firstWin', 'winStreak5', 'winStreak10', 'totalGames25', 
                'kingMaster', 'slaveMaster', 'perfectRecord', 'reachKnight'
            ];
            
            const unlockedBadges = importantAchievements.filter(key => 
                userData.achievements && userData.achievements[key]
            );
            
            if (unlockedBadges.length === 0) {
                badgesContainer.innerHTML = `
                    <div style="text-align: center; opacity: 0.7; width: 100%; padding: 20px;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">🏆</div>
                        <div>暂无成就徽章</div>
                        <div style="font-size: 0.8rem; margin-top: 5px;">完成游戏获得你的第一个徽章！</div>
                    </div>
                `;
                return;
            }
            
            unlockedBadges.forEach(key => {
                const achievement = achievementDefinitions[key];
                if (!achievement) return;
                
                const badge = document.createElement('div');
                badge.className = `achievement-badge ${achievement.rarity === 'legendary' ? 'legendary' : ''}`;
                badge.innerHTML = `
                    <span style="font-size: 1.2rem;">${achievement.icon}</span>
                    <span>${achievement.name}</span>
                `;
                badge.title = achievement.description;
                badgesContainer.appendChild(badge);
            });
        }
        
        // 更新偏好设置
        function updatePreferenceSettings() {
            if (!userData.preferences) {
                userData.preferences = {
                    faction: 'none',
                    opening: 'none',
                    gameStyle: 'balanced'
                };
            }
            
            const factionSelect = document.getElementById('preferredFaction');
            const openingSelect = document.getElementById('preferredOpening');
            const styleSelect = document.getElementById('gameStyle');
            
            if (factionSelect) factionSelect.value = userData.preferences.faction || 'none';
            if (openingSelect) openingSelect.value = userData.preferences.opening || 'none';
            if (styleSelect) styleSelect.value = userData.preferences.gameStyle || 'balanced';
        }

        // 更新段位显示
        function updateRankDisplay() {
            const currentRank = getCurrentRank(userData.trophies);
            const rankInfo = document.getElementById('currentRankInfo');
            if (rankInfo) {
                const progressPercent = currentRank.name === '帝王' ? 100 : currentRank.progress;
                const nextRankTrophies = currentRank.name === '帝王' ? '∞' : currentRank.max + 1;
                
                rankInfo.innerHTML = `
                    <div style="color: ${currentRank.color}; font-size: 1.5rem; margin-bottom: 8px;">
                        ${currentRank.icon} ${currentRank.name}
                    </div>
                    <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">
                        ${currentRank.description}
                    </div>
                    <div style="font-size: 0.9rem; margin-bottom: 8px;">
                        🏆 ${userData.trophies} / ${currentRank.max === 999 ? '∞' : currentRank.max}
                    </div>
                    ${currentRank.name !== '帝王' ? `
                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 5px; margin-bottom: 5px;">
                            <div style="background: ${currentRank.color}; height: 6px; border-radius: 3px; width: ${progressPercent}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">
                            距离下一段位还需 ${Math.max(0, currentRank.max + 1 - userData.trophies)} 奖杯
                        </div>
                    ` : `
                        <div style="font-size: 0.8rem; opacity: 0.7; color: #ffd700;">
                            ✨ 已达到最高段位 ✨
                        </div>
                    `}
                `;
            }
        }

        // 更新头像显示
        function updateAvatarDisplay() {
            document.querySelector('.user-avatar').textContent = userData.avatar;
            document.querySelector('.large-avatar').textContent = userData.avatar;
        }

        // 更新统计显示
        function updateStatsDisplay() {
            const totalGames = userData.wins + userData.losses;
            const winRate = totalGames > 0 ? Math.round((userData.wins / totalGames) * 100) : 0;
            const currentRank = getCurrentRank(userData.trophies);
            
            document.querySelectorAll('.stat-number')[0].textContent = totalGames;
            document.querySelectorAll('.stat-number')[1].textContent = userData.wins;
            document.querySelectorAll('.stat-number')[2].textContent = winRate + '%';
            document.querySelectorAll('.stat-number')[3].textContent = `${currentRank.icon} ${currentRank.name}`;
        }

        // 保存设置
        function saveProfile() {
            const newUsername = document.getElementById('usernameInput').value.trim();
            const newSignature = document.getElementById('signatureInput').value.trim();
            
            // 验证用户名
            if (newUsername.length < 2 || newUsername.length > 12) {
                showNotification('用户名长度必须在2-12个字符之间！', 'error');
                return;
            }
            
            // 验证个性签名
            if (newSignature.length > 50) {
                showNotification('个性签名不能超过50个字符！', 'error');
                return;
            }
            
            // 检查用户名是否有变化
            const usernameChanged = userData.username !== newUsername;
            
            userData.username = newUsername;
            userData.signature = newSignature;
            
            // 确保注册时间存在
            if (!userData.registerDate) {
                userData.registerDate = Date.now();
            }
            
            // 保存到本地存储
            saveUserData();
            
            updateUserDisplay();
            
            if (usernameChanged) {
                showNotification('用户名和设置已保存！', 'success');
            } else {
                showNotification('设置已保存！', 'success');
            }
            
            // 更新个人信息显示
            updatePersonalInfo();
        }

        // 初始化历史战绩系统
        function initHistorySystem() {
            // 使用事件委托来处理动态生成的按钮
            document.addEventListener('click', (e) => {
                // 筛选器事件
                if (e.target.classList.contains('filter-btn')) {
                    const filter = e.target.dataset.filter;
                    console.log('设置历史筛选器:', filter);
                    setHistoryFilter(filter);
                }
                
                // 成就分类筛选事件
                if (e.target.classList.contains('category-filter')) {
                    const category = e.target.dataset.category;
                    console.log('设置成就分类:', category);
                    setAchievementCategory(category);
                }
            });
            
            // 初始化成就数据
            initializeAchievements();
            
            console.log('历史战绩系统事件委托已设置');
        }
        
        // 初始化成就数据
        function initializeAchievements() {
            // 确保成就对象存在
            if (!userData.achievements) {
                userData.achievements = {};
            }
            
            // 检查并解锁初始成就
            checkAchievements();
        }

        // 更新历史战绩显示
        function updateHistoryDisplay() {
            updateHistorySummary();
            updateBattleHistoryList();
            // 移除成就更新，成就系统独立管理
        }

        // 更新战绩概览
        function updateHistorySummary() {
            const totalGames = userData.wins + userData.losses;
            const winRate = totalGames > 0 ? Math.round((userData.wins / totalGames) * 100) : 0;
            const avgDuration = userData.battleHistory.length > 0 ? 
                Math.round(userData.battleHistory.reduce((sum, battle) => sum + battle.duration, 0) / userData.battleHistory.length / 60) : 0;

            document.getElementById('totalGamesCount').textContent = totalGames;
            document.getElementById('totalWinsCount').textContent = userData.wins;
            document.getElementById('totalLossesCount').textContent = userData.losses;
            document.getElementById('winRateDisplay').textContent = winRate + '%';
            document.getElementById('winStreakCount').textContent = userData.stats.currentWinStreak;
            document.getElementById('avgDurationDisplay').textContent = avgDuration + '分';
        }

        // 更新战斗记录列表
        function updateBattleHistoryList(filter = 'all') {
            const historyList = document.getElementById('battleHistoryList');
            let filteredHistory = [...userData.battleHistory];

            // 应用筛选器
            if (filter === 'victory') {
                filteredHistory = filteredHistory.filter(battle => battle.result === 'victory');
            } else if (filter === 'defeat') {
                filteredHistory = filteredHistory.filter(battle => battle.result === 'defeat');
            } else if (filter === 'king') {
                filteredHistory = filteredHistory.filter(battle => battle.playerFaction === 'king');
            } else if (filter === 'slave') {
                filteredHistory = filteredHistory.filter(battle => battle.playerFaction === 'slave');
            } else if (filter === 'recent') {
                const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
                filteredHistory = filteredHistory.filter(battle => battle.date > weekAgo);
            }

            // 按时间倒序排列
            filteredHistory.sort((a, b) => b.date - a.date);

            if (filteredHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="no-records">
                        <div class="no-records-icon">⚔️</div>
                        <h3>暂无符合条件的战斗记录</h3>
                        <p>尝试调整筛选条件或开始新的战斗！</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = '';
            filteredHistory.forEach(battle => {
                const battleElement = createBattleRecordElement(battle);
                historyList.appendChild(battleElement);
            });
        }

        // 创建战斗记录元素
        function createBattleRecordElement(battle) {
            const element = document.createElement('div');
            element.className = `battle-record ${battle.result}`;
            
            const date = new Date(battle.date);
            const dateStr = date.toLocaleDateString('zh-CN', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const durationStr = Math.floor(battle.duration / 60) + '分' + (battle.duration % 60) + '秒';
            
            element.innerHTML = `
                <div class="record-result">
                    <div class="result-icon ${battle.result}">
                        ${battle.result === 'victory' ? '🏆' : '💔'}
                    </div>
                    <div class="record-info">
                        <div class="record-opponent">VS ${battle.opponent}</div>
                        <div class="record-details">
                            <span class="faction-badge-small">${battle.playerFaction === 'king' ? '👑 国王方' : '⚔️ 奴隶方'}</span>
                            <span>第${battle.turns}回合</span>
                            <span>${battle.mode}</span>
                        </div>
                    </div>
                </div>
                <div class="record-meta">
                    <div class="record-date">${dateStr}</div>
                    <div class="record-duration">${durationStr}</div>
                </div>
            `;
            
            return element;
        }

        // 设置历史筛选器
        function setHistoryFilter(filter) {
            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // 更新列表
            updateBattleHistoryList(filter);
        }

        // 独立更新成就显示
        function updateAchievementsDisplay(category = 'all') {
            updateAchievementStats();
            
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) {
                console.warn('成就列表元素未找到');
                return;
            }
            
            achievementsList.innerHTML = '';
            
            let filteredAchievements = Object.keys(achievementDefinitions);
            
            // 应用分类筛选
            if (category !== 'all') {
                if (category === 'unlocked') {
                    filteredAchievements = filteredAchievements.filter(key => userData.achievements[key]);
                } else {
                    filteredAchievements = filteredAchievements.filter(key => 
                        achievementDefinitions[key].category === category);
                }
            }
            
            // 按稀有度和解锁状态排序
            filteredAchievements.sort((a, b) => {
                const achA = achievementDefinitions[a];
                const achB = achievementDefinitions[b];
                const unlockedA = userData.achievements[a];
                const unlockedB = userData.achievements[b];
                
                // 已解锁的排在前面
                if (unlockedA && !unlockedB) return -1;
                if (!unlockedA && unlockedB) return 1;
                
                // 按稀有度排序
                const rarityOrder = { common: 1, uncommon: 2, rare: 3, epic: 4, legendary: 5 };
                return rarityOrder[achA.rarity] - rarityOrder[achB.rarity];
            });
            
            filteredAchievements.forEach(key => {
                const achievement = achievementDefinitions[key];
                const isUnlocked = userData.achievements[key];
                const progress = getAchievementProgress(key);
                
                const element = document.createElement('div');
                element.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                element.innerHTML = `
                    <div class="achievement-rarity rarity-${achievement.rarity}">${achievement.rarity}</div>
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-info">
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.description}</div>
                        ${progress ? `<div class="achievement-progress">${progress}</div>` : ''}
                        <div class="achievement-reward">
                            💰 ${achievement.reward} 金币 | 🌟 ${Math.floor(achievement.reward / 10)} 经验
                        </div>
                    </div>
                `;
                
                achievementsList.appendChild(element);
            });
            
            if (filteredAchievements.length === 0) {
                achievementsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; opacity: 0.7; grid-column: 1 / -1;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">🏆</div>
                        <h3>暂无符合条件的成就</h3>
                        <p>尝试切换其他分类查看更多成就！</p>
                    </div>
                `;
            }
        }
        
        // 更新成就统计
        function updateAchievementStats() {
            const totalAchievements = Object.keys(achievementDefinitions).length;
            const unlockedAchievements = Object.keys(userData.achievements).filter(key => userData.achievements[key]).length;
            const completionRate = totalAchievements > 0 ? Math.round((unlockedAchievements / totalAchievements) * 100) : 0;
            const totalRewards = Object.keys(userData.achievements)
                .filter(key => userData.achievements[key])
                .reduce((sum, key) => sum + (achievementDefinitions[key] ? achievementDefinitions[key].reward : 0), 0);
            
            const unlockedElement = document.getElementById('unlockedCount');
            const totalElement = document.getElementById('totalAchievements');
            const rateElement = document.getElementById('completionRate');
            const rewardsElement = document.getElementById('totalRewards');
            
            if (unlockedElement) unlockedElement.textContent = unlockedAchievements;
            if (totalElement) totalElement.textContent = totalAchievements;
            if (rateElement) rateElement.textContent = completionRate + '%';
            if (rewardsElement) rewardsElement.textContent = totalRewards;
        }
        
        // 设置成就分类筛选
        function setAchievementCategory(category) {
            // 更新按钮状态
            document.querySelectorAll('.category-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetBtn = document.querySelector(`[data-category="${category}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // 更新成就显示
            updateAchievementsDisplay(category);
        }

        // 获取成就进度
        function getAchievementProgress(achievementKey) {
            const totalGames = userData.wins + userData.losses;
            
            switch (achievementKey) {
                case 'winStreak5':
                    return `当前连胜: ${userData.stats.currentWinStreak}/5`;
                case 'winStreak10':
                    return `当前连胜: ${userData.stats.currentWinStreak}/10`;
                case 'totalGames10':
                    return `进度: ${totalGames}/10`;
                case 'totalGames50':
                    return `进度: ${totalGames}/50`;
                case 'kingMaster':
                    return `国王方胜利: ${userData.stats.kingWins}/10`;
                case 'slaveMaster':
                    return `奴隶方胜利: ${userData.stats.slaveWins}/10`;
                case 'perfectRecord':
                    if (totalGames >= 10) {
                        const winRate = Math.round((userData.wins / totalGames) * 100);
                        return `当前胜率: ${winRate}%/80%`;
                    } else {
                        return `需要至少10场对战 (${totalGames}/10)`;
                    }
                default:
                    return null;
            }
        }

        // 检查并解锁成就
        function checkAchievements() {
            let newAchievements = [];
            
            Object.keys(achievementDefinitions).forEach(key => {
                if (!userData.achievements[key]) {
                    const achievement = achievementDefinitions[key];
                    if (achievement.condition(userData)) {
                        userData.achievements[key] = true;
                        newAchievements.push({ key, ...achievement });
                        
                        // 给予奖励
                        userData.coins += achievement.reward;
                        userData.experience += Math.floor(achievement.reward / 10);
                        
                        // 检查等级提升
                        checkLevelUp();
                    }
                }
            });
            
            // 显示新解锁的成就
            newAchievements.forEach((achievement, index) => {
                setTimeout(() => {
                    showAchievementNotification(achievement);
                }, index * 1000); // 每个成就间隔1秒显示
            });
            
            return newAchievements.length > 0;
        }
        
        // 显示成就解锁通知
        function showAchievementNotification(achievement) {
            const notification = document.createElement('div');
            notification.className = 'achievement-notification';
            
            notification.innerHTML = `
                <div class="notification-icon">${achievement.icon}</div>
                <div class="notification-title">🏅 成就解锁！</div>
                <div class="notification-desc">${achievement.name}</div>
                <div style="margin-top: 10px; font-size: 0.8rem;">
                    +${achievement.reward} 金币 | +${Math.floor(achievement.reward / 10)} 经验
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 4000);
        }
        
        // 检查等级提升
        function checkLevelUp() {
            const requiredExp = userData.level * 100; // 每级需要 等级*100 经验
            if (userData.experience >= requiredExp) {
                userData.level++;
                userData.experience -= requiredExp;
                showNotification(`🎉 等级提升！现在是 ${userData.level} 级！`, 'success');
                
                // 等级提升奖励
                userData.coins += userData.level * 50;
                showNotification(`💰 等级奖励：${userData.level * 50} 金币`, 'success');
            }
        }
        
        // 刺客抽取手牌刺杀功能
        function assassinateRandomHandCard(targetHand, targetType) {
            if (targetHand.length === 0) {
                return `但${targetType === 'player' ? '你' : '对手'}没有手牌可以刺杀！`;
            }
            
            // 随机选择一张手牌
            const randomIndex = Math.floor(Math.random() * targetHand.length);
            const killedCard = targetHand[randomIndex];
            const killedCardData = cardData[killedCard];
            
            // 从手牌中移除被刺杀的牌
            targetHand.splice(randomIndex, 1);
            
            // 特殊处理：如果刺杀的是关键牌，给予额外描述
            if (killedCardData.type === 'key') {
                return `💀 刺中要害！${targetType === 'player' ? '你的' : '对手的'}${killedCardData.name}被暗杀！`;
            } else {
                return `🗡️ 暗影一击！${targetType === 'player' ? '你的' : '对手的'}${killedCardData.name}被刺杀！`;
            }
        }

        // AI刺客选择策略
        function makeAIAssassinChoice(playerCard, playerCardData, playerHand) {
            // 1. 如果玩家出的是关键牌，优先刺杀眼前的牌
            if (playerCardData.type === 'key') {
                return 'field';
            }
            
            // 2. 检查玩家手牌中是否有关键牌
            const hasKeyInHand = playerHand.some(card => cardData[card].type === 'key');
            
            // 3. 如果手牌中有关键牌，70%概率选择抽取手牌
            if (hasKeyInHand && Math.random() > 0.3) {
                return 'hand';
            }
            
            // 4. 如果玩家出的是高等级牌(3级)，60%概率刺杀眼前
            if (playerCardData.level >= 3 && Math.random() > 0.4) {
                return 'field';
            }
            
            // 5. 如果玩家出的是低等级牌，更倾向于抽取手牌
            if (playerCardData.level <= 1 && Math.random() > 0.3) {
                return 'hand';
            }
            
            // 6. 默认随机选择
            return Math.random() > 0.5 ? 'field' : 'hand';
        }

        // 更新特殊统计数据
        function updateSpecialStats(playerCard, opponentCard, playerWon, battleResult) {
            // 记录卡牌使用
            if (userData.stats.cardUsage[playerCard] !== undefined) {
                userData.stats.cardUsage[playerCard]++;
            }
            
            // 特殊击杀统计
            if (playerWon) {
                if (playerCard === 'assassin') {
                    userData.stats.assassinKills = (userData.stats.assassinKills || 0) + 1;
                }
                if (playerCard === 'slave' && (opponentCard === 'king' || opponentCard === 'queen')) {
                    userData.stats.slaveKills = (userData.stats.slaveKills || 0) + 1;
                }
            }
            
            // 刺客额外击杀统计（包括手牌刺杀）
            if (playerCard === 'assassin' && battleResult.includes('刺杀')) {
                userData.stats.assassinKills = (userData.stats.assassinKills || 0) + 1;
            }
            
            // 屠夫同归于尽
            if (playerCard === 'butcher' && battleResult.includes('同归于尽')) {
                userData.stats.butcherKills = (userData.stats.butcherKills || 0) + 1;
            }
            
            // 皇家守卫保护
            if (gameState.specialEffects.kingImmune && playerCard === 'king') {
                userData.stats.guardProtections = (userData.stats.guardProtections || 0) + 1;
            }
        }
        
        // 检查逆转成就
        function checkComeback(result) {
            if (result === 'victory' && userData.stats.currentLossStreak >= 3) {
                userData.stats.comebacks = (userData.stats.comebacks || 0) + 1;
            }
        }

        // 添加战斗记录
        function addBattleRecord(result, opponent, playerFaction, turns, duration, mode = '单机模式') {
            const battleRecord = {
                id: Date.now(),
                date: Date.now(),
                result: result,
                opponent: opponent,
                playerFaction: playerFaction,
                turns: turns,
                duration: duration,
                mode: mode
            };
            
            userData.battleHistory.unshift(battleRecord);
            
            // 更新统计数据
            userData.stats.totalPlayTime += duration;
            
            // 检查逆转成就
            checkComeback(result);
            
            if (result === 'victory') {
                userData.stats.currentWinStreak++;
                userData.stats.maxWinStreak = Math.max(userData.stats.maxWinStreak, userData.stats.currentWinStreak);
                userData.stats.currentLossStreak = 0; // 重置连败
                
                if (playerFaction === 'king') {
                    userData.stats.kingWins++;
                } else {
                    userData.stats.slaveWins++;
                }
                
                // 胜利奖励
                const baseReward = 50;
                const streakBonus = Math.min(userData.stats.currentWinStreak * 10, 100);
                const timeBonus = duration <= 180 ? 25 : 0; // 快速胜利奖励
                const totalReward = baseReward + streakBonus + timeBonus;
                
                userData.coins += totalReward;
                userData.experience += Math.floor(totalReward / 5);
                
                if (streakBonus > 0) {
                    showNotification(`🔥 连胜奖励：+${streakBonus} 金币`, 'success');
                }
                if (timeBonus > 0) {
                    showNotification(`⚡ 快速胜利：+${timeBonus} 金币`, 'success');
                }
                
            } else {
                userData.stats.currentWinStreak = 0;
                userData.stats.currentLossStreak++;
                
                if (playerFaction === 'king') {
                    userData.stats.kingLosses++;
                } else {
                    userData.stats.slaveLosses++;
                }
                
                // 失败安慰奖励
                const consolationReward = 20;
                userData.coins += consolationReward;
                userData.experience += Math.floor(consolationReward / 5);
            }
            
            // 检查等级提升
            checkLevelUp();
            
            // 检查成就
            checkAchievements();
            
            // 保存用户数据
            saveUserData();
        }

        // 显示段位变化通知
        function showRankChangeNotification(rankChange) {
            const { change, newTrophies, oldRank, newRank, rankChanged, gameMode } = rankChange;
            
            // 根据游戏模式显示不同的通知
            if (gameMode === 'casual') {
                showNotification('🎮 休闲模式：不影响段位排名', 'info');
                return;
            }
            
            if (change === 0) {
                showNotification('🏆 奖杯无变化', 'info');
                return;
            }
            
            // 基础奖杯变化通知
            let trophyMessage = '';
            if (gameMode === 'ranked') {
                trophyMessage = change > 0 ? 
                    `🏆 排位赛胜利 +${change} 奖杯 (${newTrophies})` : 
                    `💔 排位赛失败 ${change} 奖杯 (${newTrophies})`;
            } else {
                trophyMessage = change > 0 ? 
                    `🏆 +${change} 奖杯 (${newTrophies})` : 
                    `💔 ${change} 奖杯 (${newTrophies})`;
            }
            
            showNotification(trophyMessage, change > 0 ? 'success' : 'info');
            
            // 段位变化通知
            if (rankChanged) {
                setTimeout(() => {
                    if (newRank.name !== oldRank.name) {
                        const isPromotion = newTrophies > rankChange.oldTrophies;
                        if (isPromotion) {
                            showRankPromotionNotification(newRank);
                        } else {
                            showRankDemotionNotification(newRank, oldRank);
                        }
                    }
                }, 1000);
            }
            
            // 排位赛特殊提示
            if (gameMode === 'ranked') {
                setTimeout(() => {
                    if (change > 0 && userData.stats.currentWinStreak >= 3) {
                        showNotification(`🔥 排位赛连胜 ${userData.stats.currentWinStreak} 场！额外奖杯奖励！`, 'success');
                    }
                }, 2000);
            }
        }

        // 显示段位晋升通知
        function showRankPromotionNotification(newRank) {
            const notification = document.createElement('div');
            notification.className = 'rank-notification promotion';
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(145deg, ${newRank.color}, ${newRank.color}dd);
                color: white;
                padding: 30px 40px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                z-index: 10001;
                font-family: 'Cinzel', serif;
                text-align: center;
                animation: rankPromotionAppear 3s ease-out forwards;
                border: 3px solid #ffd700;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 4rem; margin-bottom: 15px; animation: bounce 1s infinite;">${newRank.icon}</div>
                <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 10px;">🎉 段位晋升！🎉</div>
                <div style="font-size: 1.4rem; margin-bottom: 15px;">${newRank.name}</div>
                <div style="font-size: 1rem; opacity: 0.9;">${newRank.description}</div>
                <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                    奖杯: ${newRank.current} / ${newRank.max === 999 ? '∞' : newRank.max}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // 显示段位降级通知
        function showRankDemotionNotification(newRank, oldRank) {
            const message = `📉 段位降级：${oldRank.name} → ${newRank.name}`;
            showNotification(message, 'error');
        }

        // 显示刺客选择模态框
        function showAssassinChoiceModal(battleData) {
            const modal = document.createElement('div');
            modal.className = 'assassin-choice-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(145deg, #3a2817, #2c1810);
                border: 3px solid #d4af37;
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                max-width: 500px;
                margin: 20px;
                color: #f4e4bc;
                font-family: 'Cinzel', serif;
            `;
            
            content.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">🗡️</div>
                <h3 style="color: #d4af37; margin-bottom: 20px; font-size: 1.8rem;">刺客的选择</h3>
                <p style="margin-bottom: 25px; font-size: 1.1rem;">你的刺客可以选择攻击目标：</p>
                
                <div style="display: flex; gap: 20px; margin: 25px 0; justify-content: center;">
                    <div style="text-align: center; padding: 15px; background: rgba(212,175,55,0.1); border-radius: 10px; min-width: 120px;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">${battleData.opponentCardData.icon}</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${battleData.opponentCardData.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">眼前的牌</div>
                    </div>
                    
                    <div style="display: flex; align-items: center; font-size: 1.5rem; color: #d4af37;">VS</div>
                    
                    <div style="text-align: center; padding: 15px; background: rgba(212,175,55,0.1); border-radius: 10px; min-width: 120px;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">🃏</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">手牌</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">${gameState.opponentHand.length}张牌</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                    <button id="assassinChoiceField" style="
                        background: linear-gradient(145deg, #ef4444, #dc2626);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">刺杀眼前的牌</button>
                    
                    <button id="assassinChoiceHand" style="
                        background: linear-gradient(145deg, #8b5cf6, #7c3aed);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">选择手牌刺杀</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.7;">
                    <p>• 刺杀眼前的牌：直接击杀对手出的${battleData.opponentCardData.name}</p>
                    <p>• 选择手牌刺杀：你来选择刺杀对手哪张手牌，对手出的牌回到手牌，你的刺客进入废牌区</p>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 绑定选择事件
            document.getElementById('assassinChoiceField').addEventListener('click', () => {
                handleAssassinChoice('field', battleData);
                document.body.removeChild(modal);
            });
            
            document.getElementById('assassinChoiceHand').addEventListener('click', () => {
                showHandCardSelection(battleData, modal);
            });
        }

        // 显示手牌选择界面
        function showHandCardSelection(battleData, parentModal) {
            const content = parentModal.querySelector('div');
            
            // 创建一个临时的对手手牌数组，排除当前出的牌
            // 注意：这里需要排除的是当前出牌在手牌中的位置，而不是卡牌ID
            const opponentCardIndex = gameState.opponentHand.findIndex(card => card === battleData.opponentCard);
            const opponentHandForSelection = gameState.opponentHand.filter((cardId, index) => index !== opponentCardIndex);
            
            if (opponentHandForSelection.length === 0) {
                content.innerHTML = `
                    <div style="font-size: 3rem; margin-bottom: 15px;">🗡️</div>
                    <h3 style="color: #d4af37; margin-bottom: 20px; font-size: 1.8rem;">无法选择手牌刺杀</h3>
                    <p style="margin-bottom: 25px; font-size: 1.1rem; color: #ff6b6b;">对手除了当前出的牌外没有其他手牌可以刺杀！</p>
                    <p style="margin-bottom: 25px; font-size: 0.9rem; opacity: 0.8;">刺客只能选择刺杀眼前的牌。</p>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                        <button id="forceFieldChoice" style="
                            background: linear-gradient(145deg, #ef4444, #dc2626);
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-family: 'Cinzel', serif;
                            font-weight: 600;
                            transition: all 0.3s ease;
                        ">刺杀眼前的牌</button>
                        
                        <button id="backToChoice" style="
                            background: linear-gradient(145deg, #6b7280, #4b5563);
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-family: 'Cinzel', serif;
                            font-weight: 600;
                            transition: all 0.3s ease;
                        ">返回</button>
                    </div>
                `;
                
                // 绑定强制选择眼前牌
                content.querySelector('#forceFieldChoice').addEventListener('click', () => {
                    handleAssassinChoice('field', battleData);
                    document.body.removeChild(parentModal);
                });
                
                // 绑定返回按钮
                content.querySelector('#backToChoice').addEventListener('click', () => {
                    showAssassinChoiceModal(battleData);
                    document.body.removeChild(parentModal);
                });
                
                return;
            }
            
            content.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">🗡️</div>
                <h3 style="color: #d4af37; margin-bottom: 20px; font-size: 1.8rem;">选择刺杀目标</h3>
                <p style="margin-bottom: 25px; font-size: 1.1rem;">选择要刺杀的对手手牌位置：</p>
                <p style="margin-bottom: 25px; font-size: 0.9rem; opacity: 0.8; color: #ff6b6b;">⚠️ 你无法看到对手的具体手牌，只能选择位置进行盲刺！</p>
                <p style="margin-bottom: 15px; font-size: 0.85rem; opacity: 0.7; color: #d4af37;">💡 注意：不包括对手当前出的${battleData.opponentCardData.name}</p>
                
                <div id="opponentHandSelection" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 25px 0;">
                    ${opponentHandForSelection.map((cardId, index) => `
                        <div class="hand-card-option" data-index="${index}" style="
                            text-align: center;
                            padding: 15px 10px;
                            background: rgba(212,175,55,0.1);
                            border: 2px solid #8b4513;
                            border-radius: 10px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            min-width: 80px;
                        ">
                            <div style="font-size: 2rem; margin-bottom: 8px;">🃏</div>
                            <div style="font-weight: bold; margin-bottom: 5px; font-size: 0.9rem;">第${index + 1}张牌</div>
                            <div style="font-size: 0.7rem; opacity: 0.7;">未知卡牌</div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 25px;">
                    <button id="confirmHandSelection" style="
                        background: linear-gradient(145deg, #10b981, #059669);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        opacity: 0.5;
                    " disabled>确认刺杀</button>
                    
                    <button id="backToChoice" style="
                        background: linear-gradient(145deg, #6b7280, #4b5563);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">返回</button>
                </div>
                
                <div style="margin-top: 20px; font-size: 0.9rem; opacity: 0.7;">
                    <p>💡 提示：选择一个位置进行盲刺，刺杀成功后会显示被刺杀的卡牌</p>
                    <p>📋 规则：对手出的牌回到手牌，你的刺客进入废牌区，被刺杀的手牌进入废牌区</p>
                </div>
            `;
            
            let selectedHandIndex = null;
            
            // 绑定手牌选择事件
            content.querySelectorAll('.hand-card-option').forEach(option => {
                option.addEventListener('click', () => {
                    // 清除之前的选择
                    content.querySelectorAll('.hand-card-option').forEach(opt => {
                        opt.style.borderColor = '#8b4513';
                        opt.style.background = 'rgba(212,175,55,0.1)';
                    });
                    
                    // 选中当前卡牌
                    option.style.borderColor = '#d4af37';
                    option.style.background = 'rgba(212,175,55,0.3)';
                    
                    selectedHandIndex = parseInt(option.dataset.index);
                    
                    // 启用确认按钮
                    const confirmBtn = content.querySelector('#confirmHandSelection');
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                });
            });
            
            // 绑定确认按钮
            content.querySelector('#confirmHandSelection').addEventListener('click', () => {
                if (selectedHandIndex !== null) {
                    // 需要将选择的索引映射回原始手牌数组
                    const opponentCardIndex = gameState.opponentHand.findIndex(card => card === battleData.opponentCard);
                    const actualHandIndex = findActualHandIndex(selectedHandIndex, opponentCardIndex);
                    handleAssassinHandChoice(actualHandIndex, battleData);
                    document.body.removeChild(parentModal);
                }
            });
            
            // 绑定返回按钮
            content.querySelector('#backToChoice').addEventListener('click', () => {
                showAssassinChoiceModal(battleData);
                document.body.removeChild(parentModal);
            });
        }

        // 处理刺客选择
        function handleAssassinChoice(choice, battleData) {
            let battleResult = '';
            let playerSurvives = false; // 刺客使用技能后进入废牌堆
            let opponentSurvives = false;
            let playerWon = false;
            let opponentWon = false;
            
            if (choice === 'field') {
                // 选择刺杀眼前的牌
                if (battleData.opponentCardData.type === 'key') {
                    if (battleData.opponentKingImmune && battleData.opponentCard === 'king') {
                        battleResult = '刺客尝试刺杀国王，但国王受到皇家守卫保护！刺客被反杀。';
                        playerSurvives = false; // 刺客被反杀，进入废牌堆
                        opponentSurvives = true;
                        playerWon = false;
                        opponentWon = true;
                    } else {
                        battleResult = `🗡️ 刺客选择刺杀眼前的关键牌${battleData.opponentCardData.name}！「刺客的刀，刺穿了王权的心！」刺客完成任务后消失在阴影中。`;
                        playerSurvives = false; // 刺客完成刺杀后进入废牌堆
                        opponentSurvives = false; // 对手被刺杀
                        playerWon = true; // 刺客成功刺杀，算作玩家胜利
                        opponentWon = false;
                        addLogEntry('🎯 完美刺杀！击杀关键牌获得额外奖励！');
                    }
                } else {
                    battleResult = `刺客选择刺杀眼前的${battleData.opponentCardData.name}！无视等级直接击杀！刺客完成任务后消失在阴影中。`;
                    playerSurvives = false; // 刺客完成刺杀后进入废牌堆
                    opponentSurvives = false; // 对手被刺杀
                    playerWon = true; // 刺客成功刺杀，算作玩家胜利
                    opponentWon = false;
                }
            }
            
            // 继续执行战斗结算
            const finalBattleResult = {
                gameEnded: false,
                playerWon: playerWon,
                opponentWon: opponentWon,
                description: battleResult,
                playerSurvives: playerSurvives,
                opponentSurvives: opponentSurvives
            };
            
            // 显示战斗结果
            addLogEntry(`⚔️ 战斗结果：${battleResult}`);
            
            // 判断胜负 - 刺客成功刺杀算作玩家胜利
            if (finalBattleResult.playerWon) {
                addLogEntry(`🎉 本回合胜利！你的${cardData[battleData.playerCard].name}成功刺杀了对手的${cardData[battleData.opponentCard].name}！`);
            } else if (finalBattleResult.opponentWon) {
                addLogEntry(`💔 本回合失败！对手的${cardData[battleData.opponentCard].name}击败了你的${cardData[battleData.playerCard].name}！`);
            } else {
                addLogEntry(`⚖️ 本回合平局！双方卡牌都存活！`);
            }
            
            // 更新特殊统计
            updateSpecialStats(battleData.playerCard, battleData.opponentCard, playerSurvives, battleResult);
            
            // 处理特殊效果
            handleSpecialEffects(battleData.playerCard, battleData.opponentCard, playerSurvives, opponentSurvives);
            
            // 处理卡牌结算
            const playerCardIndex = gameState.playerSelectedCard;
            const opponentCardIndex = gameState.opponentHand.findIndex(card => card === battleData.opponentCard);
            
            if (!playerSurvives) {
                gameState.playerHand.splice(playerCardIndex, 1);
                addLogEntry(`💀 你的${cardData[battleData.playerCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 你的${cardData[battleData.playerCard].name}存活，回到手牌`);
            }
            
            if (!opponentSurvives) {
                gameState.opponentHand.splice(opponentCardIndex, 1);
                addLogEntry(`💀 对手的${cardData[battleData.opponentCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 对手的${cardData[battleData.opponentCard].name}存活，回到手牌`);
            }
            
            // 检查游戏结束条件
            const gameEnded = checkGameEnd();
            finalBattleResult.gameEnded = gameEnded;
            
            // 准备下一回合
            if (!gameEnded) {
                gameState.playerSelectedCard = null;
                gameState.currentTurn++;
                gameState.gamePhase = 'roundEnd';
            }
            
            // 显示战斗结果宣布
            setTimeout(() => {
                announceBattleResult(finalBattleResult);
            }, 1000);
        }

        // 找到实际手牌索引（排除当前出的牌）
        function findActualHandIndex(selectedIndex, excludeCardIndex) {
            let filteredIndex = 0;
            
            for (let i = 0; i < gameState.opponentHand.length; i++) {
                if (i !== excludeCardIndex) {
                    if (filteredIndex === selectedIndex) {
                        return i;
                    }
                    filteredIndex++;
                }
            }
            
            return -1; // 不应该发生
        }

        // 处理手牌刺杀选择
        function handleAssassinHandChoice(selectedHandIndex, battleData) {
            // 获取被刺杀的手牌
            const killedCard = gameState.opponentHand[selectedHandIndex];
            const killedCardData = cardData[killedCard];
            
            // 从对手手牌中移除被刺杀的牌
            gameState.opponentHand.splice(selectedHandIndex, 1);
            
            let battleResult = '';
            if (killedCardData.type === 'key') {
                battleResult = `🗡️ 刺客选择刺杀对手手牌中的关键牌${killedCardData.name}！💀 刺中要害！王权陨落！刺客完成任务后消失在阴影中。对手出的${battleData.opponentCardData.name}回到手牌。`;
                addLogEntry('🎯 完美刺杀！击杀关键牌获得额外奖励！');
            } else {
                battleResult = `🗡️ 刺客选择刺杀对手手牌中的${killedCardData.name}！暗影一击！刺客完成任务后消失在阴影中。对手出的${battleData.opponentCardData.name}回到手牌。`;
            }
            
            const playerSurvives = false; // 刺客完成任务后进入废牌堆
            const opponentSurvives = true; // 对手出的牌回到手牌，视为存活
            
            // 手牌刺杀的特殊胜负判断：刺客成功刺杀手牌算作玩家胜利
            const playerWon = true; // 刺客成功完成刺杀任务，算作玩家胜利
            const opponentWon = false; // 对手被刺杀手牌，算作失败
            
            // 继续执行战斗结算
            const finalBattleResult = {
                gameEnded: false,
                playerWon: playerWon,
                opponentWon: opponentWon,
                description: battleResult,
                playerSurvives: playerSurvives,
                opponentSurvives: opponentSurvives
            };
            
            // 显示战斗结果
            addLogEntry(`⚔️ 战斗结果：${battleResult}`);
            
            // 判断胜负 - 手牌刺杀成功算作玩家胜利
            if (finalBattleResult.playerWon) {
                addLogEntry(`🎉 本回合胜利！你的${cardData[battleData.playerCard].name}成功刺杀了对手的手牌！`);
            } else if (finalBattleResult.opponentWon) {
                addLogEntry(`💔 本回合失败！对手的${cardData[battleData.opponentCard].name}击败了你的${cardData[battleData.playerCard].name}！`);
            } else {
                addLogEntry(`⚖️ 本回合平局！双方卡牌都存活！`);
            }
            
            // 更新特殊统计
            updateSpecialStats(battleData.playerCard, battleData.opponentCard, playerSurvives, battleResult);
            
            // 处理特殊效果
            handleSpecialEffects(battleData.playerCard, battleData.opponentCard, playerSurvives, opponentSurvives);
            
            // 处理卡牌结算
            const playerCardIndex = gameState.playerSelectedCard;
            const opponentCardIndex = gameState.opponentHand.findIndex(card => card === battleData.opponentCard);
            
            if (!playerSurvives) {
                gameState.playerHand.splice(playerCardIndex, 1);
                addLogEntry(`💀 你的${cardData[battleData.playerCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 你的${cardData[battleData.playerCard].name}存活，回到手牌`);
            }
            
            if (!opponentSurvives) {
                // 注意：这里不需要再次移除对手出的牌，因为它要回到手牌
                addLogEntry(`💀 对手的${cardData[battleData.opponentCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 对手的${cardData[battleData.opponentCard].name}存活，回到手牌`);
            }
            
            // 检查游戏结束条件
            const gameEnded = checkGameEnd();
            finalBattleResult.gameEnded = gameEnded;
            
            // 准备下一回合
            if (!gameEnded) {
                gameState.playerSelectedCard = null;
                gameState.currentTurn++;
                gameState.gamePhase = 'roundEnd';
            }
            
            // 显示战斗结果宣布
            setTimeout(() => {
                announceBattleResult(finalBattleResult);
            }, 1000);
        }

        // 初始化登录系统
        function initLoginSystem() {
            // 头像选择
            const avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    // 清除之前的选择
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    // 选择当前头像
                    e.target.classList.add('selected');
                    userData.avatar = e.target.dataset.avatar;
                });
            });
            

            
            // 用户名输入验证
            const usernameInput = document.getElementById('loginUsername');
            usernameInput.addEventListener('input', validateUsername);
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    enterGame();
                }
            });
            
            // 进入游戏按钮
            const enterBtn = document.getElementById('enterGame');
            enterBtn.addEventListener('click', enterGame);
            
            // 继续到游戏按钮 - 使用事件委托，因为按钮是动态生成的
            // 这个按钮在介绍界面中，通过全局事件委托处理
            
            // 设置默认值
            userData.avatar = '👤';
            userData.difficulty = 'normal';
        }
        
        // 验证用户名
        function validateUsername() {
            const input = document.getElementById('loginUsername');
            const username = input.value.trim();
            const enterBtn = document.getElementById('enterGame');
            
            if (username.length < 2) {
                input.style.borderColor = '#ef4444';
                enterBtn.disabled = true;
                enterBtn.style.opacity = '0.5';
                return false;
            } else if (username.length > 12) {
                input.value = username.substring(0, 12);
                return validateUsername();
            } else {
                input.style.borderColor = '#d4af37';
                enterBtn.disabled = false;
                enterBtn.style.opacity = '1';
                return true;
            }
        }
        
        // 进入游戏
        function enterGame() {
            const username = document.getElementById('loginUsername').value.trim();
            
            if (!validateUsername()) {
                showNotification('用户名长度必须在2-12个字符之间', 'error');
                return;
            }
            
            // 更新用户数据
            userData.username = username;
            
            // 检查是否为新用户（首次游戏）
            const isNewUser = !localStorage.getItem('kingAndSlaveUser');
            
            if (isNewUser) {
                // 新用户奖励
                userData.coins = 100;
                userData.experience = 50;
                userData.trophies = 10;
                userData.registerDate = Date.now(); // 设置注册时间
                
                showNotification('🎉 欢迎新玩家！已获得新手奖励！', 'success');
                
                setTimeout(() => {
                    showNotification('💰 +100金币 🌟 +50经验 🏆 +10奖杯', 'success');
                }, 1000);
            } else {
                // 老用户，加载保存的数据但保持当前用户名
                try {
                    const savedData = JSON.parse(localStorage.getItem('kingAndSlaveUser'));
                    userData = { ...userData, ...savedData };
                    userData.username = username; // 使用当前输入的用户名
                } catch (e) {
                    console.warn('加载用户数据失败，使用默认数据');
                }
                
                showNotification(`欢迎回来，${username}！`, 'success');
            }
            
            // 立即保存用户数据
            saveUserData();
            
            // 进入游戏介绍界面
            setTimeout(() => {
                hideAllScreens();
                document.getElementById('introScreen').style.display = 'block';
                hideUserStatusBar(); // 介绍页面隐藏用户状态栏
                updateUserDisplay();
                
                // 检查成就
                checkAchievements();
            }, 1500);
        }
        
        // 继续到游戏
        function continueToGame() {
            hideAllScreens();
            document.getElementById('battleScreen').style.display = 'block';
            showUserStatusBar(); // 确保用户状态栏显示
            updateBattleScreenRank();
            updateActiveNavButton('battleBtn');
            showNotification('欢迎来到对战大厅！选择你的对战模式', 'info');
        }
        
        // 保存用户数据到本地存储
        function saveUserData() {
            try {
                localStorage.setItem('kingAndSlaveUser', JSON.stringify(userData));
            } catch (e) {
                console.warn('保存用户数据失败:', e);
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-family: 'Cinzel', serif;
                font-weight: 600;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 选择阵营
        function selectFaction(event) {
            const faction = event.currentTarget.dataset.faction;
            
            // 清除之前的选择
            document.querySelectorAll('.faction-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            gameState.playerFaction = faction;
            
            // 显示开局选择
            showOpeningSelection(faction);
        }

        // 显示开局选择
        function showOpeningSelection(faction) {
            const openingSelection = document.getElementById('openingSelection');
            const openingCards = document.getElementById('openingCards');
            
            openingCards.innerHTML = '';
            
            if (faction === 'king') {
                // 国王方可选择国王开局或女王开局
                ['king', 'queen'].forEach(opening => {
                    const config = openingConfigs[opening];
                    const card = document.createElement('div');
                    card.className = 'opening-card';
                    card.dataset.opening = opening;
                    card.innerHTML = `
                        <h4>${config.name}</h4>
                        <p>${config.description}</p>
                    `;
                    card.addEventListener('click', selectOpening);
                    openingCards.appendChild(card);
                });
            } else {
                // 奴隶方只有一种开局
                const config = openingConfigs.slave;
                const card = document.createElement('div');
                card.className = 'opening-card selected';
                card.dataset.opening = 'slave';
                card.innerHTML = `
                    <h4>${config.name}</h4>
                    <p>${config.description}</p>
                `;
                openingCards.appendChild(card);
                gameState.playerOpening = 'slave';
                document.getElementById('startGame').disabled = false;
            }
            
            openingSelection.style.display = 'block';
        }

        // 选择开局方式
        function selectOpening(event) {
            document.querySelectorAll('.opening-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            gameState.playerOpening = event.currentTarget.dataset.opening;
            document.getElementById('startGame').disabled = false;
        }

        // 开始游戏
        function startGame() {
            gameState.gamePhase = 'playing';
            gameState.gameStartTime = Date.now(); // 记录游戏开始时间
            
            // 初始化卡组
            gameState.playerHand = [...openingConfigs[gameState.playerOpening].deck];
            
            // AI选择对手阵营和开局
            let aiOpening;
            if (gameState.playerFaction === 'king') {
                aiOpening = 'slave';
                gameState.opponentHand = [...openingConfigs.slave.deck];
            } else {
                aiOpening = Math.random() > 0.5 ? 'king' : 'queen';
                gameState.opponentHand = [...openingConfigs[aiOpening].deck];
            }
            
            // 记录AI开局
            gameState.opponentOpening = aiOpening;
            
            // 切换到游戏界面
            hideAllScreens();
            document.getElementById('gameBoard').style.display = 'grid';
            hideUserStatusBar(); // 游戏中隐藏用户状态栏
            
            // 更新界面
            updateGameUI();
            addLogEntry('游戏开始！选择一张牌进行战斗。');
            addLogEntry(`你的开局：${openingConfigs[gameState.playerOpening].name}`);
            addLogEntry(`对手开局：${openingConfigs[aiOpening].name}`);
        }

        // 更新游戏界面
        function updateGameUI() {
            // 更新阵营显示
            document.getElementById('playerFaction').textContent = 
                gameState.playerFaction === 'king' ? '👑 国王方' : '⚔️ 奴隶方';
            
            // 根据游戏模式显示对手信息
            const opponentData = gameState.opponentData || { name: 'AI对手' };
            const opponentFactionText = gameState.playerFaction === 'king' ? '⚔️ 奴隶方' : '👑 国王方';
            
            if (gameState.gameMode === 'ranked' || gameState.gameMode === 'casual') {
                document.getElementById('opponentFaction').textContent = 
                    `${opponentFactionText} (${opponentData.name})`;
            } else {
                document.getElementById('opponentFaction').textContent = 
                    `${opponentFactionText} (AI)`;
            }
            
            // 更新开局显示
            if (gameState.playerOpening) {
                document.getElementById('playerOpening').textContent = 
                    `开局: ${openingConfigs[gameState.playerOpening].name}`;
            }
            if (gameState.opponentOpening) {
                document.getElementById('opponentOpening').textContent = 
                    `开局: ${openingConfigs[gameState.opponentOpening].name}`;
            }
            
            // 更新手牌数量
            document.getElementById('playerHandCount').textContent = gameState.playerHand.length;
            document.getElementById('opponentHandCount').textContent = gameState.opponentHand.length;
            
            // 渲染玩家手牌
            renderPlayerHand();
            renderOpponentHand();
            
            // 更新回合指示器
            updateTurnIndicator();
        }

        // 更新回合指示器
        function updateTurnIndicator() {
            const indicator = document.getElementById('turnIndicator');
            
            if (gameState.gamePhase === 'battle') {
                indicator.innerHTML = '<div>⚔️ 战斗结算中...</div>';
                indicator.style.background = 'rgba(204, 68, 68, 0.4)';
            } else if (gameState.gamePhase === 'reveal') {
                indicator.innerHTML = '<div>📋 同时翻开卡牌...</div>';
                indicator.style.background = 'rgba(139, 69, 19, 0.4)';
            } else if (gameState.gamePhase === 'aiSelecting') {
                indicator.innerHTML = `<div>第 ${gameState.currentTurn} 回合<br>🤖 AI正在选择卡牌...</div>`;
                indicator.style.background = 'rgba(204, 68, 68, 0.3)';
            } else if (gameState.isPlayerTurn) {
                indicator.innerHTML = `<div>第 ${gameState.currentTurn} 回合<br>👆 选择一张牌出战</div>`;
                indicator.style.background = 'rgba(212, 175, 55, 0.3)';
            } else {
                indicator.innerHTML = `<div>第 ${gameState.currentTurn} 回合<br>⏳ 等待对手选择...</div>`;
                indicator.style.background = 'rgba(204, 68, 68, 0.3)';
            }
        }

        // 渲染玩家手牌
        function renderPlayerHand() {
            const handContainer = document.getElementById('playerHand');
            handContainer.innerHTML = '';
            
            gameState.playerHand.forEach((cardId, index) => {
                const card = createCardElement(cardId, index, true);
                handContainer.appendChild(card);
            });
        }

        // 渲染对手手牌（背面）
        function renderOpponentHand() {
            const handContainer = document.getElementById('opponentHand');
            handContainer.innerHTML = '';
            
            gameState.opponentHand.forEach((_, index) => {
                const card = createCardElement(null, index, false);
                handContainer.appendChild(card);
            });
        }

        // 创建卡牌元素
        function createCardElement(cardId, index, isPlayer) {
            const card = document.createElement('div');
            card.className = 'card';
            
            if (!isPlayer || cardId === null) {
                // 对手的牌或隐藏的牌显示背面
                card.classList.add('card-back');
                card.innerHTML = `
                    <div class="card-icon">🃏</div>
                    <div class="card-name">???</div>
                `;
            } else {
                // 玩家的牌显示正面
                const cardInfo = cardData[cardId];
                
                // 检查终极守卫冷却状态
                const isUltimateGuardOnCooldown = (cardId === 'ultimateGuard' && gameState.specialEffects.ultimateGuardCooldown > 0);
                
                card.innerHTML = `
                    <div class="card-level">${cardInfo.level}</div>
                    <div class="card-icon">${cardInfo.icon}</div>
                    <div class="card-name">${cardInfo.name}${isUltimateGuardOnCooldown ? ` (冷却${gameState.specialEffects.ultimateGuardCooldown})` : ''}</div>
                    <div class="card-description">${isUltimateGuardOnCooldown ? `冷却中，还需${gameState.specialEffects.ultimateGuardCooldown}回合` : cardInfo.description}</div>
                `;
                
                // 特殊卡牌的限制检查
                if (isUltimateGuardOnCooldown) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                    card.style.filter = 'grayscale(0.7)';
                    card.title = `终极守卫冷却中，还需等待 ${gameState.specialEffects.ultimateGuardCooldown} 回合`;
                    
                    // 添加冷却点击提示
                    card.addEventListener('click', () => {
                        showNotification(`终极守卫冷却中！还需等待 ${gameState.specialEffects.ultimateGuardCooldown} 回合才能使用`, 'error');
                    });
                } else if (cardId === 'queen' && gameState.playerHand.length > 1) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                    card.addEventListener('click', () => {
                        showNotification('女王只能在最后一张牌时出场！', 'error');
                    });
                } else {
                    card.addEventListener('click', () => selectPlayerCard(index));
                }
            }
            
            return card;
        }

        // 选择玩家卡牌
        function selectPlayerCard(index) {
            // 检查是否为玩家回合
            if (!gameState.isPlayerTurn) {
                addLogEntry('现在不是你的回合！');
                return;
            }
            
            const cardId = gameState.playerHand[index];
            
            // 检查特殊限制
            if (cardId === 'ultimateGuard' && gameState.specialEffects.ultimateGuardCooldown > 0) {
                addLogEntry(`终极守卫冷却中！还需等待 ${gameState.specialEffects.ultimateGuardCooldown} 回合才能使用。`);
                return;
            }
            
            if (cardId === 'queen' && gameState.playerHand.length > 1) {
                addLogEntry('女王只能在最后一张牌时出场！');
                return;
            }
            
            // 清除之前的选择
            document.querySelectorAll('#playerHand .card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 选择当前卡牌
            document.querySelectorAll('#playerHand .card')[index].classList.add('selected');
            gameState.playerSelectedCard = index;
            
            // 启用确认按钮
            document.getElementById('confirmPlay').disabled = false;
        }

        // 确认出牌
        function confirmPlay() {
            if (gameState.playerSelectedCard === null || !gameState.isPlayerTurn) return;
            
            // 玩家出牌（背面朝上）
            gameState.playerBattleCard = gameState.playerHand[gameState.playerSelectedCard];
            addLogEntry(`你选择了一张牌，背面朝上放在桌上...`);
            
            // 显示背面朝上的牌
            displayCardBack('playerBattleCard');
            
            // 切换到AI出牌阶段
            gameState.gamePhase = 'aiSelecting';
            updateTurnIndicator();
            
            // 禁用确认按钮
            document.getElementById('confirmPlay').disabled = true;
            
            // AI同时选择牌（模拟思考时间）
            setTimeout(() => {
                aiSelectCard();
            }, 1500);
        }

        // 显示背面卡牌
        function displayCardBack(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="card card-back" style="width: 200px; height: 280px; padding: 30px 20px;">
                    <div class="card-icon" style="font-size: 4.5rem; margin-bottom: 18px;">🃏</div>
                    <div class="card-name" style="font-size: 1.3rem; margin-bottom: 10px;">???</div>
                    <div class="card-description" style="font-size: 0.9rem;">背面朝上</div>
                </div>
            `;
        }

        // 显示玩家战斗卡牌
        function displayPlayerBattleCard() {
            const playerBattleArea = document.getElementById('playerBattleCard');
            const playerCardData = cardData[gameState.playerBattleCard];
            
            playerBattleArea.innerHTML = `
                <div class="card" style="width: 200px; height: 280px; padding: 30px 20px;">
                    <div class="card-level" style="width: 38px; height: 38px; font-size: 1.2rem;">${playerCardData.level}</div>
                    <div class="card-icon" style="font-size: 4.5rem; margin-bottom: 18px;">${playerCardData.icon}</div>
                    <div class="card-name" style="font-size: 1.3rem; margin-bottom: 10px;">${playerCardData.name}</div>
                    <div class="card-description" style="font-size: 0.9rem;">${playerCardData.description}</div>
                </div>
            `;
        }

        // AI选择卡牌
        function aiSelectCard() {
            // AI智能洗牌决策
            if (shouldAIShuffle()) {
                performAIShuffle();
                // 洗牌后重新选择
                setTimeout(() => {
                    continueAISelection();
                }, 1500);
                return;
            }
            
            continueAISelection();
        }
        
        // 继续AI选择流程
        function continueAISelection() {
            const aiCardIndex = selectAICard();
            gameState.opponentBattleCard = gameState.opponentHand[aiCardIndex];
            
            addLogEntry(`对手也选择了一张牌，背面朝上放在桌上...`);
            
            // 显示对手背面朝上的牌
            displayCardBack('opponentBattleCard');
            
            // 进入同时翻牌阶段
            gameState.gamePhase = 'reveal';
            updateTurnIndicator();
            
            // 延迟同时翻牌
            setTimeout(() => {
                revealCards();
            }, 2000);
        }
        
        // AI是否应该洗牌的智能判断
        function shouldAIShuffle() {
            // 如果手牌少于3张，不洗牌
            if (gameState.opponentHand.length < 3) {
                return false;
            }
            
            // 如果是第1回合，不洗牌
            if (gameState.currentTurn <= 1) {
                return false;
            }
            
            // 分析当前手牌质量
            const handQuality = analyzeAIHandQuality();
            
            // 如果手牌质量很差，考虑洗牌
            if (handQuality.score < 0.3 && Math.random() > 0.7) {
                addLogEntry('🤖 AI分析：当前手牌配置不佳，决定重新洗牌！');
                return true;
            }
            
            // 如果连续失败多回合，增加洗牌概率
            if (gameState.currentTurn > 3 && Math.random() > 0.85) {
                addLogEntry('🤖 AI分析：战局不利，尝试改变手牌顺序！');
                return true;
            }
            
            // 如果检测到玩家可能的威胁，考虑洗牌寻找对策
            if (detectPlayerThreat() && Math.random() > 0.8) {
                addLogEntry('🤖 AI分析：检测到威胁，重新整理战术！');
                return true;
            }
            
            // 随机洗牌（低概率）
            if (Math.random() > 0.95) {
                addLogEntry('🤖 AI分析：随机调整手牌顺序！');
                return true;
            }
            
            return false;
        }
        
        // 分析AI手牌质量
        function analyzeAIHandQuality() {
            let score = 0;
            let keyCards = 0;
            let highLevelCards = 0;
            let specialCards = 0;
            
            gameState.opponentHand.forEach(cardId => {
                const card = cardData[cardId];
                
                // 关键牌价值最高
                if (card.type === 'key') {
                    keyCards++;
                    score += 0.3;
                }
                
                // 高等级牌有价值
                if (card.level >= 3) {
                    highLevelCards++;
                    score += 0.2;
                }
                
                // 特殊功能牌有价值
                if (card.type === 'special' || cardId === 'assassin' || cardId === 'butcher' || cardId === 'slave') {
                    specialCards++;
                    score += 0.15;
                }
                
                // 基础分数
                score += card.level * 0.05;
            });
            
            // 手牌平衡性加分
            if (keyCards > 0 && specialCards > 0) {
                score += 0.1; // 有关键牌和特殊牌的平衡
            }
            
            // 归一化分数
            score = Math.min(score / gameState.opponentHand.length, 1.0);
            
            return {
                score: score,
                keyCards: keyCards,
                highLevelCards: highLevelCards,
                specialCards: specialCards,
                analysis: score > 0.6 ? '优秀' : score > 0.4 ? '良好' : score > 0.2 ? '一般' : '较差'
            };
        }
        
        // 检测玩家威胁
        function detectPlayerThreat() {
            // 检查玩家是否有关键牌
            const playerHasKey = gameState.playerHand.some(card => cardData[card].type === 'key');
            
            // 检查玩家手牌数量优势
            const playerHandAdvantage = gameState.playerHand.length > gameState.opponentHand.length;
            
            // 检查是否连续失败
            // 这里可以根据之前的战斗记录来判断，暂时用回合数模拟
            const consecutiveLosses = gameState.currentTurn > 5;
            
            return playerHasKey || playerHandAdvantage || consecutiveLosses;
        }
        
        // 执行AI洗牌
        function performAIShuffle() {
            // Fisher-Yates 洗牌算法
            const hand = [...gameState.opponentHand];
            for (let i = hand.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [hand[i], hand[j]] = [hand[j], hand[i]];
            }
            
            gameState.opponentHand = hand;
            
            // 重新渲染对手手牌（背面）
            renderOpponentHand();
            
            addLogEntry('🔄 对手重新洗了手牌！');
            
            // 显示AI的洗牌思考过程
            const handQuality = analyzeAIHandQuality();
            addLogEntry(`🤖 AI手牌分析：${handQuality.analysis} (关键牌:${handQuality.keyCards} 高级牌:${handQuality.highLevelCards} 特殊牌:${handQuality.specialCards})`);
        }

        // 同时翻牌
        function revealCards() {
            addLogEntry(`📋 同时翻开卡牌！`);
            
            // 添加翻牌动画效果
            const playerArea = document.getElementById('playerBattleCard');
            const opponentArea = document.getElementById('opponentBattleCard');
            
            // 翻牌动画
            playerArea.style.animation = 'cardFlip 0.8s ease-in-out';
            opponentArea.style.animation = 'cardFlip 0.8s ease-in-out';
            
            setTimeout(() => {
                // 显示真实卡牌
                displayPlayerBattleCard();
                displayOpponentBattleCard();
                
                // 记录翻牌结果
                addLogEntry(`你出了：${cardData[gameState.playerBattleCard].name}`);
                addLogEntry(`对手出了：${cardData[gameState.opponentBattleCard].name}`);
                
                // 进入战斗阶段
                gameState.gamePhase = 'battle';
                updateTurnIndicator();
                
                // 延迟执行战斗
                setTimeout(() => {
                    executeBattleAndContinue();
                }, 1500);
            }, 400); // 翻牌动画中点
        }

        // 显示对手战斗卡牌
        function displayOpponentBattleCard() {
            const opponentBattleArea = document.getElementById('opponentBattleCard');
            const opponentCardData = cardData[gameState.opponentBattleCard];
            
            opponentBattleArea.innerHTML = `
                <div class="card" style="width: 200px; height: 280px; padding: 30px 20px;">
                    <div class="card-level" style="width: 38px; height: 38px; font-size: 1.2rem;">${opponentCardData.level}</div>
                    <div class="card-icon" style="font-size: 4.5rem; margin-bottom: 18px;">${opponentCardData.icon}</div>
                    <div class="card-name" style="font-size: 1.3rem; margin-bottom: 10px;">${opponentCardData.name}</div>
                    <div class="card-description" style="font-size: 0.9rem;">${opponentCardData.description}</div>
                </div>
            `;
        }

        // AI选择卡牌
        function selectAICard() {
            const availableCards = gameState.opponentHand.map((cardId, index) => ({ cardId, index }));
            const playerCard = gameState.playerBattleCard || gameState.playerHand[gameState.playerSelectedCard];
            const playerCardData = cardData[playerCard];
            
            // 根据对手难度调整AI策略
            const difficulty = gameState.opponentData?.difficulty || 'normal';
            const aiStrategy = getAIStrategy(difficulty);
            
            // 1. 如果玩家出关键牌且AI有刺客，优先使用刺客
            if (playerCardData.type === 'key') {
                const assassinIndex = availableCards.findIndex(card => card.cardId === 'assassin');
                if (assassinIndex !== -1 && Math.random() > aiStrategy.missChance) {
                    addLogEntry('AI分析：检测到关键牌，派出刺客！');
                    return availableCards[assassinIndex].index;
                }
            }
            
            // 2. 如果玩家出刺客且AI有终极守卫且不在冷却中，优先使用终极守卫
            if (playerCard === 'assassin') {
                const ultimateGuardIndex = availableCards.findIndex(card => card.cardId === 'ultimateGuard');
                if (ultimateGuardIndex !== -1 && gameState.specialEffects.aiUltimateGuardCooldown === 0 && Math.random() > aiStrategy.missChance) {
                    addLogEntry('🤖 AI分析：刺客来袭，终极守卫迎战！');
                    return availableCards[ultimateGuardIndex].index;
                } else if (ultimateGuardIndex !== -1 && gameState.specialEffects.aiUltimateGuardCooldown > 0) {
                    addLogEntry('🤖 AI分析：终极守卫冷却中，无法应对刺客！');
                }
            }
            
            // 2.5. AI刺客策略：优先针对玩家的关键牌
            const playerHasKey = gameState.playerHand.some(card => cardData[card].type === 'key');
            if (playerHasKey && Math.random() > aiStrategy.conservativeChance) {
                const assassinIndex = availableCards.findIndex(card => card.cardId === 'assassin');
                if (assassinIndex !== -1 && Math.random() > aiStrategy.aggressiveThreshold) {
                    addLogEntry('AI分析：检测到关键牌威胁，派出刺客！');
                    return availableCards[assassinIndex].index;
                }
            }
            
            // 3. 如果玩家出高等级牌(3级)且AI有屠夫，考虑使用屠夫
            if (playerCardData.level >= 3 && Math.random() > aiStrategy.conservativeChance) {
                const butcherIndex = availableCards.findIndex(card => card.cardId === 'butcher');
                if (butcherIndex !== -1 && Math.random() > aiStrategy.suicideThreshold) {
                    addLogEntry('AI分析：高等级威胁，屠夫同归于尽！');
                    return availableCards[butcherIndex].index;
                }
            }
            
            // 4. 如果AI有奴隶且玩家出国王/女王，优先使用奴隶
            if ((playerCard === 'king' || playerCard === 'queen')) {
                const slaveIndex = availableCards.findIndex(card => card.cardId === 'slave');
                if (slaveIndex !== -1 && Math.random() > aiStrategy.missChance) {
                    addLogEntry('AI分析：王权现身，奴隶起义！');
                    return availableCards[slaveIndex].index;
                }
            }
            
            // 5. 智能等级匹配：尝试用稍高等级的牌击败对手
            const betterCards = availableCards.filter(card => {
                const aiCardData = cardData[card.cardId];
                return aiCardData.level > playerCardData.level && aiCardData.level <= playerCardData.level + 1;
            });
            
            if (betterCards.length > 0 && Math.random() > aiStrategy.randomChance) {
                const selectedCard = betterCards[Math.floor(Math.random() * betterCards.length)];
                addLogEntry('AI分析：使用等级优势！');
                return selectedCard.index;
            }
            
            // 6. 保护策略：如果AI手牌中有关键牌，避免使用（困难模式更谨慎）
            const nonKeyCards = availableCards.filter(card => cardData[card.cardId].type !== 'key');
            if (nonKeyCards.length > 0 && Math.random() > aiStrategy.riskTaking) {
                return nonKeyCards[Math.floor(Math.random() * nonKeyCards.length)].index;
            }
            
            // 7. 最后随机选择
            addLogEntry('AI分析：随机应战！');
            return Math.floor(Math.random() * availableCards.length);
        }

        // 获取AI策略参数
        function getAIStrategy(difficulty) {
            switch (difficulty) {
                case 'easy':
                    return {
                        missChance: 0.3,           // 30%概率错过最佳选择
                        conservativeChance: 0.4,   // 40%概率保守
                        aggressiveThreshold: 0.6,  // 60%概率使用刺客
                        suicideThreshold: 0.7,     // 70%概率使用屠夫
                        randomChance: 0.4,         // 40%概率随机选择
                        riskTaking: 0.3            // 30%概率冒险使用关键牌
                    };
                case 'hard':
                    return {
                        missChance: 0.05,          // 5%概率错过最佳选择
                        conservativeChance: 0.1,   // 10%概率保守
                        aggressiveThreshold: 0.2,  // 80%概率使用刺客
                        suicideThreshold: 0.4,     // 60%概率使用屠夫
                        randomChance: 0.1,         // 10%概率随机选择
                        riskTaking: 0.1            // 10%概率冒险使用关键牌
                    };
                default: // normal
                    return {
                        missChance: 0.15,          // 15%概率错过最佳选择
                        conservativeChance: 0.25,  // 25%概率保守
                        aggressiveThreshold: 0.4,  // 60%概率使用刺客
                        suicideThreshold: 0.5,     // 50%概率使用屠夫
                        randomChance: 0.25,        // 25%概率随机选择
                        riskTaking: 0.2            // 20%概率冒险使用关键牌
                    };
            }
        }



        // 执行战斗并自动继续
        function executeBattleAndContinue() {
            const battleResult = executeBattle();
            
            // 检查是否需要刺客选择
            if (battleResult.needsAssassinChoice) {
                showAssassinChoiceModal(battleResult);
                return;
            }
            
            // 显示战斗结果宣布
            setTimeout(() => {
                announceBattleResult(battleResult);
            }, 1000); // 1秒后宣布结果
        }

        // 宣布战斗结果
        function announceBattleResult(battleResult) {
            const playerCard = gameState.playerBattleCard;
            const opponentCard = gameState.opponentBattleCard;
            const playerCardData = cardData[playerCard];
            const opponentCardData = cardData[opponentCard];
            
            // 判断胜负结果
            let resultIcon = '⚖️';
            let resultText = '平局';
            let resultColor = '#d4af37';
            
            if (battleResult.playerWon) {
                resultIcon = '🎉';
                resultText = '本回合胜利！';
                resultColor = '#10b981';
            } else if (battleResult.opponentWon) {
                resultIcon = '💔';
                resultText = '本回合失败！';
                resultColor = '#ef4444';
            }
            
            // 创建结果宣布面板
            const announcement = document.createElement('div');
            announcement.className = 'battle-result-announcement';
            announcement.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0.8);
                background: rgba(0,0,0,0.95);
                border: 3px solid #d4af37;
                border-radius: 20px;
                padding: 30px;
                z-index: 10000;
                text-align: center;
                color: #f4e4bc;
                font-family: 'Cinzel', serif;
                box-shadow: 0 10px 30px rgba(0,0,0,0.8);
                max-width: 500px;
                opacity: 0;
                transition: all 0.3s ease-out;
                will-change: transform, opacity;
            `;
            
            // 添加确认按钮的内容结构
            announcement.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">${resultIcon}</div>
                <div style="font-size: 1.8rem; color: ${resultColor}; font-weight: bold; margin-bottom: 15px;">${resultText}</div>
                
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0;">
                    <div style="text-align: center; min-width: 100px;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">${playerCardData.icon}</div>
                        <div style="font-size: 1.1rem; font-weight: bold;">${playerCardData.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">等级 ${playerCardData.level}</div>
                    </div>
                    
                    <div style="font-size: 2rem; color: #d4af37;">⚔️</div>
                    
                    <div style="text-align: center; min-width: 100px;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">${opponentCardData.icon}</div>
                        <div style="font-size: 1.1rem; font-weight: bold;">${opponentCardData.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">等级 ${opponentCardData.level}</div>
                    </div>
                </div>
                
                <div style="background: rgba(212,175,55,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 0.95rem; line-height: 1.4;">${battleResult.description}</div>
                </div>
                
                <div style="font-size: 1rem; color: ${resultColor}; font-weight: bold; margin-bottom: 20px;">
                    ${battleResult.playerWon ? `你的${playerCardData.name}获胜！` :
                      battleResult.opponentWon ? `对手的${opponentCardData.name}获胜！` :
                      '双方同归于尽！'}
                </div>
                
                <div id="confirmationStatus" style="margin: 20px 0; font-size: 0.9rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span id="playerConfirmIcon" style="font-size: 1.2rem;">⏳</span>
                            <span>你的确认</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span>对手确认</span>
                            <span id="aiConfirmIcon" style="font-size: 1.2rem;">⏳</span>
                        </div>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 15px;">
                        ${battleResult.gameEnded ? '游戏即将结束，请确认结果' : '双方确认后进入下一回合'}
                    </div>
                </div>
                
                <button id="confirmBattleResult" style="
                    background: linear-gradient(145deg, #d4af37, #b8941f);
                    color: #2c1810;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-family: 'Cinzel', serif;
                    font-weight: 600;
                    font-size: 1rem;
                    transition: all 0.3s ease;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                ">确认结果</button>
            `;
            
            document.body.appendChild(announcement);
            
            // 使用requestAnimationFrame优化动画
            requestAnimationFrame(() => {
                announcement.style.opacity = '1';
                announcement.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            
            // 绑定确认按钮事件
            const confirmBtn = announcement.querySelector('#confirmBattleResult');
            const playerIcon = announcement.querySelector('#playerConfirmIcon');
            const aiIcon = announcement.querySelector('#aiConfirmIcon');
            
            let playerConfirmed = false;
            let aiConfirmed = false;
            
            confirmBtn.addEventListener('click', () => {
                if (!playerConfirmed) {
                    playerConfirmed = true;
                    playerIcon.textContent = '✅';
                    playerIcon.style.color = '#10b981';
                    confirmBtn.disabled = true;
                    confirmBtn.style.opacity = '0.5';
                    confirmBtn.textContent = '已确认';
                    
                    addLogEntry('📋 你已确认战斗结果，等待对手确认...');
                    
                    // AI延迟确认（1-3秒）
                    setTimeout(() => {
                        if (!aiConfirmed) {
                            aiConfirmed = true;
                            aiIcon.textContent = '✅';
                            aiIcon.style.color = '#10b981';
                            
                            addLogEntry('📋 对手已确认战斗结果！');
                            
                            // 双方都确认后，延迟进入下一回合
                            setTimeout(() => {
                                // 淡出动画
                                announcement.style.opacity = '0';
                                announcement.style.transform = 'translate(-50%, -50%) scale(0.9)';
                                
                                setTimeout(() => {
                                    if (announcement.parentNode) {
                                        announcement.parentNode.removeChild(announcement);
                                    }
                                    
                                    // 如果游戏没有结束，进入下一回合
                                    if (!battleResult.gameEnded) {
                                        proceedToNextRound();
                                    }
                                }, 300);
                            }, 1000);
                        }
                    }, Math.random() * 2000 + 1000); // 1-3秒随机延迟
                }
            });
        }

        // 执行战斗
        function executeBattle() {
            const playerCard = gameState.playerBattleCard;
            const opponentCard = gameState.opponentBattleCard;
            const playerCardData = cardData[playerCard];
            const opponentCardData = cardData[opponentCard];
            
            let battleResult = '';
            let playerSurvives = false;
            let opponentSurvives = false;
            let playerCardIndex = gameState.playerSelectedCard;
            let opponentCardIndex = gameState.opponentHand.findIndex(card => card === opponentCard);
            
            // 检查国王免死效果
            let playerKingImmune = false;
            let opponentKingImmune = false;
            
            if (playerCard === 'king' && gameState.specialEffects.kingImmune) {
                playerKingImmune = true;
                gameState.specialEffects.kingImmune = false;
                addLogEntry('皇家守卫的保护生效：国王本回合免死！');
            }
            
            if (opponentCard === 'king' && gameState.specialEffects.opponentKingImmune) {
                opponentKingImmune = true;
                gameState.specialEffects.opponentKingImmune = false;
                addLogEntry('对手皇家守卫的保护生效：对手国王本回合免死！');
            }
            
            // 战斗优先级处理（按照规则优先级）
            
            // 1. 屠夫优先一切 - 无差别同归于尽
            if (playerCard === 'butcher' || opponentCard === 'butcher') {
                if (playerCard === 'butcher' && opponentCard === 'butcher') {
                    battleResult = '双方屠夫同时发动：血债血偿！双方同归于尽！';
                } else if (playerCard === 'butcher') {
                    if (opponentKingImmune && opponentCard === 'king') {
                        battleResult = '屠夫发动同归于尽，但国王受到皇家守卫保护！屠夫阵亡，国王存活。';
                        opponentSurvives = true;
                    } else {
                        battleResult = `屠夫发动技能：血债血偿！与${opponentCardData.name}同归于尽！`;
                    }
                } else {
                    if (playerKingImmune && playerCard === 'king') {
                        battleResult = '对手屠夫发动同归于尽，但国王受到皇家守卫保护！屠夫阵亡，国王存活。';
                        playerSurvives = true;
                    } else {
                        battleResult = `对手屠夫发动技能：血债血偿！与${playerCardData.name}同归于尽！`;
                    }
                }
            }
            
            // 2. 终极守卫特殊处理 - 优先斩杀刺客
            else if (playerCard === 'ultimateGuard' && opponentCard === 'assassin') {
                battleResult = '终极守卫发动技能：优先斩杀刺客！刺客的技能被无效化。';
                playerSurvives = true;
            } else if (opponentCard === 'ultimateGuard' && playerCard === 'assassin') {
                battleResult = '对手终极守卫发动技能：优先斩杀刺客！刺客的技能被无效化。';
                opponentSurvives = true;
            }
            
            // 3. 刺客技能处理 - 可选择刺杀眼前牌或抽取手牌刺杀
            else if (playerCard === 'assassin' && opponentCard === 'assassin') {
                // 双方刺客同时出现，各自抽取对方手牌刺杀，双方刺客都进入废牌堆
                let playerHandKill = '';
                let opponentHandKill = '';
                
                // 玩家刺客刺杀对手手牌（排除对手当前出的刺客）
                const opponentCardIndex = gameState.opponentHand.findIndex(card => card === opponentCard);
                const opponentAvailableTargets = gameState.opponentHand.filter((_, index) => index !== opponentCardIndex);
                
                if (opponentAvailableTargets.length > 0) {
                    const randomIndex = Math.floor(Math.random() * opponentAvailableTargets.length);
                    const killedCard = opponentAvailableTargets[randomIndex];
                    const killedCardData = cardData[killedCard];
                    
                    // 找到这张牌在原始手牌中的实际索引并移除
                    let actualIndex = -1;
                    let filteredIndex = 0;
                    for (let i = 0; i < gameState.opponentHand.length; i++) {
                        if (i !== opponentCardIndex) {
                            if (filteredIndex === randomIndex) {
                                actualIndex = i;
                                break;
                            }
                            filteredIndex++;
                        }
                    }
                    
                    if (actualIndex !== -1) {
                        gameState.opponentHand.splice(actualIndex, 1);
                    }
                    
                    playerHandKill = `你的刺客刺杀了对手手牌中的${killedCardData.name}！`;
                } else {
                    playerHandKill = '你的刺客发现对手没有其他手牌可刺杀！';
                }
                
                // 对手刺客刺杀玩家手牌（排除玩家当前出的刺客）
                const playerCardIndex = gameState.playerSelectedCard;
                const playerAvailableTargets = gameState.playerHand.filter((_, index) => index !== playerCardIndex);
                
                if (playerAvailableTargets.length > 0) {
                    const randomIndex = Math.floor(Math.random() * playerAvailableTargets.length);
                    const killedCard = playerAvailableTargets[randomIndex];
                    const killedCardData = cardData[killedCard];
                    
                    // 找到这张牌在原始手牌中的实际索引并移除
                    let actualIndex = -1;
                    let filteredIndex = 0;
                    for (let i = 0; i < gameState.playerHand.length; i++) {
                        if (i !== playerCardIndex) {
                            if (filteredIndex === randomIndex) {
                                actualIndex = i;
                                break;
                            }
                            filteredIndex++;
                        }
                    }
                    
                    if (actualIndex !== -1) {
                        // 如果被移除的牌在当前选中牌之前，需要调整选中索引
                        if (actualIndex < gameState.playerSelectedCard) {
                            gameState.playerSelectedCard--;
                        }
                        gameState.playerHand.splice(actualIndex, 1);
                    }
                    
                    opponentHandKill = `对手刺客刺杀了你手牌中的${killedCardData.name}！`;
                } else {
                    opponentHandKill = '对手刺客发现你没有其他手牌可刺杀！';
                }
                
                battleResult = `双方刺客同时出现！刺客的刀只能刺向彼此的影子...双方各自抽取对方手牌刺杀！${playerHandKill} ${opponentHandKill} 双方刺客完成任务后都消失在阴影中。`;
                playerSurvives = false; // 玩家刺客进入废牌堆
                opponentSurvives = false; // 对手刺客进入废牌堆
            } else if (playerCard === 'assassin') {
                // 玩家刺客：需要选择刺杀目标
                return { 
                    needsAssassinChoice: true,
                    playerCard: playerCard,
                    opponentCard: opponentCard,
                    playerCardData: playerCardData,
                    opponentCardData: opponentCardData,
                    playerKingImmune: playerKingImmune,
                    opponentKingImmune: opponentKingImmune
                };
            } else if (opponentCard === 'assassin') {
                // AI刺客：智能选择刺杀目标
                const aiChoice = makeAIAssassinChoice(playerCard, playerCardData, gameState.playerHand);
                
                if (aiChoice === 'hand') {
                    // AI选择抽取玩家手牌刺杀，刺客进入废牌堆
                    // 创建一个排除当前出牌的玩家手牌数组
                    const playerCardIndex = gameState.playerSelectedCard;
                    
                    // 从可刺杀的手牌中移除当前出的牌（按索引排除）
                    const availableTargets = gameState.playerHand.filter((_, index) => index !== playerCardIndex);
                    
                    if (availableTargets.length === 0) {
                        // 如果没有其他手牌可刺杀，强制刺杀眼前的牌
                        if (playerCardData.type === 'key') {
                            if (playerKingImmune && playerCard === 'king') {
                                battleResult = '对手刺客尝试刺杀国王，但国王受到皇家守卫保护！刺客被反杀。';
                                playerSurvives = true;
                                opponentSurvives = false;
                            } else {
                                battleResult = `💀 对手刺客选择刺杀眼前的关键牌${playerCardData.name}！王权陨落！刺客完成任务后消失在阴影中。`;
                                opponentSurvives = false;
                            }
                        } else {
                            battleResult = `对手刺客选择刺杀眼前的${playerCardData.name}！无视等级直接击杀！刺客完成任务后消失在阴影中。`;
                            opponentSurvives = false;
                        }
                    } else {
                        // 随机选择一张可刺杀的手牌
                        const randomTargetIndex = Math.floor(Math.random() * availableTargets.length);
                        const killedCard = availableTargets[randomTargetIndex];
                        const killedCardData = cardData[killedCard];
                        
                        // 找到这张牌在原始手牌中的实际索引并移除
                        let actualIndex = -1;
                        let filteredIndex = 0;
                        for (let i = 0; i < gameState.playerHand.length; i++) {
                            if (i !== playerCardIndex) {
                                if (filteredIndex === randomTargetIndex) {
                                    actualIndex = i;
                                    break;
                                }
                                filteredIndex++;
                            }
                        }
                        
                        if (actualIndex !== -1) {
                            gameState.playerHand.splice(actualIndex, 1);
                            // 如果被移除的牌在当前选中牌之前，需要调整选中索引
                            if (actualIndex < gameState.playerSelectedCard) {
                                gameState.playerSelectedCard--;
                            }
                        }
                        
                        if (killedCardData.type === 'key') {
                            battleResult = `🗡️ 对手刺客选择刺杀你手牌中的关键牌${killedCardData.name}！💀 刺中要害！王权陨落！刺客完成任务后消失在阴影中。你出的${playerCardData.name}回到手牌。`;
                        } else {
                            battleResult = `🗡️ 对手刺客选择刺杀你手牌中的${killedCardData.name}！暗影一击！刺客完成任务后消失在阴影中。你出的${playerCardData.name}回到手牌。`;
                        }
                        
                        opponentSurvives = false; // 刺客完成任务后进入废牌堆
                        playerSurvives = true; // 玩家出的牌回到手牌，但刺客技能成功算对手胜利
                    }
                } else {
                    // AI选择刺杀眼前的牌
                    if (playerCardData.type === 'key') {
                        if (playerKingImmune && playerCard === 'king') {
                            battleResult = '对手刺客尝试刺杀国王，但国王受到皇家守卫保护！刺客被反杀。';
                            playerSurvives = true;
                            opponentSurvives = false; // 刺客被反杀，进入废牌堆
                        } else {
                            battleResult = `💀 对手刺客选择刺杀眼前的关键牌${playerCardData.name}！王权陨落！刺客完成任务后消失在阴影中。`;
                            opponentSurvives = false; // 刺客完成任务后进入废牌堆
                        }
                    } else {
                        battleResult = `对手刺客选择刺杀眼前的${playerCardData.name}！无视等级直接击杀！刺客完成任务后消失在阴影中。`;
                        opponentSurvives = false; // 刺客完成任务后进入废牌堆
                    }
                }
            }
            
            // 4. 奴隶特殊能力 - 能击败国王和女王
            else if (playerCard === 'slave' && (opponentCard === 'king' || opponentCard === 'queen')) {
                if (opponentKingImmune && opponentCard === 'king') {
                    battleResult = '奴隶尝试推翻王权，但国王受到皇家守卫保护！奴隶被镇压。';
                    opponentSurvives = true;
                } else {
                    battleResult = `⚡ 奴隶起义！⚡ 铁链断裂，枷锁粉碎！以血肉之躯推翻那高高在上的${opponentCardData.name}！自由万岁！`;
                    playerSurvives = true;
                    
                    // 添加特殊视觉效果
                    addSlaveRevolutionEffect();
                }
            } else if (opponentCard === 'slave' && (playerCard === 'king' || playerCard === 'queen')) {
                if (playerKingImmune && playerCard === 'king') {
                    battleResult = '对手奴隶尝试推翻王权，但国王受到皇家守卫保护！奴隶被镇压。';
                    playerSurvives = true;
                } else {
                    battleResult = `💥 对手奴隶起义！💥 铁链断裂，推翻了你的${playerCardData.name}！王权陨落！`;
                    opponentSurvives = true;
                    
                    // 添加特殊视觉效果
                    addSlaveRevolutionEffect();
                }
            }
            
            // 5. 普通等级战斗
            else {
                if (playerCardData.level > opponentCardData.level) {
                    battleResult = `${playerCardData.name}(等级${playerCardData.level}) 击败了 ${opponentCardData.name}(等级${opponentCardData.level})！`;
                    playerSurvives = true;
                } else if (opponentCardData.level > playerCardData.level) {
                    battleResult = `${opponentCardData.name}(等级${opponentCardData.level}) 击败了 ${playerCardData.name}(等级${playerCardData.level})！`;
                    opponentSurvives = true;
                } else {
                    battleResult = `双方等级相同(${playerCardData.level})：势均力敌，同归于尽！`;
                }
            }
            
            // 显示战斗结果
            addLogEntry(`⚔️ 战斗结果：${battleResult}`);
            
            // 判断胜负 - 特殊处理刺客技能
            let playerWon = false;
            let opponentWon = false;
            
            // 刺客技能特殊判定：刺客成功使用技能（无论刺杀什么）都算胜利
            if (playerCard === 'assassin' && battleResult.includes('刺杀')) {
                playerWon = true; // 玩家刺客成功刺杀，算玩家胜利
                opponentWon = false;
            } else if (opponentCard === 'assassin' && battleResult.includes('刺杀')) {
                playerWon = false;
                opponentWon = true; // 对手刺客成功刺杀，算对手胜利
            } else {
                // 普通胜负判定
                playerWon = playerSurvives && !opponentSurvives;
                opponentWon = !playerSurvives && opponentSurvives;
            }
            
            // 显示胜负结果
            if (playerWon) {
                addLogEntry(`🎉 本回合胜利！你的${cardData[playerCard].name}击败了对手的${cardData[opponentCard].name}！`);
            } else if (opponentWon) {
                addLogEntry(`💔 本回合失败！对手的${cardData[opponentCard].name}击败了你的${cardData[playerCard].name}！`);
            } else if (!playerSurvives && !opponentSurvives) {
                addLogEntry(`⚖️ 本回合平局！双方卡牌同归于尽！`);
            } else {
                addLogEntry(`🛡️ 本回合平局！双方卡牌都存活！`);
            }
            
            // 更新特殊统计
            updateSpecialStats(playerCard, opponentCard, playerSurvives, battleResult);
            
            // 处理特殊效果（在移除卡牌之前）
            handleSpecialEffects(playerCard, opponentCard, playerSurvives, opponentSurvives);
            
            // 处理卡牌结算：移除阵亡的卡牌，存活的卡牌回到手牌
            if (!playerSurvives) {
                gameState.playerHand.splice(playerCardIndex, 1);
                addLogEntry(`💀 你的${cardData[playerCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 你的${cardData[playerCard].name}存活，回到手牌`);
            }
            
            if (!opponentSurvives) {
                gameState.opponentHand.splice(opponentCardIndex, 1);
                addLogEntry(`💀 对手的${cardData[opponentCard].name}进入废牌区`);
            } else {
                addLogEntry(`🛡️ 对手的${cardData[opponentCard].name}存活，回到手牌`);
            }
            
            // 检查游戏结束条件
            const gameEnded = checkGameEnd();
            
            // 准备下一回合
            if (!gameEnded) {
                gameState.playerSelectedCard = null;
                gameState.currentTurn++;
                gameState.gamePhase = 'roundEnd';
            }
            
            return { 
                gameEnded: gameEnded,
                playerWon: playerWon,
                opponentWon: opponentWon,
                description: battleResult,
                playerSurvives: playerSurvives,
                opponentSurvives: opponentSurvives
            };
        }

        // 处理特殊效果
        function handleSpecialEffects(playerCard, opponentCard, playerSurvives, opponentSurvives) {
            // 皇家守卫效果 - 阵亡后下一回合国王免死
            if (playerCard === 'royalGuard' && !playerSurvives) {
                gameState.specialEffects.kingImmune = true;
                addLogEntry('皇家守卫殉职：陛下在前，生死在后！下一回合国王获得免死效果！');
            }
            if (opponentCard === 'royalGuard' && !opponentSurvives) {
                gameState.specialEffects.opponentKingImmune = true;
                addLogEntry('对手皇家守卫殉职：对手国王下回合获得免死效果！');
            }
            
            // 终极守卫效果 - 使用后需要冷却1回合
            if (playerCard === 'ultimateGuard') {
                gameState.specialEffects.ultimateGuardCooldown = 2; // 设置为2，因为会在下一回合开始时减1
                addLogEntry('🛡️ 终极守卫出战完毕：需要休整1回合才能再次出动！');
            }
            if (opponentCard === 'ultimateGuard') {
                gameState.specialEffects.aiUltimateGuardCooldown = 2; // 设置为2，因为会在下一回合开始时减1
                addLogEntry('🛡️ 对手终极守卫出战完毕：对手需要休整1回合才能再次出动！');
            }
            
            // 女王效果 - 死亡后召唤国王，终极守卫同时殉职
            if (playerCard === 'queen' && !playerSurvives) {
                // 女王死亡时带走对方当前出牌
                if (opponentSurvives) {
                    const opponentIndex = gameState.opponentHand.findIndex(card => card === opponentCard);
                    if (opponentIndex !== -1) {
                        gameState.opponentHand.splice(opponentIndex, 1);
                        addLogEntry(`女王临终反击：带走了对手的${cardData[opponentCard].name}！`);
                    }
                }
                
                // 召唤国王
                gameState.playerHand.push('king');
                addLogEntry('女王陨落：她的陨落，唤醒了真正的王权！国王登场！');
                
                // 终极守卫殉职
                const ultimateGuardIndex = gameState.playerHand.indexOf('ultimateGuard');
                if (ultimateGuardIndex !== -1) {
                    gameState.playerHand.splice(ultimateGuardIndex, 1);
                    addLogEntry('女王死亡：终极守卫与女王同生死，一同殉职！');
                }
            }
            
            if (opponentCard === 'queen' && !opponentSurvives) {
                // 对手女王死亡时带走玩家当前出牌
                if (playerSurvives) {
                    gameState.playerHand.splice(gameState.playerSelectedCard, 1);
                    addLogEntry(`对手女王临终反击：带走了你的${cardData[playerCard].name}！`);
                }
                
                // 召唤国王
                gameState.opponentHand.push('king');
                addLogEntry('对手女王陨落：对手国王登场！');
                
                // 对手终极守卫殉职
                const opponentUltimateGuardIndex = gameState.opponentHand.indexOf('ultimateGuard');
                if (opponentUltimateGuardIndex !== -1) {
                    gameState.opponentHand.splice(opponentUltimateGuardIndex, 1);
                    addLogEntry('对手女王死亡：对手终极守卫殉职！');
                }
            }
        }

        // 检查游戏结束
        function checkGameEnd() {
            // 检查关键牌是否被击杀
            const playerHasKey = gameState.playerHand.some(card => cardData[card].type === 'key');
            const opponentHasKey = gameState.opponentHand.some(card => cardData[card].type === 'key');
            
            if (!playerHasKey && gameState.playerFaction === 'king') {
                endGame('defeat', '你的关键牌被击败！奴隶方获得胜利！');
                return true;
            }
            
            if (!opponentHasKey && gameState.playerFaction === 'slave') {
                endGame('victory', '成功击败对手的关键牌！奴隶起义胜利！');
                return true;
            }
            
            if (playerHasKey && gameState.playerFaction === 'king' && gameState.opponentHand.length === 0) {
                endGame('victory', '消灭了所有反抗力量！王权获得胜利！');
                return true;
            }
            
            if (opponentHasKey && gameState.playerFaction === 'slave' && gameState.playerHand.length === 0) {
                endGame('defeat', '反抗力量被完全消灭！王权获得胜利！');
                return true;
            }
            
            return false;
        }

        // 结束游戏
        function endGame(result, message) {
            gameState.gamePhase = 'ended';
            
            // 计算游戏时长
            const gameDuration = Math.floor((Date.now() - gameState.gameStartTime) / 1000);
            
            // 更新用户统计
            if (result === 'victory') {
                userData.wins++;
                showNotification('恭喜获得胜利！经验值+50', 'success');
            } else {
                userData.losses++;
                showNotification('虽败犹荣！经验值+20', 'info');
            }
            
            // 计算段位变化
            const rankChange = calculateRankChange(result === 'victory');
            
            // 添加战斗记录
            const battleMode = getModeDisplayName(gameState.gameMode || 'ai');
            const opponentName = gameState.opponentData?.name || 'AI对手';
            
            addBattleRecord(
                result,
                opponentName,
                gameState.playerFaction,
                gameState.currentTurn,
                gameDuration,
                battleMode
            );
            
            // 显示段位变化通知
            showRankChangeNotification(rankChange);
            
            updateUserDisplay();
            
            const modal = document.getElementById('gameModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            if (result === 'victory') {
                title.textContent = '🎉 胜利！';
                title.style.color = '#d4af37';
            } else {
                title.textContent = '💀 失败！';
                title.style.color = '#cc4444';
            }
            
            const totalGames = userData.wins + userData.losses;
            const winRate = totalGames > 0 ? Math.round((userData.wins / totalGames) * 100) : 0;
            
            content.innerHTML = `
                <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; text-align: center;">
                    <div style="background: rgba(212,175,55,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; color: #d4af37; font-weight: bold;">${gameState.currentTurn}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">回合数</div>
                    </div>
                    <div style="background: rgba(212,175,55,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; color: #d4af37; font-weight: bold;">${totalGames}</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">总场次</div>
                    </div>
                    <div style="background: rgba(212,175,55,0.1); padding: 15px; border-radius: 8px;">
                        <div style="font-size: 1.5rem; color: #d4af37; font-weight: bold;">${winRate}%</div>
                        <div style="font-size: 0.9rem; opacity: 0.8;">胜率</div>
                    </div>
                </div>
                <p style="margin-top: 20px;">感谢你的精彩对战！</p>
            `;
            
            modal.style.display = 'flex';
        }

        // 自动进入下一回合
        function proceedToNextRound() {
            addLogEntry(`⏰ 5秒后自动进入下一回合...`);
            nextRound();
        }

        // 下一回合
        function nextRound() {
            // 减少终极守卫冷却时间
            if (gameState.specialEffects.ultimateGuardCooldown > 0) {
                gameState.specialEffects.ultimateGuardCooldown--;
                if (gameState.specialEffects.ultimateGuardCooldown === 1) {
                    addLogEntry('⏰ 你的终极守卫还需要休整1回合');
                } else if (gameState.specialEffects.ultimateGuardCooldown === 0) {
                    addLogEntry('🛡️ 你的终极守卫已完成休整，可以再次出动！');
                }
            }
            
            if (gameState.specialEffects.aiUltimateGuardCooldown > 0) {
                gameState.specialEffects.aiUltimateGuardCooldown--;
                if (gameState.specialEffects.aiUltimateGuardCooldown === 1) {
                    addLogEntry('⏰ 对手的终极守卫还需要休整1回合');
                } else if (gameState.specialEffects.aiUltimateGuardCooldown === 0) {
                    addLogEntry('🛡️ 对手的终极守卫已完成休整！');
                }
            }
            
            // 重置回合状态
            gameState.isPlayerTurn = true;
            gameState.gamePhase = 'playing';
            gameState.playerSelectedCard = null;
            
            // 清空战斗区域
            document.getElementById('playerBattleCard').innerHTML = '';
            document.getElementById('opponentBattleCard').innerHTML = '';
            
            // 更新界面
            updateGameUI();
            
            // 下一回合按钮已被自动化，无需显示
            
            addLogEntry(`--- 第 ${gameState.currentTurn} 回合开始 ---`);
        }

        // 重新开始游戏
        function restartGame() {
            // 重置游戏状态
            gameState = {
                playerFaction: null,
                playerOpening: null,
                opponentOpening: null,
                playerHand: [],
                opponentHand: [],
                playerSelectedCard: null,
                opponentSelectedCard: null,
                currentTurn: 1,
                gamePhase: 'setup',
                isPlayerTurn: true,
                playerBattleCard: null,
                opponentBattleCard: null,
                gameStartTime: null,
                specialEffects: {
                    kingImmune: false,
                    opponentKingImmune: false,
                    ultimateGuardCooldown: 0,
                    aiUltimateGuardCooldown: 0
                }
            };
            
            // 隐藏模态框
            document.getElementById('gameModal').style.display = 'none';
            
            // 清空日志
            document.getElementById('gameLog').innerHTML = '';
            
            // 清除阵营选择状态
            document.querySelectorAll('.faction-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelectorAll('.opening-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('openingSelection').style.display = 'none';
            document.getElementById('startGame').disabled = true;
            
            // 返回主界面
            hideAllScreens();
            document.getElementById('introScreen').style.display = 'block';
            showUserStatusBar(); // 显示用户状态栏
            // 清除导航按钮的激活状态
            const navButtons = ['friendsBtn', 'battleBtn', 'historyBtn', 'achievementsBtn', 'profileBtn'];
            navButtons.forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('active');
            });
            showNotification('游戏已重置，返回主界面', 'info');
        }

        // 添加日志条目
        function addLogEntry(message) {
            const log = document.getElementById('gameLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            // 根据消息类型添加不同的前缀
            if (message.includes('回合开始')) {
                entry.textContent = message;
            } else if (message.includes('同时翻开')) {
                entry.textContent = message;
            } else {
                entry.textContent = `${message}`;
            }
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // 奴隶起义特殊视觉效果
        function addSlaveRevolutionEffect() {
            // 创建革命特效容器
            const revolutionEffect = document.createElement('div');
            revolutionEffect.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 9999;
                background: radial-gradient(circle at center, rgba(255,69,0,0.3) 0%, transparent 70%);
                animation: revolutionFlash 2s ease-out;
            `;
            
            // 添加破碎锁链动画
            for (let i = 0; i < 8; i++) {
                const chain = document.createElement('div');
                chain.style.cssText = `
                    position: absolute;
                    font-size: 3rem;
                    color: #ff4500;
                    animation: chainBreak 2s ease-out forwards;
                    animation-delay: ${i * 0.2}s;
                    left: ${20 + i * 10}%;
                    top: ${30 + Math.random() * 40}%;
                `;
                chain.textContent = '⛓️💥';
                revolutionEffect.appendChild(chain);
            }
            
            // 添加自由之光
            const freedomLight = document.createElement('div');
            freedomLight.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 6rem;
                color: #ffd700;
                text-shadow: 0 0 30px #ffd700;
                animation: freedomRise 2s ease-out forwards;
                animation-delay: 1s;
            `;
            freedomLight.textContent = '🗽';
            revolutionEffect.appendChild(freedomLight);
            
            // 添加革命口号
            const slogan = document.createElement('div');
            slogan.style.cssText = `
                position: absolute;
                top: 60%;
                left: 50%;
                transform: translateX(-50%);
                font-size: 2rem;
                color: #ff4500;
                font-weight: bold;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
                animation: sloganAppear 2s ease-out forwards;
                animation-delay: 1.5s;
                opacity: 0;
                font-family: 'Cinzel', serif;
            `;
            slogan.textContent = '⚡ 自由万岁！王权陨落！⚡';
            revolutionEffect.appendChild(slogan);
            
            document.body.appendChild(revolutionEffect);
            
            // 2.5秒后移除效果
            setTimeout(() => {
                if (revolutionEffect.parentNode) {
                    revolutionEffect.parentNode.removeChild(revolutionEffect);
                }
            }, 2500);
            
            // 添加战斗区域震动效果
            const battleArea = document.querySelector('.battle-area');
            if (battleArea) {
                battleArea.style.animation = 'revolutionShake 1s ease-out';
                setTimeout(() => {
                    battleArea.style.animation = '';
                }, 1000);
            }
        }

        // 洗牌功能
        function shuffleHand() {
            if (gameState.gamePhase !== 'playing' || !gameState.isPlayerTurn) {
                showNotification('现在不能洗牌！', 'error');
                return;
            }
            
            if (gameState.playerSelectedCard !== null) {
                showNotification('已选择卡牌，无法洗牌！请先取消选择', 'error');
                return;
            }
            
            // Fisher-Yates 洗牌算法
            const hand = [...gameState.playerHand];
            for (let i = hand.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [hand[i], hand[j]] = [hand[j], hand[i]];
            }
            
            gameState.playerHand = hand;
            
            // 清除任何选择状态
            gameState.playerSelectedCard = null;
            document.getElementById('confirmPlay').disabled = true;
            
            // 重新渲染手牌
            renderPlayerHand();
            
            addLogEntry('🔄 你重新洗了手牌！');
            showNotification('手牌已重新洗牌！', 'success');
        }

        // 显示认输确认
        function showSurrenderConfirm() {
            // 检查游戏状态
            if (gameState.gamePhase === 'ended' || gameState.gamePhase === 'setup') {
                showNotification('游戏未开始或已结束！', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'surrender-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10001;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: linear-gradient(145deg, #3a2817, #2c1810);
                border: 3px solid #ef4444;
                border-radius: 15px;
                padding: 30px;
                text-align: center;
                max-width: 400px;
                margin: 20px;
                color: #f4e4bc;
                font-family: 'Cinzel', serif;
            `;
            
            content.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 15px;">🏳️</div>
                <h3 style="color: #ef4444; margin-bottom: 20px; font-size: 1.8rem;">确认认输？</h3>
                <p style="margin-bottom: 25px; font-size: 1.1rem;">认输将立即结束游戏并记录为失败</p>
                <p style="margin-bottom: 25px; font-size: 0.9rem; opacity: 0.8;">
                    当前回合: ${gameState.currentTurn}<br>
                    剩余手牌: ${gameState.playerHand.length}张<br>
                    对手手牌: ${gameState.opponentHand.length}张
                </p>
                
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button class="confirm-surrender-btn" style="
                        background: linear-gradient(145deg, #ef4444, #dc2626);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">确认认输</button>
                    
                    <button class="cancel-surrender-btn" style="
                        background: linear-gradient(145deg, #6b7280, #4b5563);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-family: 'Cinzel', serif;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    ">继续战斗</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 绑定确认认输
            const confirmBtn = content.querySelector('.confirm-surrender-btn');
            confirmBtn.addEventListener('click', () => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
                surrenderGame();
            });
            
            // 绑定取消认输
            const cancelBtn = content.querySelector('.cancel-surrender-btn');
            cancelBtn.addEventListener('click', () => {
                if (modal.parentNode) {
                    document.body.removeChild(modal);
                }
                showNotification('继续战斗！永不放弃！', 'info');
            });
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                    showNotification('取消认输，继续战斗！', 'info');
                }
            });
        }

        // 认输游戏
        function surrenderGame() {
            // 检查游戏状态
            if (gameState.gamePhase === 'ended') {
                showNotification('游戏已经结束！', 'error');
                return;
            }
            
            if (gameState.gamePhase === 'setup') {
                showNotification('游戏还未开始！', 'error');
                return;
            }
            
            addLogEntry('🏳️ 你选择了认输...');
            addLogEntry('💔 有时候，战略性撤退也是一种智慧。');
            
            // 强制结束游戏
            gameState.gamePhase = 'ended';
            
            endGame('defeat', '你选择了认输。虽败犹荣，下次再来！');
        }

        // 加载用户数据
        function loadUserData() {
            try {
                const savedData = localStorage.getItem('kingAndSlaveUser');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // 合并保存的数据到用户数据，保持默认值
                    userData = { ...userData, ...parsedData };
                    console.log('用户数据加载成功:', userData);
                    return true;
                }
            } catch (e) {
                console.warn('加载用户数据失败:', e);
            }
            return false;
        }

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，开始初始化游戏...');
            
            // 尝试加载用户数据
            const hasUserData = loadUserData();
            
            if (hasUserData) {
                // 有用户数据，直接进入主界面
                console.log('检测到用户数据，跳过登录界面');
                
                // 仍需要初始化所有系统和事件绑定
                initAllSystems();
                
                hideAllScreens();
                document.getElementById('introScreen').style.display = 'block';
                hideUserStatusBar();
                updateUserDisplay();
                checkAchievements();
                showNotification(`欢迎回来，${userData.username}！`, 'success');
            } else {
                // 没有用户数据，显示登录界面
                console.log('未检测到用户数据，显示登录界面');
                initGame();
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'991ee684628b9245',t:'MTc2MTAzMDI2Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
