<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‹ä¸å¥´ - ä¸­ä¸–çºªå¡ç‰Œå¯¹æˆ˜</title>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #2c1810 0%, #8b4513 50%, #2c1810 100%);
            color: #f4e4bc;
            min-height: 100%;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .game-header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #d4af37;
        }

        .game-title {
            font-size: 2rem;
            color: #d4af37;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            margin: 0;
        }

        .game-subtitle {
            font-size: 1.2rem;
            margin: 10px 0;
            color: #f4e4bc;
        }

        .setup-screen {
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #8b4513;
            text-align: center;
        }

        .mode-selection {
            margin-bottom: 30px;
        }

        .mode-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .mode-card {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 3px solid #8b4513;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
        }

        .mode-card:hover {
            border-color: #d4af37;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }

        .mode-card.selected {
            border-color: #d4af37;
            background: linear-gradient(145deg, #4a3827, #3c2820);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .mode-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .mode-name {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .faction-selection-screen {
            margin-bottom: 20px;
        }

        .faction-selection {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .faction-card {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 3px solid #8b4513;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            text-align: center;
        }

        .faction-card:hover {
            border-color: #d4af37;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }

        .faction-card.selected {
            border-color: #d4af37;
            background: linear-gradient(145deg, #4a3827, #3c2820);
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }

        .faction-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .faction-name {
            font-size: 1.5rem;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .opening-selection {
            margin: 20px 0;
        }

        .opening-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .opening-btn {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 2px solid #d4af37;
            color: #f4e4bc;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .opening-btn:hover {
            background: linear-gradient(145deg, #a0522d, #8b4513);
            transform: translateY(-2px);
        }

        .opening-btn.selected {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #2c1810;
        }

        .start-btn {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: none;
            color: #2c1810;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(212, 175, 55, 0.4);
        }

        .start-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .back-btn {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 2px solid #d4af37;
            color: #f4e4bc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: linear-gradient(145deg, #a0522d, #8b4513);
            transform: translateY(-2px);
        }

        .game-board {
            display: none;
            grid-template-columns: 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 15px;
            height: 90vh;
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-game-area {
            grid-column: 1;
            grid-row: 3;
            display: grid;
            grid-template-rows: 1fr auto 1fr;
            gap: 15px;
            min-height: 0;
        }



        .opponent-area, .player-area {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #8b4513;
        }

        .opponent-area {
            border-color: #4a90e2;
        }

        .player-area {
            border-color: #d4af37;
        }

        .battle-area {
            background: rgba(0,0,0,0.5);
            border-radius: 20px;
            padding: 50px 40px;
            border: 4px solid #d4af37;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 300px;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
        }

        .played-card {
            width: 160px;
            height: 240px;
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 4px solid #8b4513;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            transition: all 0.5s ease;
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .played-card.revealed {
            transform: rotateY(180deg);
        }

        .vs-text {
            font-size: 2.5rem;
            color: #d4af37;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            font-weight: bold;
            margin: 0 20px;
        }

        .hand-cards {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .card {
            width: 100px;
            height: 150px;
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 2px solid #8b4513;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            position: relative;
        }

        .card:hover {
            transform: translateY(-10px);
            border-color: #d4af37;
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
        }

        .card.selected {
            border-color: #d4af37;
            background: linear-gradient(145deg, #4a3827, #3c2820);
            transform: translateY(-15px);
        }

        .card-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .card-name {
            font-size: 0.8rem;
            color: #d4af37;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .card-level {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #d4af37;
            color: #2c1810;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .card-description {
            font-size: 0.6rem;
            color: #f4e4bc;
            text-align: center;
            line-height: 1.2;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .faction-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .faction-icon-small {
            font-size: 1.5rem;
        }

        .hand-count {
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid #8b4513;
        }

        .play-btn {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: none;
            color: #2c1810;
            padding: 12px 25px;
            font-size: 1.1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(212, 175, 55, 0.4);
        }

        .play-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .battle-result {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: 
                linear-gradient(145deg, rgba(0,0,0,0.95), rgba(44,24,16,0.9)),
                radial-gradient(circle at center, rgba(139,69,19,0.3), transparent 70%);
            border-radius: 15px;
            border: 3px solid #d4af37;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.8),
                inset 0 2px 4px rgba(212,175,55,0.2);
            backdrop-filter: blur(5px);
        }

        .result-text {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #f4e4bc;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            font-weight: 500;
            line-height: 1.5;
        }

        .continue-btn {
            background: linear-gradient(145deg, #228b22, #006400);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }

        .continue-btn:hover {
            background: linear-gradient(145deg, #32cd32, #228b22);
        }

        .turn-indicator {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
            font-size: 1.3rem;
            color: #d4af37;
        }

        .phase-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .phase-step {
            background: rgba(0,0,0,0.3);
            border: 2px solid #8b4513;
            border-radius: 8px;
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .phase-step.active {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
        }

        .phase-step.completed {
            border-color: #228b22;
            background: rgba(34, 139, 34, 0.2);
            color: #90ee90;
        }

        .current-player-indicator {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
            color: #d4af37;
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: smoothFadeIn 0.6s ease-out;
        }

        @keyframes smoothFadeIn {
            0% { 
                opacity: 0;
            }
            100% { 
                opacity: 1;
            }
        }

        .game-over-modal {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 8px solid #2c1810;
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            max-width: 600px;
            min-width: 400px;
            min-height: 400px;
            position: relative;
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.8),
                inset 0 2px 4px rgba(212, 175, 55, 0.3);
            animation: smoothEntrance 0.8s ease-out;
            transform-origin: center;
            overflow: hidden;
        }

        @keyframes smoothEntrance {
            0% { 
                transform: scale(0.8) translateY(-30px);
                opacity: 0;
            }
            100% { 
                transform: scale(1) translateY(0px);
                opacity: 1;
            }
        }

        .game-over-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.1);
            border-radius: 12px;
            pointer-events: none;
        }

        .winner-text {
            font-size: 3rem;
            color: #d4af37;
            margin: 30px 0 20px 0;
            text-shadow: 
                3px 3px 6px rgba(0,0,0,0.8),
                0 0 20px rgba(212, 175, 55, 0.6);
            animation: gentleGlow 3s ease-in-out infinite alternate;
            position: relative;
            z-index: 3;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        @keyframes gentleGlow {
            0% { 
                text-shadow: 
                    3px 3px 6px rgba(0,0,0,0.8),
                    0 0 15px rgba(212, 175, 55, 0.5);
            }
            100% { 
                text-shadow: 
                    3px 3px 6px rgba(0,0,0,0.8),
                    0 0 25px rgba(212, 175, 55, 0.8);
            }
        }

        @keyframes pulse {
            0% { 
                opacity: 0.7;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.05);
            }
            100% { 
                opacity: 0.7;
                transform: scale(1);
            }
        }

        .victory-banner {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #d4af37, #b8860b);
            color: #2c1810;
            padding: 10px 30px;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            border: 2px solid #2c1810;
            z-index: 4;
            text-transform: uppercase;
        }

        .corner-decoration {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #d4af37;
            border: 1px solid #2c1810;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .corner-decoration:nth-child(1) { top: 10px; left: 10px; }
        .corner-decoration:nth-child(2) { top: 10px; right: 10px; }
        .corner-decoration:nth-child(3) { bottom: 10px; left: 10px; }
        .corner-decoration:nth-child(4) { bottom: 10px; right: 10px; }

        .history-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: smoothFadeIn 0.6s ease-out;
        }

        .history-content {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .history-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #8b4513;
            padding-bottom: 15px;
        }

        .history-title {
            font-size: 2rem;
            color: #d4af37;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .history-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #8b4513;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.8rem;
            color: #d4af37;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #f4e4bc;
            margin-top: 5px;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: rgba(0,0,0,0.4);
            border: 1px solid #8b4513;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            border-color: #d4af37;
            background: rgba(0,0,0,0.6);
        }

        .history-item.victory {
            border-left: 4px solid #32cd32;
        }

        .history-item.defeat {
            border-left: 4px solid #dc143c;
        }

        .history-item.draw {
            border-left: 4px solid #ffd700;
        }

        .history-item.completed {
            border-left: 4px solid #8b4513;
        }

        .game-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .game-result {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .game-result.victory { color: #32cd32; }
        .game-result.defeat { color: #dc143c; }
        .game-result.draw { color: #ffd700; }

        .game-details {
            font-size: 0.9rem;
            color: #f4e4bc;
            line-height: 1.4;
        }

        .game-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #999;
            margin-top: 8px;
        }

        .close-history-btn {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 2px solid #d4af37;
            color: #f4e4bc;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .close-history-btn:hover {
            background: linear-gradient(145deg, #a0522d, #8b4513);
            transform: translateY(-2px);
        }

        .clear-history-btn {
            background: linear-gradient(145deg, #8b0000, #654321);
            border: 2px solid #dc143c;
            color: #f4e4bc;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .clear-history-btn:hover {
            background: linear-gradient(145deg, #a0522d, #8b0000);
            transform: translateY(-1px);
        }

        .profile-section {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .profile-avatar-section {
            text-align: center;
            flex: 0 0 auto;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: 4px solid #2c1810;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 15px auto;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
        }

        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
        }

        .avatar-option {
            width: 40px;
            height: 40px;
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 2px solid #8b4513;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            border-color: #d4af37;
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(212, 175, 55, 0.3);
        }

        .avatar-option.selected {
            border-color: #d4af37;
            background: linear-gradient(145deg, #4a3827, #3c2820);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .profile-info {
            flex: 1;
            min-width: 250px;
        }

        .profile-name-section {
            margin-bottom: 25px;
        }

        .profile-input {
            width: 100%;
            padding: 12px 15px;
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 2px solid #8b4513;
            border-radius: 8px;
            color: #f4e4bc;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .profile-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .profile-input::placeholder {
            color: #999;
        }

        .profile-title-section {
            margin-bottom: 20px;
        }

        .player-title {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            color: #2c1810;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(212, 175, 55, 0.3);
        }

        .title-progress {
            margin-top: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #32cd32, #228b22);
            border-radius: 4px;
            transition: width 0.5s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #999;
            text-align: center;
        }

        .profile-achievements {
            margin-bottom: 30px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #8b4513;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .achievement-item {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .achievement-item.unlocked {
            border-color: #d4af37;
            background: linear-gradient(145deg, #4a3827, #3c2820);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        .achievement-item.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .achievement-name {
            font-size: 1rem;
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 0.8rem;
            color: #f4e4bc;
            line-height: 1.3;
        }

        .achievement-progress {
            font-size: 0.7rem;
            color: #999;
            margin-top: 5px;
        }

        .profile-stats-detailed {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #8b4513;
        }

        .detailed-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 2px solid #8b4513;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #d4af37;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.5rem;
            color: #d4af37;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-name {
            font-size: 0.8rem;
            color: #f4e4bc;
        }

        @media (max-width: 768px) {
            .profile-section {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
            }
            
            .detailed-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .restart-btn {
            background: linear-gradient(145deg, #d4af37, #b8860b);
            border: 3px solid #2c1810;
            color: #2c1810;
            padding: 18px 40px;
            font-size: 1.3rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            position: relative;
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 
                0 6px 15px rgba(0,0,0,0.4),
                inset 0 2px 4px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.3);
        }

        .restart-btn:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 20px rgba(212, 175, 55, 0.5),
                0 5px 15px rgba(0,0,0,0.6),
                inset 0 2px 4px rgba(255,255,255,0.4),
                inset 0 -2px 4px rgba(0,0,0,0.2);
            background: linear-gradient(145deg, #e6c547, #c9971b);
            filter: brightness(1.1);
        }

        .restart-btn:active {
            transform: translateY(-1px);
            box-shadow: 
                0 4px 8px rgba(212, 175, 55, 0.3),
                inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .special-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            color: #ff6b6b;
            font-weight: bold;
            animation: specialEffect 2s ease-out;
            pointer-events: none;
        }

        @keyframes specialEffect {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
        }

        .assassin-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .assassin-modal {
            background: linear-gradient(145deg, #3a2817, #2c1810);
            border: 3px solid #d4af37;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            max-width: 500px;
        }

        .assassin-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .assassin-option {
            background: linear-gradient(145deg, #8b4513, #654321);
            border: 2px solid #d4af37;
            color: #f4e4bc;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .assassin-option:hover {
            background: linear-gradient(145deg, #a0522d, #8b4513);
            transform: translateY(-2px);
        }

        @keyframes slideDown {
            0% { 
                transform: translate(-50%, -100%); 
                opacity: 0; 
            }
            100% { 
                transform: translate(-50%, 0); 
                opacity: 1; 
            }
        }

        @media (max-width: 768px) {
            .game-title { font-size: 2rem; }
            .faction-selection { flex-direction: column; align-items: center; }
            .mode-buttons { flex-direction: column; align-items: center; }
            
            .game-board {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
                min-height: 100vh;
                gap: 10px;
            }
            
            .main-game-area {
                grid-column: 1;
                grid-row: 3;
                gap: 10px;
            }
            
            .battle-area { 
                flex-direction: column; 
                gap: 20px; 
                padding: 30px 15px;
                min-height: 300px;
            }
            .hand-cards { gap: 5px; }
            .card { width: 75px; height: 110px; font-size: 0.75rem; }
            .played-card { width: 120px; height: 170px; }
            .vs-text { font-size: 1.8rem; margin: 10px 0; }
            

        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1 class="game-title">âš”ï¸ ç‹ä¸å¥´ âš”ï¸</h1>
            <p class="game-subtitle">ä¸­ä¸–çºªå¡ç‰Œå›åˆåˆ¶å¯¹æˆ˜æ¸¸æˆ</p>
            <p style="font-size: 0.9rem; margin: 5px 0;">ç‹æƒä¸æ·é”åœ¨åŒä¸€æ¡Œä¸Šè¾ƒé‡</p>
        </div>

        <div id="setupScreen" class="setup-screen">
            <div id="modeSelection" class="mode-selection">
                <h2 style="color: #d4af37; margin-bottom: 20px;">é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
                <div class="mode-buttons">
                    <div class="mode-card" data-mode="ai">
                        <div class="mode-icon">ğŸ¤–</div>
                        <div class="mode-name">ä¸AIå¯¹æˆ˜</div>
                        <p>æŒ‘æˆ˜æ™ºèƒ½AIå¯¹æ‰‹<br>å•äººæ¸¸æˆä½“éªŒ</p>
                    </div>
                    <div class="mode-card" data-mode="local">
                        <div class="mode-icon">ğŸ‘¥</div>
                        <div class="mode-name">æœ¬åœ°å¯¹æˆ˜</div>
                        <p>ä¸æœ‹å‹é¢å¯¹é¢å¯¹æˆ˜<br>åŒäººè½®æµæ¸¸æˆ</p>
                    </div>
                </div>
            </div>

            <div id="factionSelection" class="faction-selection-screen" style="display: none;">
                <h2 style="color: #d4af37; margin-bottom: 20px;">é€‰æ‹©ä½ çš„é˜µè¥</h2>
                
                <div class="faction-selection">
                    <div class="faction-card" data-faction="king">
                        <div class="faction-icon">ğŸ‘‘</div>
                        <div class="faction-name">å›½ç‹æ–¹</div>
                        <p>å®ˆæŠ¤ç‹åº§çš„ç»Ÿæ²»è€…<br>æ‹¥æœ‰å¼ºå¤§çš„å…³é”®ç‰Œ</p>
                    </div>
                    
                    <div class="faction-card" data-faction="slave">
                        <div class="faction-icon">ğŸ©¸</div>
                        <div class="faction-name">å¥´éš¶æ–¹</div>
                        <p>æ¸´æœ›æ¨ç¿»ç»Ÿæ²»çš„åå›è€…<br>ä»¥å¼±èƒœå¼ºçš„æŒ‘æˆ˜è€…</p>
                    </div>
                </div>

                <div id="openingSelection" class="opening-selection" style="display: none;">
                    <h3 style="color: #d4af37;">é€‰æ‹©å¼€å±€æ–¹å¼</h3>
                    <div class="opening-buttons">
                        <button class="opening-btn" data-opening="king">ğŸ‘‘ å›½ç‹å¼€å±€</button>
                        <button class="opening-btn" data-opening="queen">ğŸ’ å¥³ç‹å¼€å±€</button>
                    </div>
                    <p style="font-size: 0.9rem; margin-top: 10px; color: #f4e4bc;">ä¸åŒå¼€å±€æ‹¥æœ‰ä¸åŒçš„å¡ç‰Œç»„åˆå’Œç­–ç•¥</p>
                </div>

                <div style="margin-top: 20px;">
                    <button id="backToModeBtn" class="back-btn">è¿”å›</button>
                    <button id="startGame" class="start-btn" disabled>å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px; flex-wrap: wrap;">
                <button id="showHistoryBtn" class="start-btn" style="background: linear-gradient(145deg, #8b4513, #654321);">æŸ¥çœ‹æˆ˜ç»©</button>
                <button id="showProfileBtn" class="start-btn" style="background: linear-gradient(145deg, #4a90e2, #2c5aa0);">ä¸ªäººä¸»é¡µ</button>
            </div>
        </div>

        <div id="gameBoard" class="game-board">
            <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 10px; grid-column: 1; grid-row: 1; padding: 0 20px;">
                <button id="backToHomeBtn" class="back-btn">ä¸»é¡µ</button>
            </div>
            
            <div id="turnIndicator" class="turn-indicator" style="grid-column: 1; grid-row: 2;">
                <div>ç¬¬ <span id="turnNumber">1</span> å›åˆ</div>
                <div class="phase-indicator">
                    <div class="phase-step active" id="phaseSelect">é€‰æ‹©å¡ç‰Œ</div>
                    <div class="phase-step" id="phaseReveal">åŒæ—¶ç¿»ç‰Œ</div>
                    <div class="phase-step" id="phaseBattle">æˆ˜æ–—ç»“ç®—</div>
                    <div class="phase-step" id="phaseEnd">å›åˆç»“æŸ</div>
                </div>
            </div>

            <div class="main-game-area">
                <div class="opponent-area">
                    <div id="currentPlayerIndicator" class="current-player-indicator" style="display: none;">
                        è½®åˆ°ä½ äº†ï¼è¯·é€‰æ‹©å¡ç‰Œ
                    </div>
                    <div class="game-info">
                        <div class="faction-info">
                            <span id="opponentFaction" class="faction-icon-small">ğŸ¤–</span>
                            <span id="opponentName">AIå¯¹æ‰‹</span>
                        </div>
                        <div class="hand-count">
                            æ‰‹ç‰Œ: <span id="opponentHandCount">6</span>
                        </div>
                    </div>
                    <div id="opponentHandCards" class="hand-cards" style="display: none;"></div>
                    <div style="text-align: center; color: #4a90e2;">å¯¹æ‰‹åŒºåŸŸ</div>
                </div>

                <div class="battle-area">
                    <div id="opponentPlayedCard" class="played-card">
                        <div style="font-size: 1.2rem;">ç­‰å¾…å‡ºç‰Œ</div>
                    </div>
                    <div class="vs-text">âš”ï¸ VS âš”ï¸</div>
                    <div id="playerPlayedCard" class="played-card">
                        <div style="font-size: 1.2rem;">ç­‰å¾…å‡ºç‰Œ</div>
                    </div>
                </div>

                <div class="player-area">
                    <div id="currentPlayerIndicator2" class="current-player-indicator" style="display: none;">
                        è½®åˆ°ä½ äº†ï¼è¯·é€‰æ‹©å¡ç‰Œ
                    </div>
                    <div class="game-info">
                        <div class="faction-info">
                            <span id="playerFaction" class="faction-icon-small">ğŸ‘‘</span>
                            <span id="playerFactionName">å›½ç‹æ–¹</span>
                        </div>
                        <div class="hand-count">
                            æ‰‹ç‰Œ: <span id="playerHandCount">6</span>
                        </div>
                    </div>
                    <div id="playerHand" class="hand-cards"></div>
                    <div style="display: flex; gap: 15px; justify-content: center; margin-top: 15px;">
                        <button id="playCardBtn" class="play-btn" disabled>å‡ºç‰Œ</button>
                        <button id="surrenderBtn" class="back-btn" style="background: linear-gradient(145deg, #8b0000, #654321); border-color: #dc143c;">è®¤è¾“</button>
                    </div>
                </div>
            </div>


        </div>

        <div id="battleResult" class="battle-result" style="display: none;">
            <div id="resultText" class="result-text"></div>
            <button id="continueBtn" class="continue-btn">ç»§ç»­</button>
        </div>

        <div id="gameOver" class="game-over" style="display: none;">
            <div class="game-over-modal">
                <div class="corner-decoration"></div>
                <div class="corner-decoration"></div>
                <div class="corner-decoration"></div>
                <div class="corner-decoration"></div>
                <div class="victory-banner">ğŸ† æ¸¸æˆç»“æŸ ğŸ†</div>
                <div id="winnerText" class="winner-text"></div>
                <p id="gameOverReason" style="font-size: 1.4rem; margin-bottom: 35px; color: #f4e4bc; position: relative; z-index: 3; line-height: 1.6; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); font-weight: 500; letter-spacing: 0.5px; max-width: 500px; margin-left: auto; margin-right: auto;"></p>
                <div style="margin: 20px 0; font-size: 1.2rem; color: #d4af37; position: relative; z-index: 3; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); font-weight: bold;">
                    âš”ï¸ æˆ˜æ–—å·²è½ä¸‹å¸·å¹• âš”ï¸
                </div>
                <button id="restartBtn" class="restart-btn">é‡æ–°å¼€å§‹</button>
            </div>
        </div>

        <div id="assassinSelection" class="assassin-selection">
            <div class="assassin-modal">
                <h3 style="color: #d4af37; margin-bottom: 20px;">ğŸ”ª åˆºå®¢æŠ€èƒ½å‘åŠ¨</h3>
                <p style="margin-bottom: 20px;">é€‰æ‹©åˆºæ€ç›®æ ‡ï¼š</p>
                <div id="assassinOptions" class="assassin-options"></div>
            </div>
        </div>

        <div id="historyModal" class="history-modal">
            <div class="history-content">
                <div class="history-header">
                    <h2 class="history-title">âš”ï¸ å†å²æˆ˜ç»© âš”ï¸</h2>
                </div>
                
                <div id="historyStats" class="history-stats">
                    <div class="stat-item">
                        <span id="totalGames" class="stat-number">0</span>
                        <div class="stat-label">æ€»åœºæ¬¡</div>
                    </div>
                    <div class="stat-item">
                        <span id="victories" class="stat-number">0</span>
                        <div class="stat-label">èƒœåˆ©</div>
                    </div>
                    <div class="stat-item">
                        <span id="defeats" class="stat-number">0</span>
                        <div class="stat-label">å¤±è´¥</div>
                    </div>
                    <div class="stat-item">
                        <span id="draws" class="stat-number">0</span>
                        <div class="stat-label">å¹³å±€</div>
                    </div>
                    <div class="stat-item">
                        <span id="winRate" class="stat-number">0%</span>
                        <div class="stat-label">èƒœç‡</div>
                    </div>
                </div>

                <div id="historyList" class="history-list">
                    <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div style="text-align: center;">
                    <button id="closeHistoryBtn" class="close-history-btn">å…³é—­</button>
                    <button id="clearHistoryBtn" class="clear-history-btn">æ¸…ç©ºè®°å½•</button>
                </div>
            </div>
        </div>

        <div id="profileModal" class="history-modal">
            <div class="history-content">
                <div class="history-header">
                    <h2 class="history-title">ğŸ‘¤ ä¸ªäººä¸»é¡µ ğŸ‘¤</h2>
                </div>
                
                <div class="profile-section">
                    <div class="profile-avatar-section">
                        <div id="profileAvatar" class="profile-avatar">âš”ï¸</div>
                        <div class="avatar-options">
                            <div class="avatar-option" data-avatar="âš”ï¸">âš”ï¸</div>
                            <div class="avatar-option" data-avatar="ğŸ‘‘">ğŸ‘‘</div>
                            <div class="avatar-option" data-avatar="ğŸ©¸">ğŸ©¸</div>
                            <div class="avatar-option" data-avatar="ğŸ›¡ï¸">ğŸ›¡ï¸</div>
                            <div class="avatar-option" data-avatar="ğŸ—¡ï¸">ğŸ—¡ï¸</div>
                            <div class="avatar-option" data-avatar="ğŸ°">ğŸ°</div>
                            <div class="avatar-option" data-avatar="âš¡">âš¡</div>
                            <div class="avatar-option" data-avatar="ğŸ”¥">ğŸ”¥</div>
                        </div>
                    </div>
                    
                    <div class="profile-info">
                        <div class="profile-name-section">
                            <label for="playerName" style="color: #d4af37; font-weight: bold; margin-bottom: 8px; display: block;">ç©å®¶æ˜µç§°ï¼š</label>
                            <input type="text" id="playerName" class="profile-input" placeholder="è¾“å…¥ä½ çš„æ˜µç§°" maxlength="12">
                        </div>
                        
                        <div class="profile-title-section">
                            <label style="color: #d4af37; font-weight: bold; margin-bottom: 8px; display: block;">ç§°å·ï¼š</label>
                            <div id="playerTitle" class="player-title">æ–°æ‰‹å‹‡å£«</div>
                            <div class="title-progress">
                                <div class="progress-bar">
                                    <div id="titleProgress" class="progress-fill"></div>
                                </div>
                                <div id="titleProgressText" class="progress-text">0/5 èƒœåˆ©è§£é”ä¸‹ä¸€ç§°å·</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="profile-achievements">
                    <h3 style="color: #d4af37; margin-bottom: 15px; text-align: center;">ğŸ† æˆå°±ç³»ç»Ÿ ğŸ†</h3>
                    <div id="achievementsList" class="achievements-grid">
                        <!-- æˆå°±å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="profile-stats-detailed">
                    <h3 style="color: #d4af37; margin-bottom: 15px; text-align: center;">ğŸ“Š è¯¦ç»†ç»Ÿè®¡ ğŸ“Š</h3>
                    <div class="detailed-stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">âš”ï¸</div>
                            <div class="stat-value" id="totalBattles">0</div>
                            <div class="stat-name">æ€»æˆ˜æ–—æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ‘‘</div>
                            <div class="stat-value" id="kingWins">0</div>
                            <div class="stat-name">å›½ç‹æ–¹èƒœåˆ©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ©¸</div>
                            <div class="stat-value" id="slaveWins">0</div>
                            <div class="stat-name">å¥´éš¶æ–¹èƒœåˆ©</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ”¥</div>
                            <div class="stat-value" id="winStreak">0</div>
                            <div class="stat-name">æœ€é«˜è¿èƒœ</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">â±ï¸</div>
                            <div class="stat-value" id="avgGameTime">0åˆ†</div>
                            <div class="stat-name">å¹³å‡æ¸¸æˆæ—¶é•¿</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ğŸ¯</div>
                            <div class="stat-value" id="favoriteCard">å¸‚æ°‘</div>
                            <div class="stat-name">æœ€å¸¸ç”¨å¡ç‰Œ</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button id="saveProfileBtn" class="close-history-btn" style="background: linear-gradient(145deg, #32cd32, #228b22); border-color: #32cd32;">ä¿å­˜è®¾ç½®</button>
                    <button id="closeProfileBtn" class="close-history-btn">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            gameMode: null, // 'ai' æˆ– 'local'
            playerFaction: null,
            playerOpening: null,
            player1Hand: [], // æœ¬åœ°å¯¹æˆ˜æ—¶çš„ç©å®¶1æ‰‹ç‰Œ
            player2Hand: [], // æœ¬åœ°å¯¹æˆ˜æ—¶çš„ç©å®¶2æ‰‹ç‰Œ
            playerHand: [], // AIå¯¹æˆ˜æ—¶çš„ç©å®¶æ‰‹ç‰Œ
            opponentHand: [], // AIå¯¹æˆ˜æ—¶çš„å¯¹æ‰‹æ‰‹ç‰Œ
            currentPlayer: 1, // æœ¬åœ°å¯¹æˆ˜æ—¶çš„å½“å‰ç©å®¶ (1 æˆ– 2)
            playerSelectedCard: null,
            opponentSelectedCard: null,
            playerPlayedCard: null,
            opponentPlayedCard: null,
            gamePhase: 'setup', // setup, select, reveal, battle, end, gameOver
            currentTurn: 1,
            royalGuardProtection: false,
            ultimateGuardUsedLastTurn: false,
            queenDead: false,
            kingInPlay: false,
            opponentReady: false,
            playerReady: false,
            player1Ready: false, // æœ¬åœ°å¯¹æˆ˜ä¸“ç”¨
            player2Ready: false, // æœ¬åœ°å¯¹æˆ˜ä¸“ç”¨
            currentGameRecord: {
                gameId: null,
                startTime: null,
                gameMode: null,
                playerFaction: null,
                playerOpening: null,
                opponentFaction: null,
                battles: [],
                result: null,
                endTime: null,
                totalTurns: 0
            }
        };

        // å†å²æˆ˜ç»©å­˜å‚¨ - å¢å¼ºé”™è¯¯å¤„ç†
        let gameHistory = [];
        let playerProfile = {
            name: '',
            avatar: 'âš”ï¸',
            title: 'æ–°æ‰‹å‹‡å£«',
            achievements: [],
            stats: {
                totalBattles: 0,
                kingWins: 0,
                slaveWins: 0,
                maxWinStreak: 0,
                currentWinStreak: 0,
                totalGameTime: 0,
                cardUsageCount: {}
            }
        };

        // å®‰å…¨åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®
        function loadLocalData() {
            try {
                const historyData = localStorage.getItem('kingSlaveGameHistory');
                if (historyData) {
                    gameHistory = JSON.parse(historyData);
                    console.log('åŠ è½½å†å²è®°å½•:', gameHistory.length, 'æ¡');
                }
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                gameHistory = [];
            }

            try {
                const profileData = localStorage.getItem('kingSlavePlayerProfile');
                if (profileData) {
                    const loadedProfile = JSON.parse(profileData);
                    playerProfile = { ...playerProfile, ...loadedProfile };
                    console.log('åŠ è½½ç©å®¶æ¡£æ¡ˆ:', playerProfile);
                }
            } catch (e) {
                console.error('åŠ è½½ç©å®¶æ¡£æ¡ˆå¤±è´¥:', e);
            }
        }

        // å®‰å…¨ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            try {
                localStorage.setItem('kingSlaveGameHistory', JSON.stringify(gameHistory));
                localStorage.setItem('kingSlavePlayerProfile', JSON.stringify(playerProfile));
                console.log('æ•°æ®ä¿å­˜æˆåŠŸ - å†å²è®°å½•:', gameHistory.length, 'æ¡');
                return true;
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
                // æ˜¾ç¤ºä¿å­˜å¤±è´¥æç¤º
                showNotification('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å­˜å‚¨æƒé™', 'error');
                return false;
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'error' ? 'linear-gradient(145deg, #dc143c, #8b0000)' : 'linear-gradient(145deg, #32cd32, #228b22)'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: bold;
                animation: slideDown 0.3s ease-out;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideDown 0.3s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½æ•°æ®
        loadLocalData();

        // ç§°å·ç³»ç»Ÿ
        const titleSystem = [
            { name: 'æ–°æ‰‹å‹‡å£«', requirement: 0, icon: 'ğŸ”°' },
            { name: 'è§ä¹ éª‘å£«', requirement: 5, icon: 'âš”ï¸' },
            { name: 'ç‹å®¤æŠ¤å«', requirement: 15, icon: 'ğŸ›¡ï¸' },
            { name: 'å®«å»·å‰‘å£«', requirement: 30, icon: 'ğŸ—¡ï¸' },
            { name: 'ä¼ å¥‡è‹±é›„', requirement: 50, icon: 'ğŸ†' },
            { name: 'ç‹åº§å¾æœè€…', requirement: 100, icon: 'ğŸ‘‘' },
            { name: 'ä¸æœ½ä¼ è¯´', requirement: 200, icon: 'â­' }
        ];

        // æˆå°±ç³»ç»Ÿ
        const achievementSystem = [
            {
                id: 'first_victory',
                name: 'åˆæ¬¡èƒœåˆ©',
                description: 'èµ¢å¾—ä½ çš„ç¬¬ä¸€åœºèƒœåˆ©',
                icon: 'ğŸ‰',
                requirement: { type: 'victories', count: 1 },
                unlocked: false
            },
            {
                id: 'win_streak_5',
                name: 'è¿èƒœè¾¾äºº',
                description: 'è¿ç»­è·å¾—5åœºèƒœåˆ©',
                icon: 'ğŸ”¥',
                requirement: { type: 'winStreak', count: 5 },
                unlocked: false
            },
            {
                id: 'king_master',
                name: 'ç‹è€…ä¹‹è·¯',
                description: 'ä½¿ç”¨å›½ç‹æ–¹è·å¾—10åœºèƒœåˆ©',
                icon: 'ğŸ‘‘',
                requirement: { type: 'kingWins', count: 10 },
                unlocked: false
            },
            {
                id: 'slave_rebel',
                name: 'åå›ä¹‹é­‚',
                description: 'ä½¿ç”¨å¥´éš¶æ–¹è·å¾—10åœºèƒœåˆ©',
                icon: 'ğŸ©¸',
                requirement: { type: 'slaveWins', count: 10 },
                unlocked: false
            },
            {
                id: 'battle_veteran',
                name: 'æˆ˜åœºè€å…µ',
                description: 'å®Œæˆ50åœºå¯¹æˆ˜',
                icon: 'âš”ï¸',
                requirement: { type: 'totalBattles', count: 50 },
                unlocked: false
            },
            {
                id: 'assassin_master',
                name: 'åˆºå®¢å¤§å¸ˆ',
                description: 'ä½¿ç”¨åˆºå®¢å¡ç‰Œ20æ¬¡',
                icon: 'ğŸ—¡ï¸',
                requirement: { type: 'cardUsage', card: 'assassin', count: 20 },
                unlocked: false
            },
            {
                id: 'quick_victory',
                name: 'é—ªç”µæˆ˜',
                description: 'åœ¨3å›åˆå†…ç»“æŸä¸€åœºæ¸¸æˆ',
                icon: 'âš¡',
                requirement: { type: 'quickWin', turns: 3 },
                unlocked: false
            },
            {
                id: 'marathon_player',
                name: 'é©¬æ‹‰æ¾ç©å®¶',
                description: 'ç´¯è®¡æ¸¸æˆæ—¶é—´è¶…è¿‡1å°æ—¶',
                icon: 'â°',
                requirement: { type: 'totalTime', minutes: 60 },
                unlocked: false
            }
        ];

        // å¡ç‰Œå®šä¹‰
        const cardDefinitions = {
            citizen: { name: 'å¸‚æ°‘', icon: 'ğŸ‘¨', level: 1, type: 'basic', description: 'åŸºç¡€å•ä½' },
            assassin: { name: 'åˆºå®¢', icon: 'ğŸ—¡ï¸', level: 2, type: 'basic', description: 'åˆºæ€å‡ºç‰Œæˆ–æŠ½ç‰Œ' },
            butcher: { name: 'å± å¤«', icon: 'âš’ï¸', level: 2, type: 'basic', description: 'åŒå½’äºå°½' },
            guard: { name: 'å®ˆå«', icon: 'ğŸ›¡ï¸', level: 2, type: 'basic', description: 'åŸºç¡€é˜²å¾¡' },
            royalGuard: { name: 'çš‡å®¶å®ˆå«', icon: 'ğŸ›¡ï¸', level: 2, type: 'special', description: 'æ­»åæŠ¤ç‹' },
            ultimateGuard: { name: 'ç»ˆæå®ˆå«', icon: 'ğŸ›¡ï¸', level: 3, type: 'special', description: 'æœ€å¼ºå®ˆæŠ¤' },
            slave: { name: 'å¥´éš¶', icon: 'ğŸ™‡', level: 0, type: 'basic', description: 'èƒ½å‡»è´¥å›½ç‹' },
            king: { name: 'å›½ç‹', icon: 'ğŸ‘‘', level: 3, type: 'key', description: 'å…³é”®ç‰Œ' },
            queen: { name: 'å¥³ç‹', icon: 'ğŸ’', level: 1, type: 'key', description: 'æ­»åå¬ç‹' }
        };

        // å¡ç»„å®šä¹‰
        const deckDefinitions = {
            kingOpening: ['citizen', 'citizen', 'assassin', 'butcher', 'royalGuard', 'king'],
            queenOpening: ['citizen', 'citizen', 'assassin', 'butcher', 'ultimateGuard', 'queen'],
            slave: ['citizen', 'citizen', 'assassin', 'butcher', 'guard', 'slave', 'slave']
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            document.getElementById('setupScreen').style.display = 'block';
            document.getElementById('gameBoard').style.display = 'none';
            document.getElementById('battleResult').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('factionSelection').style.display = 'none';
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState = {
                gameMode: null,
                playerFaction: null,
                playerOpening: null,
                player1Hand: [],
                player2Hand: [],
                playerHand: [],
                opponentHand: [],
                currentPlayer: 1,
                playerSelectedCard: null,
                opponentSelectedCard: null,
                playerPlayedCard: null,
                opponentPlayedCard: null,
                gamePhase: 'setup',
                currentTurn: 1,
                royalGuardProtection: false,
                ultimateGuardUsedLastTurn: false,
                queenDead: false,
                kingInPlay: false,
                opponentReady: false,
                playerReady: false,
                player1Ready: false,
                player2Ready: false
            };
        }

        // æ¨¡å¼é€‰æ‹©
        document.querySelectorAll('.mode-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                gameState.gameMode = this.dataset.mode;
                
                // æ˜¾ç¤ºé˜µè¥é€‰æ‹©
                document.getElementById('modeSelection').style.display = 'none';
                document.getElementById('factionSelection').style.display = 'block';
                
                // æ›´æ–°ç•Œé¢æ–‡æœ¬
                if (gameState.gameMode === 'local') {
                    document.querySelector('#factionSelection h2').textContent = 'ç©å®¶1é€‰æ‹©é˜µè¥';
                } else {
                    document.querySelector('#factionSelection h2').textContent = 'é€‰æ‹©ä½ çš„é˜µè¥';
                }
            });
        });

        // è¿”å›æ¨¡å¼é€‰æ‹©
        document.getElementById('backToModeBtn').addEventListener('click', function() {
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('factionSelection').style.display = 'none';
            gameState.gameMode = null;
            gameState.playerFaction = null;
            gameState.playerOpening = null;
            
            // é‡ç½®é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.faction-card').forEach(c => c.classList.remove('selected'));
            document.querySelectorAll('.opening-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById('openingSelection').style.display = 'none';
            updateStartButton();
        });

        // é˜µè¥é€‰æ‹©
        document.querySelectorAll('.faction-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.faction-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                gameState.playerFaction = this.dataset.faction;
                
                const openingSelection = document.getElementById('openingSelection');
                if (gameState.playerFaction === 'king') {
                    openingSelection.style.display = 'block';
                } else {
                    openingSelection.style.display = 'none';
                    gameState.playerOpening = 'slave';
                }
                
                updateStartButton();
            });
        });

        // å¼€å±€é€‰æ‹©
        document.querySelectorAll('.opening-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.opening-btn').forEach(b => b.classList.remove('selected'));
                this.classList.add('selected');
                gameState.playerOpening = this.dataset.opening;
                updateStartButton();
            });
        });

        function updateStartButton() {
            const startBtn = document.getElementById('startGame');
            if (gameState.playerFaction && gameState.playerOpening) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        // å¼€å§‹æ¸¸æˆ
        document.getElementById('startGame').addEventListener('click', startGame);

        function startGame() {
            gameState.gamePhase = 'select';
            gameState.currentTurn = 1;
            
            // åˆå§‹åŒ–æ¸¸æˆè®°å½•
            gameState.currentGameRecord = {
                gameId: Date.now() + Math.random().toString(36).substr(2, 9),
                startTime: new Date(),
                gameMode: gameState.gameMode,
                playerFaction: gameState.playerFaction,
                playerOpening: gameState.playerOpening,
                opponentFaction: gameState.playerFaction === 'king' ? 'slave' : 'king',
                battles: [],
                result: null,
                endTime: null,
                totalTurns: 0
            };
            
            if (gameState.gameMode === 'ai') {
                setupAIGame();
            } else {
                setupLocalGame();
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç•Œé¢
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameBoard').style.display = 'grid';
            

            
            // æ›´æ–°UI
            updateGameUI();
            updatePhaseIndicator();
            
            if (gameState.gameMode === 'ai') {
                // AIè‡ªåŠ¨é€‰æ‹©å¡ç‰Œï¼ˆå»¶è¿Ÿæ¨¡æ‹Ÿæ€è€ƒï¼‰
                setTimeout(() => {
                    aiSelectCard();
                }, 1000 + Math.random() * 2000);
            } else {
                // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ï¼Œæ˜¾ç¤ºå½“å‰ç©å®¶æŒ‡ç¤ºå™¨
                updateCurrentPlayerIndicator();
            }
        }

        function setupAIGame() {
            // è®¾ç½®ç©å®¶å¡ç»„
            if (gameState.playerFaction === 'king') {
                gameState.playerHand = [...deckDefinitions[gameState.playerOpening + 'Opening']];
            } else {
                gameState.playerHand = [...deckDefinitions.slave];
            }
            
            // è®¾ç½®AIå¯¹æ‰‹å¡ç»„ï¼ˆéšæœºé€‰æ‹©ï¼‰
            const aiOptions = gameState.playerFaction === 'king' ? ['slave'] : ['kingOpening', 'queenOpening'];
            const aiChoice = aiOptions[Math.floor(Math.random() * aiOptions.length)];
            gameState.opponentHand = [...deckDefinitions[aiChoice]];
            
            // è®°å½•AIçš„å¼€å±€é€‰æ‹©
            gameState.aiOpening = aiChoice;
        }

        function setupLocalGame() {
            // æœ¬åœ°å¯¹æˆ˜ï¼šç©å®¶1æ˜¯é€‰æ‹©çš„é˜µè¥ï¼Œç©å®¶2æ˜¯å¯¹æ–¹é˜µè¥
            if (gameState.playerFaction === 'king') {
                gameState.player1Hand = [...deckDefinitions[gameState.playerOpening + 'Opening']];
                // ç©å®¶2éšæœºé€‰æ‹©å¥´éš¶å¼€å±€
                gameState.player2Hand = [...deckDefinitions.slave];
            } else {
                gameState.player1Hand = [...deckDefinitions.slave];
                // ç©å®¶2éšæœºé€‰æ‹©å›½ç‹å¼€å±€
                const kingOptions = ['kingOpening', 'queenOpening'];
                const kingChoice = kingOptions[Math.floor(Math.random() * kingOptions.length)];
                gameState.player2Hand = [...deckDefinitions[kingChoice]];
            }
            
            // è®¾ç½®å½“å‰æ˜¾ç¤ºçš„æ‰‹ç‰Œ
            gameState.playerHand = [...gameState.player1Hand];
            gameState.opponentHand = [...gameState.player2Hand];
        }

        function updateCurrentPlayerIndicator() {
            if (gameState.gameMode !== 'local') return;
            
            const indicator1 = document.getElementById('currentPlayerIndicator');
            const indicator2 = document.getElementById('currentPlayerIndicator2');
            
            if (gameState.currentPlayer === 1) {
                indicator2.style.display = 'block';
                indicator1.style.display = 'none';
                indicator2.textContent = 'ç©å®¶1çš„å›åˆï¼è¯·é€‰æ‹©å¡ç‰Œ';
            } else {
                indicator1.style.display = 'block';
                indicator2.style.display = 'none';
                indicator1.textContent = 'ç©å®¶2çš„å›åˆï¼è¯·é€‰æ‹©å¡ç‰Œ';
                
                // æ˜¾ç¤ºç©å®¶2çš„æ‰‹ç‰Œ
                document.getElementById('opponentHandCards').style.display = 'flex';
                updateOpponentHand();
            }
        }

        function updateGameUI() {
            // æ›´æ–°é˜µè¥æ˜¾ç¤º
            const playerFactionIcon = document.getElementById('playerFaction');
            const playerFactionName = document.getElementById('playerFactionName');
            const opponentFaction = document.getElementById('opponentFaction');
            const opponentName = document.getElementById('opponentName');
            
            if (gameState.gameMode === 'ai') {
                if (gameState.playerFaction === 'king') {
                    playerFactionIcon.textContent = 'ğŸ‘‘';
                    playerFactionName.textContent = 'å›½ç‹æ–¹';
                    opponentFaction.textContent = 'ğŸ©¸';
                    opponentName.textContent = 'AIå¯¹æ‰‹ (å¥´éš¶æ–¹)';
                } else {
                    playerFactionIcon.textContent = 'ğŸ©¸';
                    playerFactionName.textContent = 'å¥´éš¶æ–¹';
                    opponentFaction.textContent = 'ğŸ‘‘';
                    opponentName.textContent = 'AIå¯¹æ‰‹ (å›½ç‹æ–¹)';
                }
            } else {
                // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼
                if (gameState.playerFaction === 'king') {
                    playerFactionIcon.textContent = 'ğŸ‘‘';
                    playerFactionName.textContent = 'ç©å®¶1 (å›½ç‹æ–¹)';
                    opponentFaction.textContent = 'ğŸ©¸';
                    opponentName.textContent = 'ç©å®¶2 (å¥´éš¶æ–¹)';
                } else {
                    playerFactionIcon.textContent = 'ğŸ©¸';
                    playerFactionName.textContent = 'ç©å®¶1 (å¥´éš¶æ–¹)';
                    opponentFaction.textContent = 'ğŸ‘‘';
                    opponentName.textContent = 'ç©å®¶2 (å›½ç‹æ–¹)';
                }
            }
            
            // æ›´æ–°å›åˆæ•°
            document.getElementById('turnNumber').textContent = gameState.currentTurn;
            
            // æ›´æ–°æ‰‹ç‰Œæ•°é‡
            document.getElementById('playerHandCount').textContent = gameState.playerHand.length;
            document.getElementById('opponentHandCount').textContent = gameState.opponentHand.length;
            
            // å¼€å±€ä¿¡æ¯å·²ç§»é™¤ï¼Œä¿æŒç•Œé¢ç®€æ´
            
            // æ›´æ–°æ‰‹ç‰Œæ˜¾ç¤º
            updatePlayerHand();
            
            if (gameState.gameMode === 'local') {
                updateCurrentPlayerIndicator();
            }
        }

        // å¼€å±€ä¿¡æ¯æ˜¾ç¤ºåŠŸèƒ½å·²ç§»é™¤ï¼Œä¿æŒç•Œé¢ç®€æ´

        function updatePhaseIndicator() {
            // é‡ç½®æ‰€æœ‰é˜¶æ®µ
            document.querySelectorAll('.phase-step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            
            // æ ¹æ®å½“å‰é˜¶æ®µæ›´æ–°æŒ‡ç¤ºå™¨
            switch(gameState.gamePhase) {
                case 'select':
                    document.getElementById('phaseSelect').classList.add('active');
                    break;
                case 'reveal':
                    document.getElementById('phaseSelect').classList.add('completed');
                    document.getElementById('phaseReveal').classList.add('active');
                    break;
                case 'battle':
                    document.getElementById('phaseSelect').classList.add('completed');
                    document.getElementById('phaseReveal').classList.add('completed');
                    document.getElementById('phaseBattle').classList.add('active');
                    break;
                case 'end':
                    document.getElementById('phaseSelect').classList.add('completed');
                    document.getElementById('phaseReveal').classList.add('completed');
                    document.getElementById('phaseBattle').classList.add('completed');
                    document.getElementById('phaseEnd').classList.add('active');
                    break;
            }
        }

        function updatePlayerHand() {
            const handContainer = document.getElementById('playerHand');
            handContainer.innerHTML = '';
            
            gameState.playerHand.forEach((cardId, index) => {
                const card = cardDefinitions[cardId];
                const cardElement = createCardElement(card, cardId, index, false);
                handContainer.appendChild(cardElement);
            });
        }

        function updateOpponentHand() {
            const handContainer = document.getElementById('opponentHandCards');
            handContainer.innerHTML = '';
            
            gameState.opponentHand.forEach((cardId, index) => {
                const card = cardDefinitions[cardId];
                const cardElement = createCardElement(card, cardId, index, true);
                handContainer.appendChild(cardElement);
            });
        }

        function createCardElement(card, cardId, index, isOpponent = false) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card';
            cardDiv.dataset.cardIndex = index;
            cardDiv.dataset.cardId = cardId;
            cardDiv.dataset.isOpponent = isOpponent;
            
            // ç‰¹æ®Šæƒ…å†µï¼šå¥³ç‹åªèƒ½åœ¨å‰©ä½™ä¸€å¼ ç‰Œæ—¶å‡ºåœº
            const currentHand = isOpponent ? gameState.opponentHand : gameState.playerHand;
            if (cardId === 'queen' && currentHand.length > 1) {
                cardDiv.style.opacity = '0.5';
                cardDiv.style.cursor = 'not-allowed';
                cardDiv.title = 'å¥³ç‹åªèƒ½åœ¨æ‰‹ç‰Œå‰©ä½™ä¸€å¼ æ—¶å‡ºåœº';
            }
            
            // ç‰¹æ®Šæƒ…å†µï¼šç»ˆæå®ˆå«ä¸èƒ½è¿ç»­å‡ºåŠ¨
            if (cardId === 'ultimateGuard' && gameState.ultimateGuardUsedLastTurn) {
                cardDiv.style.opacity = '0.5';
                cardDiv.style.cursor = 'not-allowed';
            }
            
            cardDiv.innerHTML = `
                <div class="card-level">${card.level}</div>
                <div class="card-icon">${card.icon}</div>
                <div class="card-name">${card.name}</div>
                <div class="card-description">${card.description}</div>
            `;
            
            cardDiv.addEventListener('click', function() {
                // æ£€æŸ¥å¥³ç‹å‡ºç‰Œé™åˆ¶
                if (cardId === 'queen' && currentHand.length > 1) {
                    return;
                }
                
                // æ£€æŸ¥ç»ˆæå®ˆå«è¿ç»­ä½¿ç”¨é™åˆ¶
                if (cardId === 'ultimateGuard' && gameState.ultimateGuardUsedLastTurn) {
                    return;
                }
                
                if (gameState.gameMode === 'local' && isOpponent) {
                    // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹çš„å¯¹æ‰‹åŒºåŸŸé€‰æ‹©
                    if (gameState.currentPlayer !== 2) return;
                    
                    document.querySelectorAll('#opponentHandCards .card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.opponentSelectedCard = parseInt(this.dataset.cardIndex);
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥å‡ºç‰Œ
                    checkLocalPlayReady();
                } else if (!isOpponent) {
                    // ç©å®¶åŒºåŸŸé€‰æ‹©
                    if (gameState.gameMode === 'local' && gameState.currentPlayer !== 1) return;
                    
                    document.querySelectorAll('#playerHand .card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    gameState.playerSelectedCard = parseInt(this.dataset.cardIndex);
                    
                    if (gameState.gameMode === 'ai') {
                        document.getElementById('playCardBtn').disabled = false;
                    } else {
                        checkLocalPlayReady();
                    }
                }
            });
            
            return cardDiv;
        }

        function checkLocalPlayReady() {
            if (gameState.gameMode !== 'local') return;
            
            const playBtn = document.getElementById('playCardBtn');
            
            if (gameState.playerSelectedCard !== null && gameState.opponentSelectedCard !== null) {
                playBtn.disabled = false;
                playBtn.textContent = 'åŒæ–¹å‡ºç‰Œ';
            } else if (gameState.playerSelectedCard !== null && gameState.currentPlayer === 1) {
                playBtn.disabled = false;
                playBtn.textContent = 'ç©å®¶1å‡ºç‰Œ';
            } else if (gameState.opponentSelectedCard !== null && gameState.currentPlayer === 2) {
                playBtn.disabled = false;
                playBtn.textContent = 'ç©å®¶2å‡ºç‰Œ';
            } else {
                playBtn.disabled = true;
                playBtn.textContent = 'å‡ºç‰Œ';
            }
        }

        // AIé€‰æ‹©å¡ç‰Œ - æ™ºèƒ½ç­–ç•¥
        function aiSelectCard() {
            if (gameState.opponentHand.length === 0) return;
            
            // AIæ€è€ƒå»¶è¿Ÿï¼ˆæ¨¡æ‹ŸçœŸå®æ€è€ƒè¿‡ç¨‹ï¼‰
            const thinkingTime = 800 + Math.random() * 1500;
            
            // æ˜¾ç¤ºAIæ€è€ƒçŠ¶æ€
            const thinkingIndicator = document.createElement('div');
            thinkingIndicator.className = 'ai-thinking-indicator';
            thinkingIndicator.innerHTML = 'ğŸ¤” AIæ­£åœ¨æ€è€ƒ...';
            thinkingIndicator.style.cssText = `
                background: rgba(0,0,0,0.7);
                color: #ffd700;
                padding: 8px 15px;
                border-radius: 8px;
                margin-top: 10px;
                text-align: center;
                border: 1px solid #ffd700;
                animation: pulse 1.5s ease-in-out infinite alternate;
            `;
            
            const opponentArea = document.querySelector('.opponent-area');
            const existingIndicator = opponentArea.querySelector('.ai-selected-indicator, .ai-thinking-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            opponentArea.appendChild(thinkingIndicator);
            
            setTimeout(() => {
                const opponentCardIndex = aiChooseCard();
                gameState.opponentSelectedCard = opponentCardIndex;
                gameState.opponentReady = true;
                
                // ç§»é™¤æ€è€ƒæŒ‡ç¤ºå™¨
                thinkingIndicator.remove();
                
                // æ˜¾ç¤ºAIå·²å‡†å¤‡
                document.querySelector('.opponent-area').style.borderColor = '#32cd32';
                
                // æ˜¾ç¤ºAIé€‰æ‹©çš„å¡ç‰Œï¼ˆèƒŒé¢ï¼‰
                const selectedCardElement = document.createElement('div');
                selectedCardElement.className = 'ai-selected-indicator';
                selectedCardElement.innerHTML = 'ğŸ´ AIå·²é€‰æ‹©å¡ç‰Œ';
                selectedCardElement.style.cssText = `
                    background: rgba(0,0,0,0.7);
                    color: #32cd32;
                    padding: 8px 15px;
                    border-radius: 8px;
                    margin-top: 10px;
                    text-align: center;
                    border: 1px solid #32cd32;
                `;
                
                opponentArea.appendChild(selectedCardElement);
                
                checkBothReady();
            }, thinkingTime);
        }

        // AIæ™ºèƒ½é€‰ç‰Œç­–ç•¥
        function aiChooseCard() {
            const hand = gameState.opponentHand;
            const playerHand = gameState.playerHand;
            const turn = gameState.currentTurn;
            
            // åˆ†æå½“å‰å±€åŠ¿
            const gameAnalysis = analyzeGameState();
            
            // ä¸ºæ¯å¼ ç‰Œè®¡ç®—ä¼˜å…ˆçº§åˆ†æ•°
            let cardScores = hand.map((cardId, index) => {
                return {
                    index: index,
                    cardId: cardId,
                    score: calculateCardScore(cardId, gameAnalysis)
                };
            });
            
            // æŒ‰åˆ†æ•°æ’åºï¼Œé€‰æ‹©æœ€é«˜åˆ†çš„ç‰Œ
            cardScores.sort((a, b) => b.score - a.score);
            
            // æ·»åŠ ä¸€äº›éšæœºæ€§ï¼Œé¿å…è¿‡äºæœºæ¢°åŒ–
            const topCards = cardScores.filter(card => card.score >= cardScores[0].score - 10);
            const selectedCard = topCards[Math.floor(Math.random() * topCards.length)];
            
            return selectedCard.index;
        }

        // åˆ†ææ¸¸æˆçŠ¶æ€
        function analyzeGameState() {
            const playerHand = gameState.playerHand;
            const opponentHand = gameState.opponentHand;
            const turn = gameState.currentTurn;
            
            // åˆ†æç©å®¶å¯èƒ½çš„å¨èƒ
            const playerHasKing = playerHand.includes('king');
            const playerHasQueen = playerHand.includes('queen');
            const playerHasSlave = playerHand.includes('slave');
            const playerHasAssassin = playerHand.includes('assassin');
            const playerHasButcher = playerHand.includes('butcher');
            
            // åˆ†æè‡ªå·±çš„èµ„æº
            const aiHasKing = opponentHand.includes('king');
            const aiHasQueen = opponentHand.includes('queen');
            const aiHasSlave = opponentHand.includes('slave');
            const aiHasAssassin = opponentHand.includes('assassin');
            const aiHasUltimateGuard = opponentHand.includes('ultimateGuard');
            
            // è®¡ç®—æ‰‹ç‰Œä¼˜åŠ¿
            const handAdvantage = opponentHand.length - playerHand.length;
            
            // åˆ¤æ–­æ¸¸æˆé˜¶æ®µ
            let gamePhase = 'early';
            if (turn > 3 || playerHand.length <= 3 || opponentHand.length <= 3) {
                gamePhase = 'mid';
            }
            if (turn > 5 || playerHand.length <= 2 || opponentHand.length <= 2) {
                gamePhase = 'late';
            }
            
            return {
                playerThreats: {
                    hasKing: playerHasKing,
                    hasQueen: playerHasQueen,
                    hasSlave: playerHasSlave,
                    hasAssassin: playerHasAssassin,
                    hasButcher: playerHasButcher,
                    handSize: playerHand.length
                },
                aiResources: {
                    hasKing: aiHasKing,
                    hasQueen: aiHasQueen,
                    hasSlave: aiHasSlave,
                    hasAssassin: aiHasAssassin,
                    hasUltimateGuard: aiHasUltimateGuard,
                    handSize: opponentHand.length
                },
                gameState: {
                    turn: turn,
                    phase: gamePhase,
                    handAdvantage: handAdvantage,
                    royalGuardProtection: gameState.royalGuardProtection,
                    queenDead: gameState.queenDead,
                    ultimateGuardUsedLastTurn: gameState.ultimateGuardUsedLastTurn
                }
            };
        }

        // è®¡ç®—å¡ç‰Œåˆ†æ•°
        function calculateCardScore(cardId, analysis) {
            let score = 0;
            const card = cardDefinitions[cardId];
            const { playerThreats, aiResources, gameState: gameInfo } = analysis;
            
            // åŸºç¡€åˆ†æ•°ï¼ˆæ ¹æ®å¡ç‰Œç­‰çº§ï¼‰
            score += card.level * 10;
            
            // ç‰¹æ®Šå¡ç‰Œç­–ç•¥åˆ†æ
            switch(cardId) {
                case 'king':
                    // å›½ç‹çš„ä½¿ç”¨æ—¶æœºå¾ˆå…³é”®
                    if (gameInfo.phase === 'late') {
                        score += 50; // åæœŸå›½ç‹ä»·å€¼æ›´é«˜
                    }
                    if (playerThreats.hasSlave) {
                        score -= 30; // ç©å®¶æœ‰å¥´éš¶æ—¶è¦è°¨æ…
                    }
                    if (gameState.royalGuardProtection) {
                        score += 25; // æœ‰çš‡å®¶å®ˆå«ä¿æŠ¤æ—¶æ›´å®‰å…¨
                    }
                    break;
                    
                case 'queen':
                    // å¥³ç‹åªèƒ½åœ¨æœ€åä¸€å¼ ç‰Œæ—¶å‡º
                    if (aiResources.handSize === 1) {
                        score += 40;
                    } else {
                        score = -100; // ä¸èƒ½å‡ºç‰Œ
                    }
                    break;
                    
                case 'slave':
                    // å¥´éš¶ä¸“é—¨å…‹åˆ¶å›½ç‹
                    if (playerThreats.hasKing) {
                        score += 60; // ç©å®¶æœ‰å›½ç‹æ—¶å¥´éš¶ä»·å€¼æé«˜
                    }
                    if (gameInfo.phase === 'late') {
                        score += 30; // åæœŸå¥´éš¶æ›´æœ‰ä»·å€¼
                    }
                    break;
                    
                case 'assassin':
                    // åˆºå®¢çš„ä»·å€¼å–å†³äºç›®æ ‡
                    if (playerThreats.hasKing || playerThreats.hasQueen) {
                        score += 45; // æœ‰å…³é”®ç›®æ ‡æ—¶ä»·å€¼é«˜
                    }
                    if (playerThreats.handSize > 2) {
                        score += 20; // ç©å®¶æ‰‹ç‰Œå¤šæ—¶å¯ä»¥æŠ½ç‰Œåˆºæ€
                    }
                    if (gameInfo.phase === 'mid') {
                        score += 15; // ä¸­æœŸä½¿ç”¨åˆºå®¢è¾ƒå¥½
                    }
                    break;
                    
                case 'butcher':
                    // å± å¤«çš„åŒå½’äºå°½ç­–ç•¥
                    if (gameInfo.handAdvantage > 0) {
                        score += 25; // æ‰‹ç‰Œä¼˜åŠ¿æ—¶åŒå½’äºå°½æœ‰åˆ©
                    }
                    if (playerThreats.hasKing && !aiResources.hasSlave) {
                        score += 35; // æ²¡æœ‰å¥´éš¶å¯¹ä»˜å›½ç‹æ—¶ï¼Œå± å¤«æ˜¯å¥½é€‰æ‹©
                    }
                    if (gameInfo.phase === 'late') {
                        score += 20; // åæœŸå± å¤«ä»·å€¼æå‡
                    }
                    break;
                    
                case 'ultimateGuard':
                    // ç»ˆæå®ˆå«ä¸èƒ½è¿ç»­ä½¿ç”¨
                    if (gameState.ultimateGuardUsedLastTurn) {
                        score = -100; // ä¸èƒ½ä½¿ç”¨
                    } else {
                        if (playerThreats.hasAssassin) {
                            score += 40; // å¯¹æŠ—åˆºå®¢
                        }
                        if (aiResources.hasKing || aiResources.hasQueen) {
                            score += 30; // ä¿æŠ¤å…³é”®ç‰Œ
                        }
                    }
                    break;
                    
                case 'royalGuard':
                    // çš‡å®¶å®ˆå«çš„æ­»åä¿æŠ¤
                    if (aiResources.hasKing && !gameState.royalGuardProtection) {
                        score += 35; // ä¸ºå›½ç‹æä¾›ä¿æŠ¤
                    }
                    if (gameInfo.phase === 'early') {
                        score += 20; // æ—©æœŸå»ºç«‹ä¿æŠ¤
                    }
                    break;
                    
                case 'guard':
                    // æ™®é€šå®ˆå«
                    if (gameInfo.phase === 'early') {
                        score += 10; // æ—©æœŸç¨³å®šé€‰æ‹©
                    }
                    break;
                    
                case 'citizen':
                    // å¸‚æ°‘æ˜¯æœ€åŸºç¡€çš„é€‰æ‹©
                    if (gameInfo.phase === 'early') {
                        score += 5; // æ—©æœŸå¯ä»¥ç”¨æ¥è¯•æ¢
                    }
                    // åæœŸä»·å€¼è¾ƒä½ï¼Œä¿æŒåŸºç¡€åˆ†æ•°
                    break;
            }
            
            // æ ¹æ®æ¸¸æˆé˜¶æ®µè°ƒæ•´ç­–ç•¥
            if (gameInfo.phase === 'late') {
                // åæœŸæ›´æ¿€è¿›ï¼Œä¼˜å…ˆé«˜ä»·å€¼ç‰Œ
                if (card.type === 'key') {
                    score += 25;
                }
                if (cardId === 'slave' || cardId === 'assassin') {
                    score += 20;
                }
            } else if (gameInfo.phase === 'early') {
                // æ—©æœŸæ›´ä¿å®ˆï¼Œé¿å…è¿‡æ—©æš´éœ²å…³é”®ç‰Œ
                if (card.type === 'key') {
                    score -= 15;
                }
                if (card.type === 'basic') {
                    score += 10;
                }
            }
            
            // æ‰‹ç‰Œæ•°é‡å½±å“ç­–ç•¥
            if (aiResources.handSize <= 2) {
                // æ‰‹ç‰Œå°‘æ—¶æ›´æ¿€è¿›
                if (card.type === 'key' || cardId === 'slave') {
                    score += 30;
                }
            }
            
            // å¯¹æ‰‹æ‰‹ç‰Œæ•°é‡å½±å“
            if (playerThreats.handSize <= 2) {
                // å¯¹æ‰‹æ‰‹ç‰Œå°‘æ—¶å¯ä»¥æ›´æ¿€è¿›
                if (cardId === 'assassin' || cardId === 'butcher') {
                    score += 20;
                }
            }
            
            return Math.max(0, score);
        }

        // AIåˆºå®¢ç›®æ ‡é€‰æ‹©ç­–ç•¥
        function aiChooseAssassinTarget(playerPlayedCard) {
            const playerHand = gameState.playerHand;
            const playerCardDef = cardDefinitions[playerPlayedCard];
            
            // å¦‚æœç©å®¶æ²¡æœ‰æ‰‹ç‰Œï¼Œåªèƒ½åˆºæ€å‡ºç‰Œ
            if (playerHand.length === 0) {
                return 'killPlayed';
            }
            
            // åˆ†æç©å®¶å‡ºç‰Œçš„ä»·å€¼
            let playedCardValue = playerCardDef.level * 10;
            
            // å…³é”®ç‰Œä»·å€¼æ›´é«˜
            if (playerCardDef.type === 'key') {
                playedCardValue += 50;
            }
            
            // ç‰¹æ®Šç‰Œä»·å€¼è°ƒæ•´
            if (playerPlayedCard === 'king') {
                playedCardValue += 60; // å›½ç‹æ˜¯æœ€é«˜ä»·å€¼ç›®æ ‡
            } else if (playerPlayedCard === 'queen') {
                playedCardValue += 40; // å¥³ç‹ä¹Ÿå¾ˆé‡è¦
            } else if (playerPlayedCard === 'slave') {
                playedCardValue += 30; // å¥´éš¶å¯¹AIå¨èƒè¾ƒå¤§
            } else if (playerPlayedCard === 'ultimateGuard') {
                playedCardValue += 35; // ç»ˆæå®ˆå«å¾ˆå¼º
            }
            
            // ä¼°ç®—æ‰‹ç‰Œä¸­å¯èƒ½çš„é«˜ä»·å€¼ç›®æ ‡
            let estimatedHandValue = 0;
            
            // æ ¹æ®ç©å®¶é˜µè¥å’Œå‰©ä½™æ‰‹ç‰Œæ•°é‡ä¼°ç®—
            if (gameState.playerFaction === 'king') {
                // å›½ç‹æ–¹å¯èƒ½æœ‰çš„é«˜ä»·å€¼ç‰Œ
                if (playerHand.includes('king')) {
                    estimatedHandValue += 70; // ç¡®å®šæœ‰å›½ç‹
                } else if (playerHand.length >= 2 && !gameState.kingInPlay) {
                    estimatedHandValue += 35; // å¯èƒ½æœ‰å›½ç‹
                }
                
                if (playerHand.includes('queen')) {
                    estimatedHandValue += 50; // ç¡®å®šæœ‰å¥³ç‹
                }
                
                if (playerHand.includes('ultimateGuard')) {
                    estimatedHandValue += 40; // ç¡®å®šæœ‰ç»ˆæå®ˆå«
                }
            } else {
                // å¥´éš¶æ–¹çš„å¨èƒè¯„ä¼°
                const slaveCount = playerHand.filter(card => card === 'slave').length;
                estimatedHandValue += slaveCount * 40; // æ¯ä¸ªå¥´éš¶éƒ½æ˜¯å¨èƒ
                
                if (playerHand.includes('assassin')) {
                    estimatedHandValue += 30; // åˆºå®¢å¨èƒ
                }
            }
            
            // æ¸¸æˆé˜¶æ®µå½±å“å†³ç­–
            const gamePhase = gameState.currentTurn > 3 ? 'late' : 'early';
            
            if (gamePhase === 'late') {
                // åæœŸæ›´å€¾å‘äºåˆºæ€ç¡®å®šçš„é«˜ä»·å€¼ç›®æ ‡
                playedCardValue *= 1.3;
            } else {
                // æ—©æœŸæ›´å€¾å‘äºæŠ½ç‰Œåˆºæ€ï¼Œè·å–ä¿¡æ¯ä¼˜åŠ¿
                estimatedHandValue *= 1.2;
            }
            
            // æ‰‹ç‰Œæ•°é‡å½±å“
            if (playerHand.length <= 2) {
                // ç©å®¶æ‰‹ç‰Œå°‘æ—¶ï¼ŒæŠ½ç‰Œåˆºæ€ä»·å€¼é™ä½
                estimatedHandValue *= 0.7;
            } else if (playerHand.length >= 4) {
                // ç©å®¶æ‰‹ç‰Œå¤šæ—¶ï¼ŒæŠ½ç‰Œåˆºæ€ä»·å€¼æé«˜
                estimatedHandValue *= 1.3;
            }
            
            // å†³ç­–ï¼šæ¯”è¾ƒåˆºæ€å‡ºç‰Œ vs æŠ½ç‰Œåˆºæ€çš„æœŸæœ›ä»·å€¼
            const killPlayedValue = playedCardValue;
            const drawKillValue = estimatedHandValue / playerHand.length; // å¹³å‡æœŸæœ›ä»·å€¼
            
            // æ·»åŠ ä¸€äº›éšæœºæ€§ï¼Œé¿å…è¿‡äºæœºæ¢°åŒ–
            const randomFactor = 0.8 + Math.random() * 0.4; // 0.8-1.2çš„éšæœºå› å­
            
            if (killPlayedValue * randomFactor > drawKillValue) {
                return 'killPlayed';
            } else {
                return 'drawKill';
            }
        }

        // AIé€‰æ‹©æ‰‹ç‰Œåˆºæ€ç›®æ ‡
        function aiChooseHandTarget() {
            const playerHand = gameState.playerHand;
            
            if (playerHand.length === 1) {
                return 0;
            }
            
            // ä¼˜å…ˆç›®æ ‡æƒé‡
            const targetPriorities = {
                'king': 100,      // æœ€é«˜ä¼˜å…ˆçº§
                'queen': 80,      // æ¬¡é«˜ä¼˜å…ˆçº§
                'slave': 70,      // å¥´éš¶å¨èƒå¾ˆå¤§
                'ultimateGuard': 60,
                'assassin': 50,
                'royalGuard': 40,
                'butcher': 30,
                'guard': 20,
                'citizen': 10     // æœ€ä½ä¼˜å…ˆçº§
            };
            
            // è®¡ç®—æ¯å¼ ç‰Œçš„ç›®æ ‡ä»·å€¼
            let targetScores = playerHand.map((cardId, index) => {
                let score = targetPriorities[cardId] || 10;
                
                // æ ¹æ®æ¸¸æˆçŠ¶æ€è°ƒæ•´ä¼˜å…ˆçº§
                if (cardId === 'king' && gameState.playerFaction === 'king') {
                    score += 20; // å›½ç‹æ–¹çš„å›½ç‹æ›´é‡è¦
                }
                
                if (cardId === 'slave' && gameState.playerFaction === 'slave') {
                    score += 15; // å¥´éš¶æ–¹çš„å¥´éš¶æ˜¯å…³é”®
                }
                
                // åæœŸå…³é”®ç‰Œä»·å€¼æ›´é«˜
                if (gameState.currentTurn > 3 && (cardId === 'king' || cardId === 'queen' || cardId === 'slave')) {
                    score += 25;
                }
                
                return { index, score };
            });
            
            // æŒ‰åˆ†æ•°æ’åº
            targetScores.sort((a, b) => b.score - a.score);
            
            // åœ¨å‰å‡ ä¸ªé«˜åˆ†ç›®æ ‡ä¸­éšæœºé€‰æ‹©ï¼Œå¢åŠ ä¸å¯é¢„æµ‹æ€§
            const topTargets = targetScores.filter(target => 
                target.score >= targetScores[0].score - 20
            );
            
            const selectedTarget = topTargets[Math.floor(Math.random() * topTargets.length)];
            return selectedTarget.index;
        }

        // å‡ºç‰ŒæŒ‰é’®
        document.getElementById('playCardBtn').addEventListener('click', playCard);

        function playCard() {
            if (gameState.gameMode === 'ai') {
                if (gameState.playerSelectedCard === null || gameState.gamePhase !== 'select') return;
                
                gameState.playerReady = true;
                document.getElementById('playCardBtn').disabled = true;
                document.getElementById('playCardBtn').textContent = 'å·²é€‰æ‹©å¡ç‰Œ';
                
                // æ˜¾ç¤ºç©å®¶å·²å‡†å¤‡
                document.querySelector('.player-area').style.borderColor = '#32cd32';
                
                checkBothReady();
            } else {
                // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼
                if (gameState.playerSelectedCard !== null && gameState.opponentSelectedCard !== null) {
                    // åŒæ–¹éƒ½å·²é€‰æ‹©ï¼Œç›´æ¥è¿›å…¥ç¿»ç‰Œ
                    gameState.playerReady = true;
                    gameState.opponentReady = true;
                    document.getElementById('playCardBtn').disabled = true;
                    document.getElementById('playCardBtn').textContent = 'åŒæ–¹å·²å‡ºç‰Œ';
                    checkBothReady();
                } else if (gameState.currentPlayer === 1 && gameState.playerSelectedCard !== null) {
                    // ç©å®¶1å‡ºç‰Œ
                    gameState.player1Ready = true;
                    gameState.currentPlayer = 2;
                    document.getElementById('playCardBtn').disabled = true;
                    document.getElementById('playCardBtn').textContent = 'ç­‰å¾…ç©å®¶2';
                    
                    // åˆ‡æ¢åˆ°ç©å®¶2
                    updateCurrentPlayerIndicator();
                    
                    // éšè—ç©å®¶1çš„æ‰‹ç‰Œï¼Œæ˜¾ç¤ºç©å®¶2çš„æ‰‹ç‰Œ
                    document.getElementById('playerHand').style.display = 'none';
                    document.getElementById('opponentHandCards').style.display = 'flex';
                    
                } else if (gameState.currentPlayer === 2 && gameState.opponentSelectedCard !== null) {
                    // ç©å®¶2å‡ºç‰Œ
                    gameState.player2Ready = true;
                    gameState.playerReady = true;
                    gameState.opponentReady = true;
                    document.getElementById('playCardBtn').disabled = true;
                    document.getElementById('playCardBtn').textContent = 'åŒæ–¹å·²å‡ºç‰Œ';
                    
                    // éšè—ç©å®¶2çš„æ‰‹ç‰ŒæŒ‡ç¤ºå™¨
                    document.getElementById('currentPlayerIndicator').style.display = 'none';
                    document.getElementById('currentPlayerIndicator2').style.display = 'none';
                    document.getElementById('opponentHandCards').style.display = 'none';
                    document.getElementById('playerHand').style.display = 'flex';
                    
                    checkBothReady();
                }
            }
        }

        function checkBothReady() {
            if (gameState.playerReady && gameState.opponentReady) {
                // è¿›å…¥ç¿»ç‰Œé˜¶æ®µ
                gameState.gamePhase = 'reveal';
                updatePhaseIndicator();
                
                setTimeout(() => {
                    revealCards();
                }, 1000);
            }
        }

        function revealCards() {
            const playerCardId = gameState.playerHand[gameState.playerSelectedCard];
            const opponentCardId = gameState.opponentHand[gameState.opponentSelectedCard];
            
            gameState.playerPlayedCard = playerCardId;
            gameState.opponentPlayedCard = opponentCardId;
            
            // ä»æ‰‹ç‰Œä¸­ç§»é™¤
            gameState.playerHand.splice(gameState.playerSelectedCard, 1);
            gameState.opponentHand.splice(gameState.opponentSelectedCard, 1);
            
            // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹åŒæ­¥æ›´æ–°ç©å®¶æ‰‹ç‰Œ
            if (gameState.gameMode === 'local') {
                gameState.player1Hand = [...gameState.playerHand];
                gameState.player2Hand = [...gameState.opponentHand];
            }
            
            // æ˜¾ç¤ºå‡ºç‰Œ
            displayPlayedCards();
            
            // è¿›å…¥æˆ˜æ–—é˜¶æ®µ
            gameState.gamePhase = 'battle';
            updatePhaseIndicator();
            
            // å»¶è¿Ÿåè¿›è¡Œæˆ˜æ–—
            setTimeout(() => {
                resolveBattle();
            }, 2000);
        }

        function displayPlayedCards() {
            const playerCard = cardDefinitions[gameState.playerPlayedCard];
            const opponentCard = cardDefinitions[gameState.opponentPlayedCard];
            
            document.getElementById('playerPlayedCard').innerHTML = `
                <div class="card-level">${playerCard.level}</div>
                <div class="card-icon">${playerCard.icon}</div>
                <div class="card-name">${playerCard.name}</div>
            `;
            
            document.getElementById('opponentPlayedCard').innerHTML = `
                <div class="card-level">${opponentCard.level}</div>
                <div class="card-icon">${opponentCard.icon}</div>
                <div class="card-name">${opponentCard.name}</div>
            `;
        }

        function resolveBattle() {
            const playerCard = gameState.playerPlayedCard;
            const opponentCard = gameState.opponentPlayedCard;
            const playerCardDef = cardDefinitions[playerCard];
            const opponentCardDef = cardDefinitions[opponentCard];
            
            let result = '';
            let playerCardSurvives = false;
            let opponentCardSurvives = false;
            let specialEffect = '';
            
            // å± å¤«ä¼˜å…ˆçº§æœ€é«˜
            if (playerCard === 'butcher' || opponentCard === 'butcher') {
                result = 'å± å¤«å‘åŠ¨æŠ€èƒ½ï¼šåŒæ–¹åŒå½’äºå°½ï¼';
                specialEffect = 'ğŸ’€ åŒå½’äºå°½ ğŸ’€';
            }
            // åˆºå®¢æŠ€èƒ½ - åŒæ–¹åŒæ—¶å‡ºåˆºå®¢æ—¶åªèƒ½åˆºæ€æ‰‹ç‰Œ
            else if (playerCard === 'assassin' && opponentCard === 'assassin') {
                result = 'åŒæ–¹åˆºå®¢å¯¹å†³ï¼šåªèƒ½åˆºæ€æ‰‹ç‰Œï¼';
                handleDoubleAssassin();
                return;
            }
            // ç©å®¶åˆºå®¢ - è®©ç©å®¶é€‰æ‹©åˆºæ€æ–¹å¼
            else if (playerCard === 'assassin') {
                if (opponentCard === 'ultimateGuard') {
                    result = 'ç»ˆæå®ˆå«å…ç–«åˆºæ€ï¼šåˆºå®¢è¢«å‡»æ€ï¼';
                    opponentCardSurvives = true;
                    specialEffect = 'ğŸ›¡ï¸ å…ç–«åˆºæ€ ğŸ›¡ï¸';
                } else {
                    // æ˜¾ç¤ºåˆºå®¢é€‰æ‹©ç•Œé¢
                    showAssassinChoice(true);
                    return;
                }
            }
            else if (opponentCard === 'assassin') {
                if (playerCard === 'ultimateGuard') {
                    result = 'ç»ˆæå®ˆå«å…ç–«åˆºæ€ï¼šåˆºå®¢è¢«å‡»æ€ï¼';
                    playerCardSurvives = true;
                    specialEffect = 'ğŸ›¡ï¸ å…ç–«åˆºæ€ ğŸ›¡ï¸';
                } else {
                    // AIåˆºå®¢æ™ºèƒ½é€‰æ‹©ç­–ç•¥
                    const assassinChoice = aiChooseAssassinTarget(playerCard);
                    if (assassinChoice === 'killPlayed' || gameState.playerHand.length === 0) {
                        // åˆºæ€ç©å®¶å‡ºç‰Œ
                        result = `å¯¹æ‰‹åˆºå®¢å‘åŠ¨æŠ€èƒ½ï¼šåˆºæ€äº†ä½ çš„${playerCardDef.name}ï¼åˆºå®¢å®Œæˆä»»åŠ¡åæ­»äº¡ï¼`;
                        opponentCardSurvives = false;
                        specialEffect = 'ğŸ”ª è¢«åˆºæ€ ğŸ”ª';
                    } else {
                        // æŠ½å–ç©å®¶æ‰‹ç‰Œåˆºæ€ï¼Œç©å®¶å‡ºç‰Œå›åˆ°æ‰‹ç‰Œ
                        const targetIndex = aiChooseHandTarget();
                        const targetCard = gameState.playerHand[targetIndex];
                        gameState.playerHand.splice(targetIndex, 1);
                        gameState.playerHand.push(playerCard); // ç©å®¶å‡ºç‰Œå›åˆ°æ‰‹ç‰Œ
                        result = `å¯¹æ‰‹åˆºå®¢å‘åŠ¨æŠ€èƒ½ï¼šæŠ½å–å¹¶åˆºæ€äº†ä½ çš„${cardDefinitions[targetCard].name}ï¼ä½ çš„${playerCardDef.name}å›åˆ°æ‰‹ç‰Œï¼åˆºå®¢å®Œæˆä»»åŠ¡åæ­»äº¡ï¼`;
                        opponentCardSurvives = false;
                        specialEffect = 'ğŸ”ª è¢«æŠ½ç‰Œåˆºæ€ ğŸ”ª';
                        playerCardSurvives = false; // å·²ç»æ‰‹åŠ¨å¤„ç†å›åˆ°æ‰‹ç‰Œ
                    }
                }
            }
            // å¥´éš¶ç‰¹æ®Šèƒ½åŠ›
            else if (playerCard === 'slave' && opponentCard === 'king') {
                result = 'å¥´éš¶æ¨ç¿»ç‹åº§ï¼šå›½ç‹è¢«å‡»è´¥ï¼';
                playerCardSurvives = true;
                specialEffect = 'âš”ï¸ æ¨ç¿»ç‹åº§ âš”ï¸';
            }
            else if (opponentCard === 'slave' && playerCard === 'king') {
                result = 'å¯¹æ‰‹å¥´éš¶æ¨ç¿»ç‹åº§ï¼šå›½ç‹è¢«å‡»è´¥ï¼';
                opponentCardSurvives = true;
                specialEffect = 'âš”ï¸ ç‹åº§å€¾è¦† âš”ï¸';
            }
            // çš‡å®¶å®ˆå«ä¿æŠ¤
            else if (playerCard === 'king' && gameState.royalGuardProtection) {
                result = 'çš‡å®¶å®ˆå«ä¿æŠ¤ç”Ÿæ•ˆï¼šå›½ç‹å…æ­»ä¸€æ¬¡ï¼';
                playerCardSurvives = true;
                gameState.royalGuardProtection = false;
                specialEffect = 'ğŸ›¡ï¸ çš‡å®¶ä¿æŠ¤ ğŸ›¡ï¸';
            }
            // æ™®é€šç­‰çº§å¯¹æ¯”
            else {
                if (playerCardDef.level > opponentCardDef.level) {
                    result = `${playerCardDef.name}ï¼ˆç­‰çº§${playerCardDef.level}ï¼‰å‡»è´¥äº†${opponentCardDef.name}ï¼ˆç­‰çº§${opponentCardDef.level}ï¼‰ï¼`;
                    playerCardSurvives = true;
                } else if (opponentCardDef.level > playerCardDef.level) {
                    result = `${opponentCardDef.name}ï¼ˆç­‰çº§${opponentCardDef.level}ï¼‰å‡»è´¥äº†${playerCardDef.name}ï¼ˆç­‰çº§${playerCardDef.level}ï¼‰ï¼`;
                    opponentCardSurvives = true;
                } else {
                    result = `åŒæ–¹ç­‰çº§ç›¸åŒï¼ˆ${playerCardDef.level}ï¼‰ï¼šåŒå½’äºå°½ï¼`;
                    specialEffect = 'âš–ï¸ åŠ¿å‡åŠ›æ•Œ âš–ï¸';
                }
            }
            
            // å¤„ç†ç‰¹æ®Šæ•ˆæœ
            handleSpecialEffects(playerCard, opponentCard, playerCardSurvives, opponentCardSurvives);
            
            // æ˜¾ç¤ºæˆ˜æ–—ç»“æœ
            showBattleResult(result, specialEffect);
            
            // å­˜æ´»çš„å¡ç‰Œå›åˆ°æ‰‹ç‰Œ
            if (playerCardSurvives) {
                gameState.playerHand.push(playerCard);
            }
            if (opponentCardSurvives) {
                gameState.opponentHand.push(opponentCard);
            }
            
            // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹åŒæ­¥æ›´æ–°ç©å®¶æ‰‹ç‰Œ
            if (gameState.gameMode === 'local') {
                gameState.player1Hand = [...gameState.playerHand];
                gameState.player2Hand = [...gameState.opponentHand];
            }
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
            setTimeout(() => {
                checkGameEnd();
            }, 3000);
        }

        function handleSpecialEffects(playerCard, opponentCard, playerSurvives, opponentSurvives) {
            // çš‡å®¶å®ˆå«æ­»äº¡æ•ˆæœ
            if (playerCard === 'royalGuard' && !playerSurvives) {
                gameState.royalGuardProtection = true;
            }
            
            // ç»ˆæå®ˆå«ä½¿ç”¨è®°å½•
            if (playerCard === 'ultimateGuard') {
                gameState.ultimateGuardUsedLastTurn = true;
            } else {
                gameState.ultimateGuardUsedLastTurn = false;
            }
            
            // å¥³ç‹æ­»äº¡æ•ˆæœ
            if (playerCard === 'queen' && !playerSurvives) {
                gameState.queenDead = true;
                gameState.playerHand.push('king');
                // ç»ˆæå®ˆå«åŒæ—¶æ­»äº¡
                const ultimateGuardIndex = gameState.playerHand.indexOf('ultimateGuard');
                if (ultimateGuardIndex !== -1) {
                    gameState.playerHand.splice(ultimateGuardIndex, 1);
                }
            }
            
            if (opponentCard === 'queen' && !opponentSurvives) {
                gameState.opponentHand.push('king');
                // ç»ˆæå®ˆå«åŒæ—¶æ­»äº¡
                const ultimateGuardIndex = gameState.opponentHand.indexOf('ultimateGuard');
                if (ultimateGuardIndex !== -1) {
                    gameState.opponentHand.splice(ultimateGuardIndex, 1);
                }
            }
        }

        function handleDoubleAssassin() {
            // åŒæ–¹åˆºå®¢å¯¹å†³ï¼Œåªèƒ½åˆºæ€æ‰‹ç‰Œ
            let result = 'åŒæ–¹åˆºå®¢å¯¹å†³ï¼š';
            let playerLoss = '';
            let opponentLoss = '';
            
            if (gameState.playerHand.length > 0 && gameState.opponentHand.length > 0) {
                const playerTargetIndex = Math.floor(Math.random() * gameState.playerHand.length);
                const opponentTargetIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                
                const playerTarget = gameState.playerHand[playerTargetIndex];
                const opponentTarget = gameState.opponentHand[opponentTargetIndex];
                
                gameState.playerHand.splice(playerTargetIndex, 1);
                gameState.opponentHand.splice(opponentTargetIndex, 1);
                
                playerLoss = cardDefinitions[playerTarget].name;
                opponentLoss = cardDefinitions[opponentTarget].name;
                
                result += `äº’ç›¸åˆºæ€æ‰‹ç‰Œï¼ä½ å¤±å»äº†${playerLoss}ï¼Œå¯¹æ‰‹å¤±å»äº†${opponentLoss}ï¼`;
            } else if (gameState.playerHand.length > 0) {
                const playerTargetIndex = Math.floor(Math.random() * gameState.playerHand.length);
                const playerTarget = gameState.playerHand[playerTargetIndex];
                gameState.playerHand.splice(playerTargetIndex, 1);
                playerLoss = cardDefinitions[playerTarget].name;
                result += `ä½ å¤±å»äº†æ‰‹ç‰Œ${playerLoss}ï¼`;
            } else if (gameState.opponentHand.length > 0) {
                const opponentTargetIndex = Math.floor(Math.random() * gameState.opponentHand.length);
                const opponentTarget = gameState.opponentHand[opponentTargetIndex];
                gameState.opponentHand.splice(opponentTargetIndex, 1);
                opponentLoss = cardDefinitions[opponentTarget].name;
                result += `å¯¹æ‰‹å¤±å»äº†æ‰‹ç‰Œ${opponentLoss}ï¼`;
            } else {
                result += 'åŒæ–¹éƒ½æ²¡æœ‰æ‰‹ç‰Œå¯åˆºæ€ï¼';
            }
            
            // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹åŒæ­¥æ›´æ–°ç©å®¶æ‰‹ç‰Œ
            if (gameState.gameMode === 'local') {
                gameState.player1Hand = [...gameState.playerHand];
                gameState.player2Hand = [...gameState.opponentHand];
            }
            
            showBattleResult(result, 'ğŸ—¡ï¸ åˆºå®¢å¯¹å†³ ğŸ—¡ï¸');
            
            setTimeout(() => {
                checkGameEnd();
            }, 3000);
        }

        function showBattleResult(result, specialEffect) {
            // è®°å½•æœ¬å›åˆæˆ˜æ–—
            const battleRecord = {
                turn: gameState.currentTurn,
                playerCard: {
                    name: cardDefinitions[gameState.playerPlayedCard].name,
                    icon: cardDefinitions[gameState.playerPlayedCard].icon,
                    id: gameState.playerPlayedCard
                },
                opponentCard: {
                    name: cardDefinitions[gameState.opponentPlayedCard].name,
                    icon: cardDefinitions[gameState.opponentPlayedCard].icon,
                    id: gameState.opponentPlayedCard
                },
                result: result,
                specialEffect: specialEffect || null
            };
            gameState.currentGameRecord.battles.push(battleRecord);
            

            
            // æ˜¾ç¤ºè¯¦ç»†çš„æˆ˜æ–—ä¿¡æ¯
            const playerCardName = cardDefinitions[gameState.playerPlayedCard].name;
            const opponentCardName = cardDefinitions[gameState.opponentPlayedCard].name;
            const playerIcon = cardDefinitions[gameState.playerPlayedCard].icon;
            const opponentIcon = cardDefinitions[gameState.opponentPlayedCard].icon;
            
            let playerLabel = gameState.gameMode === 'ai' ? 'ä½ ' : 'ç©å®¶1';
            let opponentLabel = gameState.gameMode === 'ai' ? 'å¯¹æ‰‹' : 'ç©å®¶2';
            
            const detailedResult = `
                <div style="margin-bottom: 15px;">
                    <strong>æœ¬å›åˆå¯¹æˆ˜ï¼š</strong><br>
                    ${playerLabel}å‡ºäº†ï¼š${playerIcon} ${playerCardName}<br>
                    ${opponentLabel}å‡ºäº†ï¼š${opponentIcon} ${opponentCardName}
                </div>
                <div>${result}</div>
            `;
            
            document.getElementById('resultText').innerHTML = detailedResult;
            document.getElementById('battleResult').style.display = 'block';
            
            if (specialEffect) {
                const effectDiv = document.createElement('div');
                effectDiv.className = 'special-effect';
                effectDiv.textContent = specialEffect;
                document.querySelector('.battle-area').appendChild(effectDiv);
                
                setTimeout(() => {
                    effectDiv.remove();
                }, 2000);
            }
        }



        // ç”Ÿæˆè‡ªç„¶çš„æˆ˜æ–—æè¿°
        function generateNaturalBattleDescription(battle) {
            const playerCard = battle.playerCard;
            const opponentCard = battle.opponentCard;
            const result = battle.result;
            
            let description = '';
            let resultClass = 'draw';
            
            // æ ¹æ®å¡ç‰Œç»„åˆå’Œç»“æœç”Ÿæˆè‡ªç„¶æè¿°
            if (result.includes('å± å¤«')) {
                description = 'ğŸ’€ å± å¤«åŒå½’äºå°½';
                resultClass = 'draw';
            } else if (result.includes('åˆºå®¢å‘åŠ¨æŠ€èƒ½') && !result.includes('å¯¹æ‰‹åˆºå®¢')) {
                if (result.includes('åˆºæ€äº†ä½ çš„')) {
                    description = `ğŸ”ª ${playerCard.name}è¢«åˆºæ€`;
                    resultClass = 'victory';
                } else {
                    description = `ğŸ”ª åˆºæ€äº†${opponentCard.name}`;
                    resultClass = 'victory';
                }
            } else if (result.includes('å¯¹æ‰‹åˆºå®¢å‘åŠ¨æŠ€èƒ½')) {
                if (result.includes('æŠ½å–å¹¶åˆºæ€')) {
                    description = 'ğŸ”ª æ‰‹ç‰Œè¢«æŠ½æ€';
                    resultClass = 'defeat';
                } else {
                    description = `ğŸ”ª ${playerCard.name}è¢«åˆºæ€`;
                    resultClass = 'defeat';
                }
            } else if (result.includes('åŒæ–¹åˆºå®¢å¯¹å†³')) {
                description = 'âš”ï¸ åˆºå®¢äº’æ€';
                resultClass = 'special';
            } else if (result.includes('å¥´éš¶æ¨ç¿»ç‹åº§')) {
                if (result.includes('å¯¹æ‰‹å¥´éš¶')) {
                    description = 'ğŸ‘‘ ç‹åº§è¢«æ¨ç¿»';
                    resultClass = 'defeat';
                } else {
                    description = 'âš”ï¸ æ¨ç¿»ç‹åº§';
                    resultClass = 'victory';
                }
            } else if (result.includes('çš‡å®¶å®ˆå«ä¿æŠ¤')) {
                description = 'ğŸ›¡ï¸ çš‡å®¶å®ˆå«æŠ¤ä¸»';
                resultClass = 'victory';
            } else if (result.includes('ç»ˆæå®ˆå«å…ç–«')) {
                if (result.includes('åˆºå®¢è¢«å‡»æ€')) {
                    description = 'ğŸ›¡ï¸ å…ç–«åˆºæ€';
                    resultClass = 'victory';
                } else {
                    description = 'ğŸ›¡ï¸ ç»ˆæé˜²æŠ¤';
                    resultClass = 'defeat';
                }
            } else if (result.includes('å‡»è´¥')) {
                // ç­‰çº§å¯¹æ¯”ç»“æœ
                const playerLevel = cardDefinitions[playerCard.id].level;
                const opponentLevel = cardDefinitions[opponentCard.id].level;
                
                if (result.includes(`${playerCard.name}ï¼ˆç­‰çº§${playerLevel}ï¼‰å‡»è´¥`)) {
                    if (playerLevel > opponentLevel) {
                        description = `ğŸ’ª ${playerCard.name}å‹åˆ¶è·èƒœ`;
                    } else {
                        description = `âš”ï¸ ${playerCard.name}é€†è¢­èƒœåˆ©`;
                    }
                    resultClass = 'victory';
                } else {
                    if (opponentLevel > playerLevel) {
                        description = `ğŸ˜” è¢«${opponentCard.name}å‹åˆ¶`;
                    } else {
                        description = `ğŸ’” ${opponentCard.name}é€†è¢­`;
                    }
                    resultClass = 'defeat';
                }
            } else if (result.includes('åŒå½’äºå°½') || result.includes('åŠ¿å‡åŠ›æ•Œ')) {
                description = 'âš–ï¸ åŠ¿å‡åŠ›æ•Œ';
                resultClass = 'draw';
            } else {
                // é»˜è®¤æƒ…å†µ
                description = 'âš”ï¸ æ¿€çƒˆäº¤é”‹';
                resultClass = 'draw';
            }
            
            return {
                text: description,
                class: resultClass
            };
        }

        function checkGameEnd() {
            let gameEnded = false;
            let winner = '';
            let reason = '';
            
            // æ£€æŸ¥å…³é”®ç‰Œæ˜¯å¦å­˜åœ¨
            const playerHasKey = gameState.playerHand.some(card => 
                cardDefinitions[card].type === 'key'
            );
            const opponentHasKey = gameState.opponentHand.some(card => 
                cardDefinitions[card].type === 'key'
            );
            
            // ç¡®å®šè°æ˜¯ç‹æ–¹ï¼Œè°æ˜¯å¥´éš¶æ–¹
            let playerIsKing = gameState.playerFaction === 'king';
            let playerKeyExists = playerIsKing ? playerHasKey : opponentHasKey;
            let slaveHandEmpty = playerIsKing ? (gameState.opponentHand.length === 0) : (gameState.playerHand.length === 0);
            
            // å¥´éš¶æ–¹èƒœåˆ©æ¡ä»¶ï¼šç‹æ–¹çš„å…³é”®ç‰Œé˜µäº¡
            if (playerIsKing && !playerHasKey) {
                winner = gameState.gameMode === 'ai' ? 'å¥´éš¶æ–¹èƒœåˆ©ï¼' : 'ç©å®¶2èƒœåˆ©ï¼';
                reason = 'å›½ç‹æ–¹çš„å…³é”®ç‰Œå·²è¢«å‡»è´¥ï¼';
                gameEnded = true;
            } else if (!playerIsKing && !opponentHasKey) {
                winner = gameState.gameMode === 'ai' ? 'å¥´éš¶æ–¹èƒœåˆ©ï¼' : 'ç©å®¶1èƒœåˆ©ï¼';
                reason = 'æˆåŠŸå‡»è´¥äº†å›½ç‹æ–¹çš„å…³é”®ç‰Œï¼';
                gameEnded = true;
            }
            // ç‹æ–¹èƒœåˆ©æ¡ä»¶ï¼šå¥´éš¶æ–¹æ— æ³•å†å‡»æ€å…³é”®ç‰Œï¼ˆå¥´éš¶æ–¹æ‰‹ç‰Œè€—å°½ä¸”ç‹æ–¹å…³é”®ç‰Œå­˜æ´»ï¼‰
            else if (playerIsKing && gameState.opponentHand.length === 0 && playerHasKey) {
                winner = gameState.gameMode === 'ai' ? 'å›½ç‹æ–¹èƒœåˆ©ï¼' : 'ç©å®¶1èƒœåˆ©ï¼';
                reason = 'å¥´éš¶æ–¹å·²æ— åŠ›ç»§ç»­åæŠ—ï¼Œç‹åº§å¾—ä»¥ä¿å…¨ï¼';
                gameEnded = true;
            } else if (!playerIsKing && gameState.playerHand.length === 0 && opponentHasKey) {
                winner = gameState.gameMode === 'ai' ? 'å›½ç‹æ–¹èƒœåˆ©ï¼' : 'ç©å®¶2èƒœåˆ©ï¼';
                reason = 'å¥´éš¶æ–¹å·²æ— åŠ›ç»§ç»­åæŠ—ï¼Œç‹åº§å¾—ä»¥ä¿å…¨ï¼';
                gameEnded = true;
            }
            // åŒæ–¹æ‰‹ç‰Œéƒ½è€—å°½çš„æƒ…å†µ
            else if (gameState.playerHand.length === 0 && gameState.opponentHand.length === 0) {
                if (playerHasKey && !opponentHasKey) {
                    winner = gameState.gameMode === 'ai' ? (playerIsKing ? 'å›½ç‹æ–¹èƒœåˆ©ï¼' : 'å¥´éš¶æ–¹èƒœåˆ©ï¼') : 'ç©å®¶1èƒœåˆ©ï¼';
                    reason = 'ä½ çš„å…³é”®ç‰Œå­˜æ´»åˆ°æœ€åï¼';
                } else if (!playerHasKey && opponentHasKey) {
                    winner = gameState.gameMode === 'ai' ? (playerIsKing ? 'å¥´éš¶æ–¹èƒœåˆ©ï¼' : 'å›½ç‹æ–¹èƒœåˆ©ï¼') : 'ç©å®¶2èƒœåˆ©ï¼';
                    reason = 'å¯¹æ‰‹çš„å…³é”®ç‰Œå­˜æ´»åˆ°æœ€åï¼';
                } else if (playerHasKey && opponentHasKey) {
                    winner = 'å¹³å±€ï¼';
                    reason = 'åŒæ–¹å…³é”®ç‰Œéƒ½å­˜æ´»ï¼ŒåŠ¿å‡åŠ›æ•Œï¼';
                } else {
                    winner = 'å¹³å±€ï¼';
                    reason = 'åŒæ–¹å…³é”®ç‰ŒåŒå½’äºå°½ï¼';
                }
                gameEnded = true;
            }
            // å•æ–¹æ‰‹ç‰Œè€—å°½ä½†å¯¹æ–¹è¿˜æœ‰ç‰Œçš„æƒ…å†µ
            else if (gameState.playerHand.length === 0) {
                winner = gameState.gameMode === 'ai' ? 'ä½ è´¥åŒ—äº†ï¼' : 'ç©å®¶2èƒœåˆ©ï¼';
                reason = gameState.gameMode === 'ai' ? 'ä½ çš„æ‰‹ç‰Œå·²è€—å°½ï¼' : 'ç©å®¶1çš„æ‰‹ç‰Œå·²è€—å°½ï¼';
                gameEnded = true;
            } else if (gameState.opponentHand.length === 0) {
                winner = gameState.gameMode === 'ai' ? 'ä½ èƒœåˆ©äº†ï¼' : 'ç©å®¶1èƒœåˆ©ï¼';
                reason = gameState.gameMode === 'ai' ? 'å¯¹æ‰‹çš„æ‰‹ç‰Œå·²è€—å°½ï¼' : 'ç©å®¶2çš„æ‰‹ç‰Œå·²è€—å°½ï¼';
                gameEnded = true;
            }
            
            if (gameEnded) {
                setTimeout(() => {
                    showGameOver(winner, reason);
                }, 1000);
            } else {
                // ç»§ç»­ä¸‹ä¸€å›åˆ
                setTimeout(() => {
                    nextTurn();
                }, 1000);
            }
        }

        function nextTurn() {
            document.getElementById('battleResult').style.display = 'none';
            
            // è¿›å…¥å›åˆç»“æŸé˜¶æ®µ
            gameState.gamePhase = 'end';
            updatePhaseIndicator();
            
            setTimeout(() => {
                // å¼€å§‹æ–°å›åˆ
                gameState.currentTurn++;
                gameState.gamePhase = 'select';
                
                // æ¸…ç©ºæˆ˜æ–—åŒºåŸŸ
                document.getElementById('playerPlayedCard').innerHTML = '<div style="font-size: 1.2rem;">ç­‰å¾…å‡ºç‰Œ</div>';
                document.getElementById('opponentPlayedCard').innerHTML = '<div style="font-size: 1.2rem;">ç­‰å¾…å‡ºç‰Œ</div>';
                
                // é‡ç½®é€‰æ‹©çŠ¶æ€
                gameState.playerSelectedCard = null;
                gameState.opponentSelectedCard = null;
                gameState.playerPlayedCard = null;
                gameState.opponentPlayedCard = null;
                gameState.playerReady = false;
                gameState.opponentReady = false;
                gameState.player1Ready = false;
                gameState.player2Ready = false;
                gameState.currentPlayer = 1;
                
                // é‡ç½®è¾¹æ¡†é¢œè‰²
                document.querySelector('.player-area').style.borderColor = '#d4af37';
                document.querySelector('.opponent-area').style.borderColor = '#4a90e2';
                
                // æ¸…ç†AIé€‰æ‹©æŒ‡ç¤ºå™¨
                const aiIndicator = document.querySelector('.ai-selected-indicator');
                if (aiIndicator) {
                    aiIndicator.remove();
                }
                
                // é‡ç½®æŒ‰é’®
                document.getElementById('playCardBtn').disabled = true;
                document.getElementById('playCardBtn').textContent = 'å‡ºç‰Œ';
                
                // éšè—ç©å®¶æŒ‡ç¤ºå™¨
                document.getElementById('currentPlayerIndicator').style.display = 'none';
                document.getElementById('currentPlayerIndicator2').style.display = 'none';
                document.getElementById('opponentHandCards').style.display = 'none';
                document.getElementById('playerHand').style.display = 'flex';
                
                // æ›´æ–°UI
                updateGameUI();
                updatePhaseIndicator();
                
                if (gameState.gameMode === 'ai') {
                    // AIé‡æ–°é€‰æ‹©å¡ç‰Œ
                    setTimeout(() => {
                        aiSelectCard();
                    }, 1000 + Math.random() * 2000);
                } else {
                    // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ï¼Œæ˜¾ç¤ºå½“å‰ç©å®¶æŒ‡ç¤ºå™¨
                    updateCurrentPlayerIndicator();
                }
            }, 1000);
        }

        function showGameOver(winner, reason) {
            // æ£€æŸ¥æ˜¯å¦å·²ç»è®°å½•è¿‡è¿™åœºæ¸¸æˆï¼Œé¿å…é‡å¤è®°å½•
            if (gameState.currentGameRecord.endTime) {
                console.log('æ¸¸æˆå·²ç»“æŸï¼Œé¿å…é‡å¤è®°å½•');
                document.getElementById('winnerText').textContent = winner;
                document.getElementById('gameOverReason').textContent = reason;
                document.getElementById('gameOver').style.display = 'flex';
                document.getElementById('battleResult').style.display = 'none';
                return;
            }
            
            // å®Œæˆæ¸¸æˆè®°å½•
            gameState.currentGameRecord.endTime = new Date();
            gameState.currentGameRecord.totalTurns = gameState.currentTurn;
            gameState.currentGameRecord.finalReason = reason;
            
            // åˆ¤æ–­æ¸¸æˆç»“æœ
            if (gameState.gameMode === 'ai') {
                if (winner.includes('èƒœåˆ©') && !winner.includes('è´¥åŒ—')) {
                    gameState.currentGameRecord.result = 'victory';
                } else if (winner.includes('è´¥åŒ—') || winner.includes('å¤±è´¥')) {
                    gameState.currentGameRecord.result = 'defeat';
                } else if (winner.includes('å¹³å±€')) {
                    gameState.currentGameRecord.result = 'draw';
                } else {
                    // æ ¹æ®å…·ä½“æ–‡æœ¬åˆ¤æ–­
                    if (winner.includes('å›½ç‹æ–¹èƒœåˆ©') && gameState.playerFaction === 'king') {
                        gameState.currentGameRecord.result = 'victory';
                    } else if (winner.includes('å¥´éš¶æ–¹èƒœåˆ©') && gameState.playerFaction === 'slave') {
                        gameState.currentGameRecord.result = 'victory';
                    } else if (winner.includes('å›½ç‹æ–¹èƒœåˆ©') && gameState.playerFaction === 'slave') {
                        gameState.currentGameRecord.result = 'defeat';
                    } else if (winner.includes('å¥´éš¶æ–¹èƒœåˆ©') && gameState.playerFaction === 'king') {
                        gameState.currentGameRecord.result = 'defeat';
                    } else {
                        gameState.currentGameRecord.result = 'draw';
                    }
                }
            } else {
                // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ï¼Œä¸è®°å½•èƒœè´Ÿï¼Œåªè®°å½•å®ŒæˆçŠ¶æ€
                gameState.currentGameRecord.result = 'completed';
            }
            
            // ä¿å­˜åˆ°å†å²è®°å½•ï¼ˆAIå¯¹æˆ˜å’Œæœ¬åœ°å¯¹æˆ˜éƒ½ä¿å­˜ï¼‰
            gameHistory.unshift(gameState.currentGameRecord);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼ˆæœ€å¤šä¿å­˜50åœºï¼‰
            if (gameHistory.length > 50) {
                gameHistory = gameHistory.slice(0, 50);
            }
            
            // æ›´æ–°ç©å®¶ç»Ÿè®¡ï¼ˆä»…AIå¯¹æˆ˜ï¼‰
            if (gameState.gameMode === 'ai') {
                updatePlayerStats(gameState.currentGameRecord);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const saveSuccess = saveToLocalStorage();
            if (saveSuccess) {
                console.log('æ¸¸æˆè®°å½•å·²ä¿å­˜:', gameState.currentGameRecord);
            }
            
            document.getElementById('winnerText').textContent = winner;
            document.getElementById('gameOverReason').textContent = reason;
            document.getElementById('gameOver').style.display = 'flex';
            document.getElementById('battleResult').style.display = 'none';
        }

        // ç»§ç»­æŒ‰é’®
        document.getElementById('continueBtn').addEventListener('click', nextTurn);

        // åˆºå®¢é€‰æ‹©åŠŸèƒ½
        function showAssassinChoice(isPlayer) {
            const modal = document.getElementById('assassinSelection');
            const optionsContainer = document.getElementById('assassinOptions');
            
            optionsContainer.innerHTML = '';
            
            if (isPlayer) {
                // ç©å®¶åˆºå®¢é€‰æ‹©
                const killPlayedOption = document.createElement('button');
                killPlayedOption.className = 'assassin-option';
                killPlayedOption.textContent = `åˆºæ€å¯¹æ‰‹å‡ºç‰Œ (${cardDefinitions[gameState.opponentPlayedCard].name})`;
                killPlayedOption.onclick = () => handleAssassinChoice('killPlayed', true);
                
                const drawKillOption = document.createElement('button');
                drawKillOption.className = 'assassin-option';
                drawKillOption.textContent = 'æŠ½å–å¯¹æ‰‹æ‰‹ç‰Œå¹¶åˆºæ€';
                if (gameState.opponentHand.length === 0) {
                    drawKillOption.disabled = true;
                    drawKillOption.style.opacity = '0.5';
                    drawKillOption.textContent += ' (å¯¹æ‰‹æ— æ‰‹ç‰Œ)';
                }
                drawKillOption.onclick = () => showHandSelection();
                
                optionsContainer.appendChild(killPlayedOption);
                optionsContainer.appendChild(drawKillOption);
            }
            
            modal.style.display = 'flex';
        }

        function showHandSelection() {
            const modal = document.getElementById('assassinSelection');
            const modalContent = modal.querySelector('.assassin-modal');
            
            modalContent.innerHTML = `
                <h3 style="color: #d4af37; margin-bottom: 20px;">ğŸ”ª é€‰æ‹©åˆºæ€ç›®æ ‡</h3>
                <p style="margin-bottom: 20px;">ä»å¯¹æ‰‹æ‰‹ç‰Œä¸­ç›²é€‰ä¸€å¼ å¡ç‰Œè¿›è¡Œåˆºæ€ï¼š</p>
                <div id="handSelectionCards" class="hand-selection-cards" style="
                    display: flex;
                    gap: 10px;
                    justify-content: center;
                    flex-wrap: wrap;
                    margin: 20px 0;
                "></div>
                <button onclick="cancelHandSelection()" style="
                    background: #666;
                    border: 2px solid #999;
                    color: #fff;
                    padding: 8px 15px;
                    border-radius: 6px;
                    cursor: pointer;
                    margin-top: 10px;
                ">è¿”å›</button>
            `;
            
            const cardsContainer = document.getElementById('handSelectionCards');
            
            // æ˜¾ç¤ºå¡ç‰ŒèƒŒé¢ï¼Œä¸æ˜¾ç¤ºå…·ä½“å†…å®¹
            gameState.opponentHand.forEach((cardId, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'hand-selection-card';
                cardElement.style.cssText = `
                    width: 80px;
                    height: 120px;
                    background: linear-gradient(145deg, #654321, #4a2c17);
                    border: 2px solid #8b4513;
                    border-radius: 8px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    padding: 8px;
                    position: relative;
                `;
                
                cardElement.innerHTML = `
                    <div style="font-size: 2rem; margin-bottom: 8px;">ğŸ´</div>
                    <div style="font-size: 0.7rem; color: #d4af37; font-weight: bold;">ç¬¬${index + 1}å¼ </div>
                    <div style="font-size: 0.6rem; color: #f4e4bc; margin-top: 5px;">ç‚¹å‡»åˆºæ€</div>
                `;
                
                cardElement.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#d4af37';
                    this.style.transform = 'translateY(-5px)';
                    this.style.boxShadow = '0 8px 16px rgba(212, 175, 55, 0.3)';
                });
                
                cardElement.addEventListener('mouseleave', function() {
                    this.style.borderColor = '#8b4513';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = 'none';
                });
                
                cardElement.addEventListener('click', function() {
                    handleAssassinChoice('drawKill', true, index);
                });
                
                cardsContainer.appendChild(cardElement);
            });
        }

        function cancelHandSelection() {
            showAssassinChoice(true);
        }
        
        function handleAssassinChoice(choice, isPlayer, targetIndex = null) {
            document.getElementById('assassinSelection').style.display = 'none';
            
            let result = '';
            let playerCardSurvives = false;
            let opponentCardSurvives = false;
            let specialEffect = '';
            
            const playerCard = gameState.playerPlayedCard;
            const opponentCard = gameState.opponentPlayedCard;
            const playerCardDef = cardDefinitions[playerCard];
            const opponentCardDef = cardDefinitions[opponentCard];
            
            if (isPlayer) {
                if (choice === 'killPlayed') {
                    // åˆºæ€å¯¹æ‰‹å‡ºç‰Œï¼Œåˆºå®¢æ­»äº¡
                    result = `åˆºå®¢å‘åŠ¨æŠ€èƒ½ï¼šæ— è§†ç­‰çº§åˆºæ€${opponentCardDef.name}ï¼åˆºå®¢å®Œæˆä»»åŠ¡åæ­»äº¡ï¼`;
                    playerCardSurvives = false;
                    opponentCardSurvives = false;
                    specialEffect = 'ğŸ”ª åˆºæ€å‡ºç‰Œ ğŸ”ª';
                } else if (choice === 'drawKill') {
                    // ç©å®¶é€‰æ‹©çš„ç›®æ ‡æ‰‹ç‰Œåˆºæ€ï¼Œå¯¹æ‰‹å‡ºç‰Œå›åˆ°æ‰‹ç‰Œï¼Œåˆºå®¢æ­»äº¡
                    const targetCard = gameState.opponentHand[targetIndex];
                    gameState.opponentHand.splice(targetIndex, 1);
                    gameState.opponentHand.push(opponentCard); // å¯¹æ‰‹å‡ºç‰Œå›åˆ°æ‰‹ç‰Œ
                    result = `åˆºå®¢å‘åŠ¨æŠ€èƒ½ï¼šä½ é€‰æ‹©åˆºæ€äº†å¯¹æ‰‹çš„${cardDefinitions[targetCard].name}ï¼å¯¹æ‰‹çš„${opponentCardDef.name}å›åˆ°æ‰‹ç‰Œï¼åˆºå®¢å®Œæˆä»»åŠ¡åæ­»äº¡ï¼`;
                    playerCardSurvives = false;
                    opponentCardSurvives = false; // å·²ç»æ‰‹åŠ¨å¤„ç†å›åˆ°æ‰‹ç‰Œï¼Œä¸éœ€è¦å†æ¬¡æ·»åŠ 
                    specialEffect = 'ğŸ”ª ç²¾å‡†åˆºæ€ ğŸ”ª';
                }
            }
            
            // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹åŒæ­¥æ›´æ–°ç©å®¶æ‰‹ç‰Œ
            if (gameState.gameMode === 'local') {
                gameState.player1Hand = [...gameState.playerHand];
                gameState.player2Hand = [...gameState.opponentHand];
            }
            
            // å¤„ç†ç‰¹æ®Šæ•ˆæœ
            handleSpecialEffects(playerCard, opponentCard, playerCardSurvives, opponentCardSurvives);
            
            // æ˜¾ç¤ºæˆ˜æ–—ç»“æœ
            showBattleResult(result, specialEffect);
            
            // å­˜æ´»çš„å¡ç‰Œå›åˆ°æ‰‹ç‰Œ
            if (playerCardSurvives) {
                gameState.playerHand.push(playerCard);
            }
            if (opponentCardSurvives) {
                gameState.opponentHand.push(opponentCard);
            }
            
            // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼ä¸‹åŒæ­¥æ›´æ–°ç©å®¶æ‰‹ç‰Œ
            if (gameState.gameMode === 'local') {
                gameState.player1Hand = [...gameState.playerHand];
                gameState.player2Hand = [...gameState.opponentHand];
            }
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸæ¡ä»¶
            setTimeout(() => {
                checkGameEnd();
            }, 3000);
        }

        // å†å²æˆ˜ç»©åŠŸèƒ½
        function showHistory() {
            updateHistoryStats();
            renderHistoryList();
            document.getElementById('historyModal').style.display = 'flex';
        }

        function updateHistoryStats() {
            // ç»Ÿè®¡AIå¯¹æˆ˜çš„æˆ˜ç»©
            const aiGames = gameHistory.filter(game => game.gameMode === 'ai');
            const localGames = gameHistory.filter(game => game.gameMode === 'local');
            
            const totalAiGames = aiGames.length;
            const victories = aiGames.filter(game => game.result === 'victory').length;
            const defeats = aiGames.filter(game => game.result === 'defeat').length;
            const draws = aiGames.filter(game => game.result === 'draw').length;
            const winRate = totalAiGames > 0 ? Math.round((victories / totalAiGames) * 100) : 0;

            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('totalGames').textContent = totalAiGames;
            document.getElementById('victories').textContent = victories;
            document.getElementById('defeats').textContent = defeats;
            document.getElementById('draws').textContent = draws;
            document.getElementById('winRate').textContent = winRate + '%';
            
            // æ·»åŠ æœ¬åœ°å¯¹æˆ˜ç»Ÿè®¡
            const statsContainer = document.getElementById('historyStats');
            const existingLocalStat = statsContainer.querySelector('.local-games-stat');
            if (existingLocalStat) {
                existingLocalStat.remove();
            }
            
            if (localGames.length > 0) {
                const localStatDiv = document.createElement('div');
                localStatDiv.className = 'stat-item local-games-stat';
                localStatDiv.innerHTML = `
                    <span class="stat-number">${localGames.length}</span>
                    <div class="stat-label">æœ¬åœ°å¯¹æˆ˜</div>
                `;
                statsContainer.appendChild(localStatDiv);
            }
        }

        function renderHistoryList() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            // æ˜¾ç¤ºæ‰€æœ‰æ¸¸æˆè®°å½•ï¼ˆAIå¯¹æˆ˜å’Œæœ¬åœ°å¯¹æˆ˜ï¼‰
            if (gameHistory.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">âš”ï¸</div>
                        <div>è¿˜æ²¡æœ‰æ¸¸æˆè®°å½•</div>
                        <div style="font-size: 0.9rem; margin-top: 8px;">å¼€å§‹ä½ çš„ç¬¬ä¸€åœºå¯¹æˆ˜å§ï¼</div>
                    </div>
                `;
                return;
            }

            gameHistory.forEach((game, index) => {
                const gameItem = document.createElement('div');
                gameItem.className = `history-item ${game.result || 'completed'}`;
                
                const duration = Math.round((new Date(game.endTime) - new Date(game.startTime)) / 1000);
                const durationText = duration < 60 ? `${duration}ç§’` : `${Math.floor(duration/60)}åˆ†${duration%60}ç§’`;
                
                // è·å–ç©å®¶åå­—ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤åå­—
                const playerName = playerProfile.name || 'æˆ‘';
                
                let resultText = '';
                let gameModeText = '';
                let winnerText = '';
                let opponentName = '';
                
                if (game.gameMode === 'ai') {
                    gameModeText = 'ğŸ¤– AIå¯¹æˆ˜';
                    opponentName = 'AIæ™ºèƒ½å¯¹æ‰‹';
                    
                    if (game.result === 'victory') {
                        resultText = 'èƒœåˆ©';
                        winnerText = `ğŸ† ${playerName} è·èƒœ`;
                    } else if (game.result === 'defeat') {
                        resultText = 'å¤±è´¥';
                        winnerText = `ğŸ˜” ${opponentName} è·èƒœ`;
                    } else {
                        resultText = 'å¹³å±€';
                        winnerText = 'âš–ï¸ å¹³å±€æ”¶åœº';
                    }
                } else {
                    gameModeText = 'ğŸ‘¥ æœ¬åœ°å¯¹æˆ˜';
                    opponentName = 'æœ¬åœ°ç©å®¶2';
                    resultText = 'å·²å®Œæˆ';
                    winnerText = 'ğŸ® å¯¹æˆ˜å®Œæˆ';
                }
                
                const playerFactionText = game.playerFaction === 'king' ? 'ğŸ‘‘ å›½ç‹æ–¹' : 'ğŸ©¸ å¥´éš¶æ–¹';
                const opponentFactionText = game.opponentFaction === 'king' ? 'ğŸ‘‘ å›½ç‹æ–¹' : 'ğŸ©¸ å¥´éš¶æ–¹';
                
                const openingText = game.playerOpening === 'kingOpening' ? 'å›½ç‹å¼€å±€' :
                                  game.playerOpening === 'queenOpening' ? 'å¥³ç‹å¼€å±€' : 'å¥´éš¶å¼€å±€';

                // æ„å»ºæˆ˜æ–—è¯¦æƒ…
                const battleDetails = game.battles && game.battles.length > 0 ? 
                    game.battles.map(battle => {
                        let battleResult = '';
                        if (battle.result) {
                            // ç®€åŒ–ç»“æœæ˜¾ç¤º
                            if (battle.result.includes('å‡»è´¥')) {
                                if (battle.result.includes(`${battle.playerCard.name}ï¼ˆç­‰çº§${cardDefinitions[battle.playerCard.id].level}ï¼‰å‡»è´¥`)) {
                                    battleResult = 'ç©å®¶èƒœ';
                                } else {
                                    battleResult = 'å¯¹æ‰‹èƒœ';
                                }
                            } else if (battle.result.includes('åŒå½’äºå°½') || battle.result.includes('åŠ¿å‡åŠ›æ•Œ')) {
                                battleResult = 'å¹³å±€';
                            } else if (battle.result.includes('åˆºå®¢') || battle.result.includes('åˆºæ€')) {
                                battleResult = 'åˆºæ€';
                            } else if (battle.result.includes('å± å¤«')) {
                                battleResult = 'åŒå½’äºå°½';
                            } else if (battle.result.includes('å¥´éš¶æ¨ç¿»')) {
                                battleResult = battle.result.includes('å¯¹æ‰‹å¥´éš¶') ? 'å¯¹æ‰‹èƒœ' : 'ç©å®¶èƒœ';
                            } else {
                                battleResult = 'ç‰¹æ®Š';
                            }
                        }
                        
                        return `
                            <div style="
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center; 
                                margin: 3px 0; 
                                padding: 5px 8px; 
                                background: rgba(0,0,0,0.2); 
                                border-radius: 4px;
                                border-left: 3px solid ${battleResult === 'ç©å®¶èƒœ' ? '#32cd32' : battleResult === 'å¯¹æ‰‹èƒœ' ? '#dc143c' : '#ffd700'};
                            ">
                                <div style="flex: 1;">
                                    <span style="color: #d4af37; font-weight: bold;">ç¬¬${battle.turn}å›åˆ:</span>
                                    <div style="margin-top: 2px; font-size: 0.9rem;">
                                        <span style="color: #f4e4bc;">${playerName || 'æˆ‘'}</span> ${battle.playerCard.icon}${battle.playerCard.name} 
                                        <span style="color: #999; margin: 0 5px;">âš”ï¸</span> 
                                        <span style="color: #f4e4bc;">${opponentName}</span> ${battle.opponentCard.icon}${battle.opponentCard.name}
                                    </div>
                                </div>
                                <div style="
                                    font-size: 0.7rem; 
                                    padding: 2px 6px; 
                                    border-radius: 3px; 
                                    background: ${battleResult === 'ç©å®¶èƒœ' ? 'rgba(50,205,50,0.2)' : 
                                                battleResult === 'å¯¹æ‰‹èƒœ' ? 'rgba(220,20,60,0.2)' : 'rgba(255,215,0,0.2)'};
                                    color: ${battleResult === 'ç©å®¶èƒœ' ? '#32cd32' : 
                                            battleResult === 'å¯¹æ‰‹èƒœ' ? '#dc143c' : '#ffd700'};
                                    font-weight: bold;
                                ">
                                    ${battleResult}
                                </div>
                            </div>
                        `;
                    }).join('') : '<div style="color: #999; font-style: italic;">æ— æˆ˜æ–—è®°å½•</div>';

                gameItem.innerHTML = `
                    <div class="game-summary">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="game-result ${game.result || 'completed'}">${resultText}</div>
                            <div style="font-size: 0.8rem; color: #999; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">
                                ${gameModeText}
                            </div>
                        </div>
                        <div style="font-size: 0.9rem; color: #999;">
                            ${new Date(game.startTime).toLocaleDateString()} ${new Date(game.startTime).toLocaleTimeString().slice(0,5)}
                        </div>
                    </div>
                    <div class="game-details">
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 4px solid ${game.result === 'victory' ? '#32cd32' : game.result === 'defeat' ? '#dc143c' : '#ffd700'};">
                            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; color: #d4af37;">
                                ${winnerText}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 120px;">
                                    <div style="font-weight: bold; color: #f4e4bc;">${playerName}</div>
                                    <div style="font-size: 0.9rem; color: #999;">${playerFactionText} (${openingText})</div>
                                </div>
                                <div style="font-size: 1.5rem; color: #d4af37; font-weight: bold;">VS</div>
                                <div style="flex: 1; min-width: 120px; text-align: right;">
                                    <div style="font-weight: bold; color: #f4e4bc;">${opponentName}</div>
                                    <div style="font-size: 0.9rem; color: #999;">${opponentFactionText}</div>
                                </div>
                            </div>
                        </div>
                        ${game.finalReason ? `
                            <div style="margin-bottom: 8px;">
                                <strong>ç»“æŸåŸå› ï¼š</strong>${game.finalReason}
                            </div>
                        ` : ''}
                        <div style="margin-bottom: 8px;">
                            <strong>å¯¹å±€å†å²ï¼š</strong>
                            <div style="margin-top: 8px; max-height: 200px; overflow-y: auto; border: 1px solid rgba(139,69,19,0.3); border-radius: 6px; padding: 5px;">
                                ${battleDetails}
                            </div>
                        </div>
                    </div>
                    <div class="game-meta">
                        <span>å…±${game.totalTurns}å›åˆ</span>
                        <span>ç”¨æ—¶${durationText}</span>
                        <span>${game.battles ? game.battles.length : 0}æ¬¡äº¤é”‹</span>
                    </div>
                `;
                
                historyList.appendChild(gameItem);
            });
        }

        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                gameHistory = [];
                const saveSuccess = saveToLocalStorage();
                if (saveSuccess) {
                    showNotification('å†å²è®°å½•å·²æ¸…ç©º', 'info');
                }
                updateHistoryStats();
                renderHistoryList();
            }
        }

        // æ›´æ–°ç©å®¶ç»Ÿè®¡
        function updatePlayerStats(gameRecord) {
            const stats = playerProfile.stats;
            
            // æ›´æ–°åŸºç¡€ç»Ÿè®¡
            stats.totalBattles++;
            
            // è®¡ç®—æ¸¸æˆæ—¶é•¿
            const gameTime = Math.round((new Date(gameRecord.endTime) - new Date(gameRecord.startTime)) / 1000);
            stats.totalGameTime += gameTime;
            
            // æ›´æ–°èƒœè´Ÿç»Ÿè®¡
            if (gameRecord.result === 'victory') {
                if (gameRecord.playerFaction === 'king') {
                    stats.kingWins++;
                } else {
                    stats.slaveWins++;
                }
                stats.currentWinStreak++;
                stats.maxWinStreak = Math.max(stats.maxWinStreak, stats.currentWinStreak);
            } else if (gameRecord.result === 'defeat') {
                stats.currentWinStreak = 0;
            }
            
            // æ›´æ–°å¡ç‰Œä½¿ç”¨ç»Ÿè®¡
            if (gameRecord.battles) {
                gameRecord.battles.forEach(battle => {
                    const cardId = battle.playerCard.id;
                    stats.cardUsageCount[cardId] = (stats.cardUsageCount[cardId] || 0) + 1;
                });
            }
            
            // æ£€æŸ¥æˆå°±
            checkAchievements(gameRecord);
            
            // æ›´æ–°ç§°å·
            updatePlayerTitle();
            
            // ä¿å­˜æ¡£æ¡ˆ
            saveToLocalStorage();
        }

        // æ£€æŸ¥æˆå°±
        function checkAchievements(gameRecord) {
            const stats = playerProfile.stats;
            const victories = gameHistory.filter(g => g.gameMode === 'ai' && g.result === 'victory').length;
            
            achievementSystem.forEach(achievement => {
                if (playerProfile.achievements.includes(achievement.id)) return;
                
                let unlocked = false;
                
                switch (achievement.requirement.type) {
                    case 'victories':
                        unlocked = victories >= achievement.requirement.count;
                        break;
                    case 'winStreak':
                        unlocked = stats.maxWinStreak >= achievement.requirement.count;
                        break;
                    case 'kingWins':
                        unlocked = stats.kingWins >= achievement.requirement.count;
                        break;
                    case 'slaveWins':
                        unlocked = stats.slaveWins >= achievement.requirement.count;
                        break;
                    case 'totalBattles':
                        unlocked = stats.totalBattles >= achievement.requirement.count;
                        break;
                    case 'cardUsage':
                        const cardCount = stats.cardUsageCount[achievement.requirement.card] || 0;
                        unlocked = cardCount >= achievement.requirement.count;
                        break;
                    case 'quickWin':
                        unlocked = gameRecord.totalTurns <= achievement.requirement.turns && gameRecord.result === 'victory';
                        break;
                    case 'totalTime':
                        unlocked = stats.totalGameTime >= achievement.requirement.minutes * 60;
                        break;
                }
                
                if (unlocked) {
                    playerProfile.achievements.push(achievement.id);
                    showAchievementUnlocked(achievement);
                }
            });
        }

        // æ˜¾ç¤ºæˆå°±è§£é”é€šçŸ¥
        function showAchievementUnlocked(achievement) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(145deg, #d4af37, #b8860b);
                color: #2c1810;
                padding: 15px 20px;
                border-radius: 10px;
                border: 3px solid #2c1810;
                box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
                z-index: 10000;
                font-weight: bold;
                animation: achievementSlideIn 0.5s ease-out;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 5px;">ğŸ† æˆå°±è§£é”ï¼</div>
                <div style="font-size: 1.5rem; margin-bottom: 5px;">${achievement.icon} ${achievement.name}</div>
                <div style="font-size: 0.9rem; opacity: 0.8;">${achievement.description}</div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes achievementSlideIn {
                    0% { transform: translateX(100%); opacity: 0; }
                    100% { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.animation = 'achievementSlideIn 0.5s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 3000);
        }

        // æ›´æ–°ç©å®¶ç§°å·
        function updatePlayerTitle() {
            const victories = gameHistory.filter(g => g.gameMode === 'ai' && g.result === 'victory').length;
            
            for (let i = titleSystem.length - 1; i >= 0; i--) {
                if (victories >= titleSystem[i].requirement) {
                    playerProfile.title = titleSystem[i].name;
                    break;
                }
            }
        }

        // æ˜¾ç¤ºä¸ªäººä¸»é¡µ
        function showProfile() {
            updateProfileDisplay();
            document.getElementById('profileModal').style.display = 'flex';
        }

        // æ›´æ–°ä¸ªäººä¸»é¡µæ˜¾ç¤º
        function updateProfileDisplay() {
            // æ›´æ–°å¤´åƒå’Œæ˜µç§°
            document.getElementById('profileAvatar').textContent = playerProfile.avatar;
            document.getElementById('playerName').value = playerProfile.name;
            document.getElementById('playerTitle').textContent = playerProfile.title;
            
            // æ›´æ–°å¤´åƒé€‰æ‹©å™¨
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.avatar === playerProfile.avatar) {
                    option.classList.add('selected');
                }
            });
            
            // æ›´æ–°ç§°å·è¿›åº¦
            updateTitleProgress();
            
            // æ›´æ–°æˆå°±
            updateAchievementsDisplay();
            
            // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
            updateDetailedStats();
        }

        // æ›´æ–°ç§°å·è¿›åº¦
        function updateTitleProgress() {
            const victories = gameHistory.filter(g => g.gameMode === 'ai' && g.result === 'victory').length;
            const currentTitleIndex = titleSystem.findIndex(title => title.name === playerProfile.title);
            const nextTitleIndex = currentTitleIndex + 1;
            
            if (nextTitleIndex < titleSystem.length) {
                const nextTitle = titleSystem[nextTitleIndex];
                const progress = Math.min(100, (victories / nextTitle.requirement) * 100);
                const remaining = Math.max(0, nextTitle.requirement - victories);
                
                document.getElementById('titleProgress').style.width = progress + '%';
                document.getElementById('titleProgressText').textContent = 
                    `${remaining}èƒœåˆ©è§£é” "${nextTitle.name}"`;
            } else {
                document.getElementById('titleProgress').style.width = '100%';
                document.getElementById('titleProgressText').textContent = 'å·²è¾¾åˆ°æœ€é«˜ç§°å·ï¼';
            }
        }

        // æ›´æ–°æˆå°±æ˜¾ç¤º
        function updateAchievementsDisplay() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            achievementSystem.forEach(achievement => {
                const isUnlocked = playerProfile.achievements.includes(achievement.id);
                const achievementDiv = document.createElement('div');
                achievementDiv.className = `achievement-item ${isUnlocked ? 'unlocked' : 'locked'}`;
                
                // è®¡ç®—è¿›åº¦
                let progressText = '';
                if (!isUnlocked) {
                    const stats = playerProfile.stats;
                    const victories = gameHistory.filter(g => g.gameMode === 'ai' && g.result === 'victory').length;
                    
                    let current = 0;
                    let total = achievement.requirement.count;
                    
                    switch (achievement.requirement.type) {
                        case 'victories':
                            current = victories;
                            break;
                        case 'winStreak':
                            current = stats.maxWinStreak;
                            break;
                        case 'kingWins':
                            current = stats.kingWins;
                            break;
                        case 'slaveWins':
                            current = stats.slaveWins;
                            break;
                        case 'totalBattles':
                            current = stats.totalBattles;
                            break;
                        case 'cardUsage':
                            current = stats.cardUsageCount[achievement.requirement.card] || 0;
                            break;
                        case 'totalTime':
                            current = Math.floor(stats.totalGameTime / 60);
                            total = achievement.requirement.minutes;
                            break;
                    }
                    
                    if (achievement.requirement.type !== 'quickWin') {
                        progressText = `<div class="achievement-progress">${current}/${total}</div>`;
                    }
                }
                
                achievementDiv.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.description}</div>
                    ${progressText}
                    ${isUnlocked ? '<div style="color: #32cd32; font-size: 0.8rem; margin-top: 5px;">âœ“ å·²è§£é”</div>' : ''}
                `;
                
                container.appendChild(achievementDiv);
            });
        }

        // æ›´æ–°è¯¦ç»†ç»Ÿè®¡
        function updateDetailedStats() {
            const stats = playerProfile.stats;
            const victories = gameHistory.filter(g => g.gameMode === 'ai' && g.result === 'victory').length;
            
            document.getElementById('totalBattles').textContent = stats.totalBattles;
            document.getElementById('kingWins').textContent = stats.kingWins;
            document.getElementById('slaveWins').textContent = stats.slaveWins;
            document.getElementById('winStreak').textContent = stats.maxWinStreak;
            
            // å¹³å‡æ¸¸æˆæ—¶é•¿
            const avgTime = stats.totalBattles > 0 ? Math.round(stats.totalGameTime / stats.totalBattles) : 0;
            const avgMinutes = Math.floor(avgTime / 60);
            const avgSeconds = avgTime % 60;
            document.getElementById('avgGameTime').textContent = 
                avgMinutes > 0 ? `${avgMinutes}åˆ†${avgSeconds}ç§’` : `${avgSeconds}ç§’`;
            
            // æœ€å¸¸ç”¨å¡ç‰Œ
            let mostUsedCard = 'å¸‚æ°‘';
            let maxUsage = 0;
            Object.entries(stats.cardUsageCount).forEach(([cardId, count]) => {
                if (count > maxUsage) {
                    maxUsage = count;
                    mostUsedCard = cardDefinitions[cardId].name;
                }
            });
            document.getElementById('favoriteCard').textContent = mostUsedCard;
        }

        // ä¿å­˜ä¸ªäººè®¾ç½®
        function saveProfile() {
            playerProfile.name = document.getElementById('playerName').value.trim();
            const saveSuccess = saveToLocalStorage();
            
            // æ˜¾ç¤ºä¿å­˜ç»“æœæç¤º
            const saveBtn = document.getElementById('saveProfileBtn');
            const originalText = saveBtn.textContent;
            
            if (saveSuccess) {
                saveBtn.textContent = 'ä¿å­˜æˆåŠŸï¼';
                saveBtn.style.background = 'linear-gradient(145deg, #32cd32, #228b22)';
                showNotification('ä¸ªäººè®¾ç½®å·²ä¿å­˜', 'info');
            } else {
                saveBtn.textContent = 'ä¿å­˜å¤±è´¥ï¼';
                saveBtn.style.background = 'linear-gradient(145deg, #dc143c, #8b0000)';
            }
            
            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = 'linear-gradient(145deg, #32cd32, #228b22)';
            }, 2000);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('showHistoryBtn').addEventListener('click', showHistory);
        document.getElementById('closeHistoryBtn').addEventListener('click', function() {
            document.getElementById('historyModal').style.display = 'none';
        });
        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
        
        document.getElementById('showProfileBtn').addEventListener('click', showProfile);
        
        // å¤´åƒé€‰æ‹©äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
        document.addEventListener('click', function(e) {
            // å¤„ç†å¤´åƒé€‰æ‹©
            if (e.target.classList.contains('avatar-option')) {
                document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                e.target.classList.add('selected');
                playerProfile.avatar = e.target.dataset.avatar;
                document.getElementById('profileAvatar').textContent = e.target.dataset.avatar;
            }
            
            // å¤„ç†ä¸ªäººä¸»é¡µæŒ‰é’®
            if (e.target.id === 'closeProfileBtn') {
                document.getElementById('profileModal').style.display = 'none';
            }
            
            if (e.target.id === 'saveProfileBtn') {
                saveProfile();
            }
        });

        // é‡æ–°å¼€å§‹æŒ‰é’®
        document.getElementById('restartBtn').addEventListener('click', function() {
            document.getElementById('gameOver').style.display = 'none';
            initGame();
        });

        // å›åˆ°ä¸»é¡µæŒ‰é’®
        document.getElementById('backToHomeBtn').addEventListener('click', function() {
            // ç›´æ¥è°ƒç”¨initGameå‡½æ•°æ¥é‡ç½®åˆ°ä¸»é¡µ
            initGame();
        });

        // è®¤è¾“æŒ‰é’®
        document.getElementById('surrenderBtn').addEventListener('click', function() {
            showSurrenderConfirmation();
        });

        // æ˜¾ç¤ºè®¤è¾“ç¡®è®¤å¯¹è¯æ¡†
        function showSurrenderConfirmation() {
            const confirmModal = document.createElement('div');
            confirmModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: smoothFadeIn 0.3s ease-out;
            `;
            
            confirmModal.innerHTML = `
                <div style="
                    background: linear-gradient(145deg, #3a2817, #2c1810);
                    border: 3px solid #d4af37;
                    border-radius: 15px;
                    padding: 30px;
                    text-align: center;
                    max-width: 400px;
                    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
                ">
                    <div style="font-size: 2rem; margin-bottom: 15px;">ğŸ³ï¸</div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">ç¡®è®¤è®¤è¾“</h3>
                    <p style="color: #f4e4bc; margin-bottom: 25px; line-height: 1.5;">
                        ä½ ç¡®å®šè¦è®¤è¾“å—ï¼Ÿ<br>
                        è¿™å°†ç»“æŸå½“å‰æ¸¸æˆå¹¶è®°å½•ä¸ºå¤±è´¥ã€‚
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button id="confirmSurrender" style="
                            background: linear-gradient(145deg, #8b0000, #654321);
                            border: 2px solid #dc143c;
                            color: #f4e4bc;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                        ">ç¡®è®¤è®¤è¾“</button>
                        <button id="cancelSurrender" style="
                            background: linear-gradient(145deg, #8b4513, #654321);
                            border: 2px solid #d4af37;
                            color: #f4e4bc;
                            padding: 10px 20px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            transition: all 0.3s ease;
                        ">ç»§ç»­æ¸¸æˆ</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // ç¡®è®¤è®¤è¾“
            document.getElementById('confirmSurrender').addEventListener('click', function() {
                document.body.removeChild(confirmModal);
                handleSurrender();
            });
            
            // å–æ¶ˆè®¤è¾“
            document.getElementById('cancelSurrender').addEventListener('click', function() {
                document.body.removeChild(confirmModal);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            confirmModal.addEventListener('click', function(e) {
                if (e.target === confirmModal) {
                    document.body.removeChild(confirmModal);
                }
            });
        }

        // å¤„ç†è®¤è¾“
        function handleSurrender() {
            let winner = '';
            let reason = 'ä½ é€‰æ‹©äº†è®¤è¾“';
            
            if (gameState.gameMode === 'ai') {
                winner = 'ä½ è´¥åŒ—äº†ï¼';
                gameState.currentGameRecord.result = 'defeat';
            } else {
                // æœ¬åœ°å¯¹æˆ˜æ¨¡å¼
                if (gameState.currentPlayer === 1 || gameState.playerFaction === 'king') {
                    winner = 'ç©å®¶2èƒœåˆ©ï¼';
                    reason = 'ç©å®¶1è®¤è¾“';
                } else {
                    winner = 'ç©å®¶1èƒœåˆ©ï¼';
                    reason = 'ç©å®¶2è®¤è¾“';
                }
                gameState.currentGameRecord.result = 'completed';
            }
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸç•Œé¢ï¼ˆshowGameOverå‡½æ•°ä¼šå¤„ç†è®°å½•ä¿å­˜ï¼‰
            showGameOver(winner, reason);
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        initGame();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99190266b501ee09',t:'MTc2MDk2ODQ5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
